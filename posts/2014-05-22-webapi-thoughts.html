
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Khaled Hikmat - Web API Thoughts</title>
        <meta name="description" content="Coding Thoughts" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Khaled Hikmat" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Khaled Hikmat" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Khaled Hikmat" />
        <meta name="msapplication-tooltip" content="Khaled Hikmat" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Khaled Hikmat - Web API Thoughts" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://blog.khaledhikmat.com/posts/2014-05-22-webapi-thoughts" />
        <!-- TODO: More social graph meta tags -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Khaled Hikmat</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="/about">About</a></li>
<li><a href="/posts">Archive</a></li>
<li><a href="/tags">Tags</a></li> 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Web API Thoughts</h1>
        <h2 class="subheading">A list of thoughts and recommendations gathered while working on an ASP .NET Web API Project</h2>
    <div class="meta">        
Published on Thursday, May 22, 2014<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/c%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/web-api" class="btn btn-default btn-xs">Web API</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>There are plenty of documentations on how to do constructor injection using Unity in Web API projects.
But there isn't much about setter injection in filters. I had to deal with this last week, provided that you already have Unity installed
via Nuget, here is what you have to do:</p>
<p>In the Register method of the WebAPiConfig.cs, add this line of code:</p>
<pre><code>	// Unity iOC container filter registration (to allow setter injection)
	config.Services.Add(typeof(IFilterProvider), new UnityWebApiFilterProvider(container));
</code></pre>
<p>This tells Web API to add an IFilterProvider service to the pipeline.</p>
<p>The UnityWebApiFilterProvider class is defined like so:</p>
<pre><code>    public class UnityWebApiFilterProvider : IFilterProvider
    {
        private UnityContainer _container;
        public UnityWebApiFilterProvider(UnityContainer container)
        {
            _container = container;
        }

        public IEnumerable&lt;FilterInfo&gt; GetFilters(HttpConfiguration configuration, HttpActionDescriptor actionDescriptor)
        {
            var controllerFilters = actionDescriptor.ControllerDescriptor.GetFilters().Select(instance =&gt; new FilterInfo(instance, FilterScope.Controller));
            var actionFilters = actionDescriptor.GetFilters().Select(instance =&gt; new FilterInfo(instance, FilterScope.Action));

            var filters = controllerFilters.Concat(actionFilters);

            foreach (var filter in filters)
            {
                _container.BuildUp(filter.Instance.GetType(), filter.Instance);
            }

            return filters;
        }
    }
</code></pre>
<h3 id="json-only">JSON Only</h3>
<p>If you only want to support JSON (i.e. no negotiation) and you want the JSON payload to be as expected when
consumed by clients such as JavaScript, you can do this in the WebApiConfig.cs:</p>
<pre><code>	// Remove all formatters and just leave the JSON formatter
	// No negitiation...always return JSON
	GlobalConfiguration.Configuration.Formatters.Clear();
	GlobalConfiguration.Configuration.Formatters.Add(new JsonMediaTypeFormatter()); 

	var jsonFormatter = config.Formatters.OfType&lt;JsonMediaTypeFormatter&gt;().FirstOrDefault();
	jsonFormatter.SerializerSettings.ContractResolver = new CamelCasePropertyNamesContractResolver();
</code></pre>
<p>The CamelCase contract resolver changes your C# models naming convention from Pascal to Camel.</p>
<h3 id="version-support">Version Support</h3>
<p>To support controller versioning, one way to do it would be to intercept the controller selection in the Web API pipeline so we can direct the
selector to different versions based on some header. To do this first step, you can do this in the WebApiConfig.cs:</p>
<pre><code>	// Change the controller and the action selectors to detect 'not found' scenarios
	config.Services.Replace(typeof(IHttpControllerSelector), new VersionAwareControllerSelector(config));
</code></pre>
<p>In the above code, I am changing the controller selector to be version aware. Here is an example of how a Version Aware selector might look like. This works with
attributed routing which is not very well documented. The code below shows the links where I got most of the code from:</p>
<pre><code>    public class VersionAwareControllerSelector : DefaultHttpControllerSelector
	{
        private HttpConfiguration _configuration;

        public VersionAwareControllerSelector(HttpConfiguration configuration)
	        : base(configuration)
	    {
            _configuration = configuration;
	    }

        // This works for Web API 2 and Attributed Routing
        // FROM: http://stackoverflow.com/questions/19835015/versioning-asp-net-web-api-2-with-media-types/19882371#19882371
        // BLOG: http://webstackoflove.com/asp-net-web-api-versioning-with-media-types/
        public override HttpControllerDescriptor SelectController(HttpRequestMessage request)
        {
            HttpControllerDescriptor controllerDescriptor = null;

            // Get a list of all controllers provided by the default selector
            IDictionary&lt;string, HttpControllerDescriptor&gt; controllers = GetControllerMapping();

            IHttpRouteData routeData = request.GetRouteData();

            if (routeData == null)
            {
                throw new HttpResponseException(HttpStatusCode.NotFound);
            }

            // Pick up the API Version
            var apiVersion = GetVersionFromHeader(request);

            // Check if this route is actually an attribute route
            IEnumerable&lt;IHttpRouteData&gt; attributeSubRoutes = routeData.GetSubRoutes();

            if (attributeSubRoutes == null)
            {
                string controllerName = GetRouteVariable&lt;string&gt;(routeData, &quot;controller&quot;);
                if (controllerName == null)
                {
                    throw new HttpResponseException(HttpStatusCode.NotFound);
                }

                string newControllerName = String.Concat(controllerName, apiVersion);

                if (controllers.TryGetValue(newControllerName, out controllerDescriptor))
                {
                    return controllerDescriptor;
                }
                else
                {
                    throw new HttpResponseException(HttpStatusCode.NotFound);
                }
            }
            else
            {
                // So just hand it over to the base implementation
                //return base.SelectController(request);

                // We want to find all controller descriptors whose controller type names end with
                // the following suffix(ex: OutletsSecured)
                string newControllerNameSuffix = String.Concat(&quot;V&quot;, apiVersion); ;

                IEnumerable&lt;IHttpRouteData&gt; filteredSubRoutes = attributeSubRoutes.Where(attrRouteData =&gt;
                {
                    HttpControllerDescriptor currentDescriptor = GetControllerDescriptor(attrRouteData);
                    bool match = currentDescriptor.ControllerName.EndsWith(newControllerNameSuffix);

                    if (match &amp;&amp; (controllerDescriptor == null))
                    {
                        controllerDescriptor = currentDescriptor;
                    }

                    return match;
                });

                routeData.Values[&quot;MS_SubRoutes&quot;] = filteredSubRoutes.ToArray();
            }

            return controllerDescriptor;
        }

        private HttpControllerDescriptor GetControllerDescriptor(IHttpRouteData routeData)
        {
            return ((HttpActionDescriptor[])routeData.Route.DataTokens[&quot;actions&quot;]).First().ControllerDescriptor;
        }

        // Get a value from the route data, if present.
        private static T GetRouteVariable&lt;T&gt;(IHttpRouteData routeData, string name)
        {
            object result = null;
            if (routeData.Values.TryGetValue(name, out result))
            {
                return (T)result;
            }
            return default(T);
        }
        
        private string GetVersionFromMediaType(HttpRequestMessage request)
        {
            var accept = request.Headers.Accept;
            var ex = new Regex(&#64;&quot;application\/vnd\.TableConcierge\.([a-z]+)\.v([0-9]+)\+json&quot;, RegexOptions.IgnoreCase);

            foreach (var mime in accept)
            {
                var match = ex.Match(mime.MediaType);
                if (match != null)
                {
                    return match.Groups[2].Value;
                }
            }

            return &quot;1&quot;;
        }

        private string GetVersionFromAcceptHeaderVersion(HttpRequestMessage request)
        {
            var accept = request.Headers.Accept;

            foreach (var mime in accept)
            {
                if (mime.MediaType == &quot;application/json&quot;)
                {
                    var value = mime.Parameters
                                    .Where(v =&gt; v.Name.Equals(&quot;version&quot;, StringComparison.OrdinalIgnoreCase))
                                    .FirstOrDefault();

                    return value.Value;
                }
            }

            return &quot;1&quot;;
        }

        private string GetVersionFromHeader(HttpRequestMessage request)
        {
            const string HEADER_NAME = &quot;X-TC-VERSION&quot;;

            if (request.Headers.Contains(HEADER_NAME))
            {
                var header = request.Headers.GetValues(HEADER_NAME).FirstOrDefault();
                if (header != null)
                {
                    return header;
                }
            }

            return &quot;1&quot;;
        }

        private string GetVersionFromQueryString(HttpRequestMessage request)
        {
            var query = HttpUtility.ParseQueryString(request.RequestUri.Query);

            var version = query[&quot;v&quot;];
            if (version != null)
            {
                return version;
            }

            return &quot;1&quot;;
        }
    }
</code></pre>



                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                <ul class="list-inline text-center">
                        <li>
                        <a href="https://twitter.com/khaledhmat">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://github.com/khaledhikmat">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                </ul>
                <p class="copyright text-muted">
                        Copyright © 2016 by Khaled Hikmat. 
                        <br />
                        <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                </p>
                </div>
        </div>
</div>
                </footer> 

                <script type="text/javascript">
</script>
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>
        </body>
</html>

