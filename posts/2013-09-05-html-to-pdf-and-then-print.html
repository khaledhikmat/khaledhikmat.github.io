
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Khaled Hikmat - HTML to PDF and then Print</title>
        <meta name="description" content="Coding Thoughts" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Khaled Hikmat" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Khaled Hikmat" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Khaled Hikmat" />
        <meta name="msapplication-tooltip" content="Khaled Hikmat" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Khaled Hikmat - HTML to PDF and then Print" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://khaledhikmat.github.io/posts/2013-09-05-html-to-pdf-and-then-print" />
        <!-- TODO: More social graph meta tags -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Khaled Hikmat</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="/about">About</a></li>
<li><a href="/posts">Archive</a></li>
<li><a href="/tags">Tags</a></li> 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>HTML to PDF and then Print</h1>
        <h2 class="subheading">A Procesing a print job from the server</h2>
    <div class="meta">        
Published on Thursday, September 5, 2013<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/net" class="btn btn-default btn-xs">.NET</a>
                    <a role="button" href="/tags/pdf" class="btn btn-default btn-xs">PDF</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>In one component of a major project I am working on, it is required that we process a print job from a server. The .NET client component (i.e Windows Service) which receives the print jobs must convert the print job's HTML markup to PDF and print on one attached printers identified by name (in the print job).</p>
<p>Initially I thought, since we are on .NET, there must be zillions of free libraries to deal with this. It turned out this is not the case. I will explain the challenges that I ran into and then go on to describe one solution that worked well for me.</p>
<h3 id="the-challenges">The challenges:</h3>
<ul>
<li>Convert the HTML to PDF</li>
<li>Print to a non-default printer</li>
</ul>
<p>The problem with the first one is that HTML cannot be easily parsed as XHTML! Therefore it is difficult to build the PDF on the fly (there are many libraries that can do this part). I found PDFizer that deals with this problem specifically but it has not been updated since 2004 and it lacks support for a lot of HTML tags which we are likely to receive in the job's HTML markup. Hence it not suitable for the job at hand.</p>
<p>The problem with the second challenge is that it is difficult to print to a non-default printer. The code below shows how to setup a print process but it expects the printer to be the default:</p>
<pre><code>ProcessStartInfo info = new ProcessStartInfo();
info.Verb = &quot;print&quot;;
info.FileName = pdfFilePath;//&#64;&quot;c:\output.pdf&quot;;
info.CreateNoWindow = true;
info.WindowStyle = ProcessWindowStyle.Hidden;

Process p = new Process();
p.StartInfo = info;
p.Start();

p.WaitForInputIdle();
System.Threading.Thread.Sleep(3000);
if (false == p.CloseMainWindow())
    p.Kill();
</code></pre>
<p>So one solution would be to set the default printer ahead of issuing the above command. To set the default printer, one has to resort to the Windows API. The following is one way of doing it. First you declare the Windows API that you are about to call (specifying the actual Windows DLL in the DllImport):</p>
<pre><code>[DllImport(&quot;winspool.drv&quot;, CharSet = CharSet.Auto, SetLastError = true)]
public static extern bool SetDefaultPrinter(string name);
//public static extern string GetDefaultPrinter();
</code></pre>
<p>and then you call it this way:</p>
<pre><code>if (MyPrinters.SetDefaultPrinter(printer))
{
// do the above
}
</code></pre>
<p>Ok...then...I wanted to be get the default printer, store it somewhere safe, set my print job's printer to be the default, print and then restore my original printer as default!! But I could not find out how to get the default printer...the Windows API does not have a 'GetDefaultPrinter'.</p>
<h3 id="the-solution">The solution:</h3>
<p>After searching on the Internet and trying numerous solutions, I found the only way to actually produce a faithful PDF from HTML in a very reasonable time is via EssentialObjects EO.PDF library for .NET! It is only a one line to convert the HTML markup to PDF and it is indeed great:</p>
<pre><code>EO.Pdf.HtmlToPdf.ConvertHtml(html, pdfFilePath);
</code></pre>
<p>This solves my HTML to PDF conversion! One thing to note about Essential Objects is that the library is not free nor is it cheap! It costs about $650 per developer license. This could be a show stopper for many, but it is worth the price is you really have to convert HTML to PDF.</p>
<p>To solve my printing problem, I had to use the PDFSharp library and Adobe Acrobat Reader.</p>
<p>Once I had the DLL for PDF Sharp in my project and the Acrobat Reader installed on my machine, the code to print becomes trivial:</p>
<pre><code>// Set the Acrobat Reader exe path:
PdfFilePrinter.AdobeReaderPath = acrobatReaderPath;

// Set the file to print and the Windows name of the printer.
PdfFilePrinter pdfPrinter = new PdfFilePrinter(pdfFilePath, printer);

pdfPrinter.Print();
</code></pre>
<p>One thing to note, the Acrobat Reader path must point to EXE (not the directory). In my machine, it is here:
C:\Program Files (x86)\Adobe\Reader 11.0\Reader\AcroRd32.exe</p>
<p>There you have it.... an HTML to PDF and then to the printer. I actually used the following interface to describe the print driver:</p>
<pre><code>public interface IPrintDriver
{
    void Print(string acrobatReaderExePath, string html, string printer);
    void Convert2Pdf(string pdfFilePath, string html);
    void PrintPdf(string acrobatReaderPath, string pdfFilePath, string printer);
    string GetPdfFilePath();
}
</code></pre>



                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                <ul class="list-inline text-center">
                        <li>
                        <a href="https://twitter.com/khaledhmat">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://github.com/khaledhikmat">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                </ul>
                <p class="copyright text-muted">
                        Copyright © 2016 by Khaled Hikmat. 
                        <br />
                        <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                </p>
                </div>
        </div>
</div>
                </footer> 

                <script type="text/javascript">
</script>
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>
        </body>
</html>

