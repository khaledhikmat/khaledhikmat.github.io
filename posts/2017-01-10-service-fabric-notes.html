
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Khaled Hikmat - Service Fabric Notes</title>
        <meta name="description" content="Coding Thoughts" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Khaled Hikmat" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Khaled Hikmat" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Khaled Hikmat" />
        <meta name="msapplication-tooltip" content="Khaled Hikmat" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Khaled Hikmat - Service Fabric Notes" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://khaledhikmat.github.io/posts/2017-01-10-service-fabric-notes" />
        <!-- TODO: More social graph meta tags -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
                <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Khaled Hikmat</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="/about">About</a></li>
<li><a href="/posts">Archive</a></li>
<li><a href="/tags">Tags</a></li> 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Service Fabric Notes</h1>
        <h2 class="subheading">Some Service Fabric Implementation Notes</h2>
    <div class="meta">        
Published on Tuesday, January 10, 2017<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/notes" class="btn btn-default btn-xs">Notes</a>
                    <a role="button" href="/tags/service-fabric" class="btn btn-default btn-xs">Service Fabric</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>I am compiling notes when working with <a href="https://azure.microsoft.com/en-us/services/service-fabric/">Service Fabric</a> from the folks at Microsoft! In this post, I will enumerate a few things that I ran into which I think might be helpful to others who are learning the environment as well. This will not be a complete list ....so I will add to it as I go along.</p>
<h3 id="actor-turn-based-concurrency">Actor Turn-based Concurrency</h3>
<p>Actors are single threaded! They only allow one thread to be acting on them at any given time. In fact, in the Service Fabric terminology, this is referred to as Turn-based treading. From my observation, it seems that this is how the platform and the actors</p>
<p>What happens to the clients who are calling the actors? If two clients are trying to access an actor at the same time, one blocks until the actor finishes the first client method. This is to ensure that an actor works on one thing at a time.</p>
<p>Let us say, we have an actor that has two methods like this:</p>
<pre><code class="language-csharp">public Task&lt;string&gt; GetThing1()
{
    // Simulate long work
    Thread.Sleep(5000);
    return Task.FromResult&lt;string&gt;(&quot;thing1&quot;);
}

public Task&lt;string&gt; GetThing2()
{
    // Simulate long work
    Thread.Sleep(10000);
    return Task.FromResult&lt;string&gt;(&quot;thing2&quot;);
}
</code></pre>
<p>If you call <code>GetThing1</code> from one client and immediately call <code>GetThing2</code> from another client (or Postman session), the second client will wait at least 15 seconds to get the string <code>thing2</code> response.</p>
<p>Given this:</p>
<ul>
<li>I think it is best to front-end actors with a service that can invoke methods on actors when it receives requests from a queue. This way the service is waiting on actors to complete processing while it is in its <code>RunAsync</code> method.</li>
<li>It is important to realize that actors should really not be queried and that actors should employ several things:
<ul>
<li>Backup state to an external store such as DocumentDB or others. This way the external store can be queried instead.</li>
<li>Aggregate result externally perhaps via Azure Function into some outside store so queries could run against this store</li>
<li>Aggregate result to an aggregator actor that can quickly respond to queries which will relieve the processing actors from worrying about query requests.</li>
</ul>
</li>
</ul>
<h3 id="actor-reminders">Actor Reminders</h3>
<p><a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-actors-timers-reminders/">Actor Reminders</a> are really nice to have. In the sample app that I am working on, I use them to schedule processing after I return to the caller. Effectively they seem to give me the ability to run things asynchronously and return to the caller right away. Without this, the actor processing throughput may not be at best if the the processing takes a while to complete.</p>
<p>In addition to firing a future event, they do allow me to pack an item or object that can be retrieved when the reminder triggers. This makes a lot of scenarios possible because we are able to pack the item that we want the reminder to work on.</p>
<p><em>Please note, however, that when a reminder is running in an actor, that actor cannot respond to other method invocation! This is because the platform makes sure that there is only a single threaded operating on an actor at any time.</em></p>
<p>The best way I found out to schedule reminders to fire immediately is something like this:</p>
<pre><code class="language-csharp">public async Task Process(SomeItem item)
{
	var error = &quot;&quot;;

	try
	{
		if (item == null)
		{
			...removed for brevity
			return;
		}

		await this.RegisterReminderAsync(
			ReprocessReminder,
			ObjectToByteArray(item),
			TimeSpan.FromSeconds(0),            // If 0, remind immediately
			TimeSpan.FromMilliseconds(-1));     // Disable periodic firing
	}
	catch (Exception ex)
	{
		error = ex.Message;
	}
	finally
	{
		...removed for brevity
	}
}
</code></pre>
<p>When the reminder triggers, <code>ReprocessReminder</code> is called to process the item that was packed within the reminder: <code>ObjectToByteArray(item)</code>. Here are possible implementation of packing and unpacking the item:</p>
<pre><code class="language-csharp">private byte[] ObjectToByteArray(Object obj)
{
    if (obj == null)
        return null;

    BinaryFormatter bf = new BinaryFormatter();

    try
    {
        using (var ms = new MemoryStream())
        {
            bf.Serialize(ms, obj);
            return ms.ToArray();
        }

    }
    catch (Exception ex)
    {
        return null;
    }
}

private Object ByteArrayToObject(byte[] arrBytes)
{
    try
    {
        using (var memStream = new MemoryStream())
        {
            var binForm = new BinaryFormatter();
            memStream.Write(arrBytes, 0, arrBytes.Length);
            memStream.Seek(0, SeekOrigin.Begin);
            var obj = binForm.Deserialize(memStream);
            return obj;
        }
    }
    catch (Exception ex)
    {
        return null;
    }
}
</code></pre>
<h3 id="actor-interface">Actor Interface</h3>
<p>From this <a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-actors-notes-on-actor-type-serialization/">article</a>: <em>The arguments of all methods, result types of the tasks returned by each method in an actor interface, and objects stored in an actor's State Manager must be Data Contract serializable. This also applies to the arguments of the methods defined in actor event interfaces. (Actor event interface methods always return void.)</em></p>
<p>In my actor interface, I had many methods and everything was working great until I added these two methods:</p>
<pre><code class="language-csharp">Task&lt;SomeView&gt; GetView(int year, int month);
Task&lt;SomeView&gt; GetView(int year);
</code></pre>
<p>If you to compile a Service Fabric solution that has an interface that looks like the above, you will be met with a very strange compilation error:</p>
<p><img src="http://i.imgur.com/cO972hG.png" class="img-fluid" alt="Actor Compilation Error" /></p>
<p>What? What is that? Why? After hours, it turned out you can actually <a href="http://stackoverflow.com/questions/35820191/how-to-ignore-a-servicetype-from-servicefabric-manifest-file-on-build-deploy">turn off</a> this error. From the above Stack Overflow post:</p>
<p>By changing the project file .csproj of the project containing the actors and setting property:</p>
<pre><code>&lt;UpdateServiceFabricManifestEnabled&gt;false&lt;/UpdateServiceFabricManifestEnabled&gt;
</code></pre>
<p>So this tool can be disabled!! But still why is this happening? It turned out that the actor interfaces may not have overridden methods!! So the tool was complaining about the interface containing just that i.e. overridden methods. If the above interface is changed to the below, everything will work well:</p>
<pre><code class="language-csharp">Task&lt;SomeView&gt; GetViewByYearNMonth(int year, int month);
Task&lt;SomeView&gt; GetViewByYear(int year);
</code></pre>
<p>In addition, the actor event methods may not return anything but <code>void</code>. So if you have something like this, you will get the same <code>FabActUtil.exe</code> error:</p>
<pre><code class="language-csharp">public interface IMyActorEvents : IActorEvents
{
	Task MeasuresRecalculated(....);
}
</code></pre>
<p>I am hoping to add to this post as I go along. Hopefully this has been helpful.</p>



                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                <ul class="list-inline text-center">
                        <li>
                        <a href="https://twitter.com/khaledhmat">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://github.com/khaledhikmat">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                </ul>
                <p class="copyright text-muted">
                        Copyright © 2017 by Khaled Hikmat. 
                        <br />
                        <strong><a href="http://wyam.io">Generated by Wyam</a></strong>
                </p>
                </div>
        </div>
</div>
                </footer> 

                <script type="text/javascript">
</script>
                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>
        </body>
</html>

