<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;docker&quot; | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;docker&quot; | Coding Thoughts"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;docker&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;docker&quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/6875c492.dfa2ff96.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/bee94a88.4fc3e9d9.js" as="script">
<link rel="preload" href="/8593ff01.743deab4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><h1>1 post tagged with &quot;docker&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></h2><div class="margin-vert--md"><time datetime="2018-01-04T00:00:00.000Z" class="blogPostDate_Ta7i">January 4, 2018  Â· 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I wanted to assess Azure Cosmos DB to see possibilities of converting some of our backend applications to use this database technology to provide a globally distributed database that we desperately need as our services now cover a bigger geographic location. However, this post is not about Cosmos DB specifically! It is mainly about notes about the architecture of the pieces that surround Cosmos and how I am thinking to implement them.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="macro-architecture"></a>Macro Architecture<a class="hash-link" href="#macro-architecture" title="Direct link to heading">#</a></h2><p>This is how I imagines our system to look like:</p><p><img alt="Avalon Macro Architecture" src="/assets/images/avalon-architecture-4ebd1ec1a7a88f773c346fb24690235d.png"></p><p>In this post, I would like to concentrate only on the components that are boxed in orange. Namely, the Web API layer and the two processors.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-app-service-docker--kubernetes"></a>Azure App Service, Docker &amp; Kubernetes<a class="hash-link" href="#azure-app-service-docker--kubernetes" title="Direct link to heading">#</a></h2><p>We have been using Azure App Service for a while and we are happy with it. We have experience in managing it, scaling it and configuring it. I did not want to change that. So I decided to continue to use Azure App Service to host our Web API layer which will be written in .NET Core. This layer communicates with Cosmos DB to provide a multi-regional access to our customers. </p><p>I wanted to monitor Cosmos DB changes to launch different Microservices in the form of Azure Functions, Logic Apps or other processes. I could use Azure Functions to track the Cosmos DB changes but I decided to write my own little .NET Core stand-alone Console app using the Microsoft Change Feed library which makes things quite easy.</p><p>Normally, I use WebJobs to handle queue processing and I do have a lot of experience with this. However, in .NET Core, the deployment of a WebJob is not very clear to me so I decided to write a stand-alone console app based on WebJobs SDK but can be deployed somewhere else.</p><p>To host and deploy the two stand-alone .NET core console apps i.e. Change Feeder and Queue Processor, opted to make them Docker images and deploy them to a Kubernetes cluster.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="containerizing-the-webjobs-console-app"></a>Containerizing the WebJobs Console App<a class="hash-link" href="#containerizing-the-webjobs-console-app" title="Direct link to heading">#</a></h2><p>I based my code on this <a href="http://matt-roberts.me/azure-webjobs-in-net-core-2-with-di-and-configuration/" target="_blank" rel="noopener noreferrer">blog post by Matt Roberts</a>. My solution has several projects...but two are important for this step: <code>AvalonWebJobs</code> and <code>AvalonWebDal</code>. <code>AvalonWebDal</code> is a class library that has common functionality that I depend on. I used the following Docker file to build the WebJobs console app:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-sdk as build</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY . .</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonWebDal</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonWebJobs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet publish --output /output --configuration Release</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-runtime</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY --from=build /output /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENTRYPOINT [ &quot;dotnet&quot;, &quot;AvalonWebJobs.dll&quot; ]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I used the following Docker command to build the image:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker build --file docketfile.webjobs --no-cache -t avalonwebjobs .</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following to test locally:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker run --rm -ti avalonwebjobs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="containerizing-the-change-feeder-app"></a>Containerizing the Change Feeder App<a class="hash-link" href="#containerizing-the-change-feeder-app" title="Direct link to heading">#</a></h2><p>I based my code on this <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/change-feed#change-feed-processor" target="_blank" rel="noopener noreferrer">documentation post by Microsoft</a>. My solution has several projects...but two are important for this step: <code>AvalonChangeFeeder</code> and <code>AvalonWebDal</code>. <code>AvalonWebDal</code> is a class library that has common functionality that I depend on. I used the following Docker file to build the WebJobs console app:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-sdk as build</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY . .</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonWebDal</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonChangeFeeder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet publish --output /output --configuration Release</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-runtime</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY --from=build /output /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENTRYPOINT [ &quot;dotnet&quot;, &quot;AvalonChangeFeeder.dll&quot; ]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I used the following Docker command to build the image:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker build --file docketfile.changefeeder --no-cache -t avalonchangefeeder .</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following to test locally:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker run --rm -ti avalonchangefeeder</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Important note:</strong></p><p>Make sure that the <code>.csproj</code> project file contains the following item groups so that the appsettings will be available in the container. Failure to do so will cause an error message <code>unable to find appsettngs.json and it is not optional</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ItemGroup&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;None Remove=&quot;appsettings.json&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/ItemGroup&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;ItemGroup&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Content Include=&quot;appsettings.json&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &lt;CopyToPublishDirectory&gt;PreserveNewest&lt;/CopyToPublishDirectory&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;/Content&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/ItemGroup&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kubernetes"></a>Kubernetes<a class="hash-link" href="#kubernetes" title="Direct link to heading">#</a></h2><p>I used <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough" target="_blank" rel="noopener noreferrer">this documentation link</a> to spawn a test 1-node k8s cluster in Azure. The process is really simple and quick. I tagged and published my two container images to an Azure Container Registry using <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-azure-cli" target="_blank" rel="noopener noreferrer">this documentaion link</a>.</p><p>Now time to actually deploy to the k8s cluster. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployments"></a>Deployments<a class="hash-link" href="#deployments" title="Direct link to heading">#</a></h3><p>Becasue I wanted to scale the two web jobs and the change feeder separately, I opted to create two deployments: one for the web jobs and another for the change feeder. Alternatively, I could have used a two-pod deployment but this will have meant that my two containers will need to be scaled the same since the unit of scaling in k8s is the deployment ...not the pod. Please refer to <a href="https://stackoverflow.com/questions/43217006/kubernetes-multi-pod-deployment" target="_blank" rel="noopener noreferrer">this stack overflow issue</a> for more information.</p><p>I used the following <code>.yml</code> file for the WebJobs k8s deployment:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: extensions/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: avalon-webjobs-deploy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  replicas: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  minReadySeconds: 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  strategy:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type: RollingUpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rollingUpdate:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxUnavailable: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxSurge: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  template:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app: avalon-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - name: avalon-webjobs-pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        image: avalonacr.azurecr.io/avalonwebjobs:v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        imagePullPolicy: Always</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following <code>kubectl</code> command to deploy:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create -f avalon-webjobs-app.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I used the following <code>.yml</code> file for the Change feeder k8s deployment:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: extensions/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: avalon-changefeeder-deploy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  replicas: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  minReadySeconds: 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  strategy:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type: RollingUpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rollingUpdate:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxUnavailable: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxSurge: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  template:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app: avalon-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - name: avalon-changefeeder-pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        image: avalonacr.azurecr.io/avalonchangefeeder:v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        imagePullPolicy: Always</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following <code>kubectl</code> command to deploy:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create -f avalon-changefeeder-app.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="observations"></a>Observations<a class="hash-link" href="#observations" title="Direct link to heading">#</a></h3><p>Initialy I set the number of replicas to one so I can make sure that everything is running well before I scale the k8s deployments.</p><p>After the deployment as above, I used <code>kubectl get pods</code> to see the status of the nodes. I noticed that the webjobs pod is in <code>running</code> state (which is desired) while the change feeder container is in <code>CrashLoopBackOff</code> state. Humm....after some reasearch, I found <a href="https://stackoverflow.com/questions/41604499/my-kubernetes-pods-keep-crashing-with-crashloopbackoff-but-i-cant-find-any-lo" target="_blank" rel="noopener noreferrer">this helpful stack overflow issue</a>. So I used the following command to see the actual console logs:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl logs avalon-changefeeder-deploy-1476356743-35g55  -c avalon-changefeeder-pod</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>After fiddling with it for a while, I discovered the problem has to do with how the change feeder console app was coded. It uses a typical <code>Console.ReadKey</code> method to make the application run until a key is pressed. So I modified my code based on <a href="https://carlos.mendible.com/2017/10/15/prepare-a-net-core-console-app-for-docker/" target="_blank" rel="noopener noreferrer">this useful code snippet</a>, rebuild my container and re-deployed and yes....the change feeder pod is in <code>running</code> state.</p><p>It took me a while to get the above to work. This is because I was updating the image in the container registry without changing the tag. This did not force a re-pull and I ended up not using the latest image that I was deploying to the container. It seems that k8s caches the images unless you add to the deployment file a <code>imagePullPolicy: Always</code> in the container spec. Doing so forces k8s to re-pull the image. The other option is to change the image tag.</p><p>Now things look better ...but there is another problem. Upon termination, the change feeder container needs to de-register and clean up some resources. Unfortunately I noticed when I issue a <code>docker stop &lt;id&gt;</code>, the process is abruplty terminated and there is no change for the change feeder thread to clean up. I found a good article that describes how to <a href="https://www.ctl.io/developers/blog/post/gracefully-stopping-docker-containers/" target="_blank" rel="noopener noreferrer">gracefully stop Docker containers</a> which goes into some detail to describe the best way to handle it. However, since I am using a .NET Core app, I really did not find an easy way to handle the two Linux signales: <code>SIGINT</code> and <code>SIGTERM</code>. I did find a lot of discussions about it <a href="https://github.com/aspnet/Hosting/issues/870" target="_blank" rel="noopener noreferrer">here</a>. As it stands now, if I run the container in an intercative mode using <code>docker run --rm -ti avalonchangefeeder</code>, for example, and then perform control-c or control-break, the container shuts down gracefully. However, if I issue a <code>docker stop</code>, the container abruplty exists without giving any chance for the change feeder to do any cleanup :-(</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="application-insights"></a>Application Insights<a class="hash-link" href="#application-insights" title="Direct link to heading">#</a></h2><p>I used <code>Application Insights</code> to trace and track what is happening inside the container. This provide a really powerful way to monitor what is happening inside the container. I noticed that the Application Insights has a Kubernetes extension....but I am not using it yet.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="scaling"></a>Scaling<a class="hash-link" href="#scaling" title="Direct link to heading">#</a></h2><p>Now that everything is in Kubernetes, we can scale the deployments up and down as we need. Scaling the web jobs deployment up to multiple replicas provide several consumers of the queue and scaling the change feeder deployment up to multiple replicas automatically adjusts the divide the work among themselves. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/net-core">.NET Core</a><a class="margin-horiz--sm" href="/blog/tags/docker">Docker</a><a class="margin-horiz--sm" href="/blog/tags/kubernetes">Kubernetes</a></div><div class="col text--right"><a aria-label="Read more about .NET Core, Docker and Kubernetes" href="/blog/2018/01/04/netapp-docker-k8s"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/6875c492.dfa2ff96.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/bee94a88.4fc3e9d9.js"></script>
<script src="/8593ff01.743deab4.js"></script>
</body>
</html>