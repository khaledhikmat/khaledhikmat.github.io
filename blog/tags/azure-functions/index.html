<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;azure functions&quot; | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;azure functions&quot; | Coding Thoughts"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;azure functions&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;azure functions&quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/6875c492.dfa2ff96.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/5aee77e7.26a47450.js" as="script">
<link rel="preload" href="/0f32c5fb.b89090b2.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><h1>1 post tagged with &quot;azure functions&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></h2><div class="margin-vert--md"><time datetime="2017-12-27T00:00:00.000Z" class="blogPostDate_Ta7i">December 27, 2017  Â· 14 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I started with this <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable-functions-install" target="_blank" rel="noopener noreferrer">documentation page</a> to learn about Azure durable Functions. I wanted to know if I can build a way to implement actors in Azure Functions. Actors Programming Model is pretty interesting and I did some work on it before.</p><p>Following the Azure Functions sample instructions mentioned in the above link, I quickly got up and running. However, I wanted to answer the following questions about actors in Azure Functions:</p><ul><li>Create a new actor giving a provided actor id</li><li>Signal an existing actor to perform something</li><li>When do actors get created?</li><li>When do actors get terminated?</li><li>Can we read the actor&#x27;s internal state?</li><li>What about .NET Core and .NET Standard 2.0 and other stuff?</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="create-a-new-actor"></a>Create a new actor:<a class="hash-link" href="#create-a-new-actor" title="Direct link to heading">#</a></h2><p>I created an HTTP trigger that looks like this where I provide a code that can be used as an instance id for the singleton i.e. membership actor. If the membership actor status is null or not running, then I start it with a <code>StartNewAsync</code>: </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpRefreshMemberships&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;post&quot;, Route = &quot;memberships/refresh/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var membershipStatus = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string runningStatus = membershipStatus == null ? &quot;NULL&quot; : membershipStatus.RuntimeStatus.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Instance running status: &#x27;{runningStatus}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus == null || </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus.RuntimeStatus != OrchestrationRuntimeStatus.Running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Code = code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.StartNewAsync(&quot;E3_Membership&quot;, code, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Started a new membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Refreshed an existing membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var res = starter.CreateCheckStatusResponse(req, code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    res.Headers.RetryAfter = new RetryConditionHeaderValue(TimeSpan.FromSeconds(10));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="signal-an-existing-actor-to-perform-something"></a>Signal an existing actor to perform something<a class="hash-link" href="#signal-an-existing-actor-to-perform-something" title="Direct link to heading">#</a></h2><p>If the membership actor does exist, we raise a <code>refresh</code> event to wake up the singleton so it can do work:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The actual membership actor code looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static class Membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [FunctionName(&quot;E3_Membership&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [OrchestrationTrigger] DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (membership == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;Something is bad! I should start with a valid membership.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var operation = await context.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;***** received &#x27;{operation}&#x27; event.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        operation = operation?.ToLowerInvariant();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation == &quot;refresh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            membership = await Refresh(context, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation != &quot;end&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.ContinueAsNew(membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Refresh(DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                              TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Do something to refresh the membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Code = context.InstanceId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateTime now = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string formatDate = now.ToString(&quot;MM/dd/yyyy hh:mm:ss.fff tt&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;**** done refreshing &#x27;{context.InstanceId}&#x27; @ {formatDate}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="multiple-signals"></a>Multiple signals<a class="hash-link" href="#multiple-signals" title="Direct link to heading">#</a></h3><p>But what happens if the actor is signaled frantically via raising an external event from an HTTP trigger, for example? The event signals are actually enqueued to the instance so they should run as many  times as they are sginaled. </p><p>If you are observing the actor&#x27;s streaming logs when you try this, it could get very confusing. This is because durable functions manage long-term running processes in short-lived functions is by taking advantage of state retrieved in the <code>context</code> and replaying the function to resume at the next step (from <a href="https://hackernoon.com/serverless-and-bitcoin-creating-price-watchers-dynamically-beea36ef194e" target="_blank" rel="noopener noreferrer">this article</a>). Effectively what you will see if that functions are started, completed and re-started again to resume state.     </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="code-delays"></a>Code Delays<a class="hash-link" href="#code-delays" title="Direct link to heading">#</a></h3><p>Singletons should not use <code>Task</code> functions such as <code>Task.Delay(millis)</code> to simulate code delays. This will cause run-time errors:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function &#x27;E3_Membership (Orchestrator)&#x27;, version &#x27;&#x27; failed with an error. Reason: System.InvalidOperationException: Multithreaded execution was detected. his can happen if the orchestrator function previously resumed from an unsupported async callback.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The preferred way for delays or timeouts is:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">await context.CreateTimer(deadline, CancellationToken.None);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where <code>deadline</code> is defined:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DateTime deadline = context.CurrentUtcDateTime.AddMinutes(30);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>It is very important that we leverage the <code>context</code> to provide accurate timer information as opposed to <code>TimeSpan</code> and <code>DateTime.Now</code>, etc. I have seen very varying (not correct) results when I used <code>TimeSpan.FromMinutes(30)</code>, for example. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="wait-on-multiple-events"></a>Wait on multiple events<a class="hash-link" href="#wait-on-multiple-events" title="Direct link to heading">#</a></h3><p>What if we want the actor to wait on an external event or on a internal timeout event to perhaps refresh our membership periodically? I created another membership function i.e. <code>E3_MembershipWithTimer</code> that awaits on either an operation event or a timeout event:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;E3_MembershipWithTimer&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;dynamic&gt; RunWithTimer(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationTrigger] DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;E3_MembershipWithTimer starting.....&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (membership == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Something is bad! I should start with a valid membership.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string operation = &quot;refresh&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using (var cts = new CancellationTokenSource())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var operationTask = context.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateTime deadline = context.CurrentUtcDateTime.AddMinutes(30);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var timeoutTask = context.CreateTimer(deadline, cts.Token);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task winner = await Task.WhenAny(operationTask, timeoutTask);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (winner == operationTask)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;An operation event received!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            operation = operationTask.Result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            cts.Cancel();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Default the timeout task to mean a &#x27;refresh&#x27; operation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;A timeout event received!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            operation = &quot;refresh&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;***** received &#x27;{operation}&#x27; event.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    operation = operation?.ToLowerInvariant();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (operation == &quot;refresh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membership = await Refresh(context, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (operation != &quot;end&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        context.ContinueAsNew(membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="when-do-actors-get-created"></a>When do actors get created?<a class="hash-link" href="#when-do-actors-get-created" title="Direct link to heading">#</a></h2><p>Actors or singletons actually do persist in storage (please see the section about termination)......this is how an Azure Functions knows how to start them when it restarts. So if you create actors with specific instance ids (or actor ids), shut down the functions and restart it, the singleton instances are available. When you want to trigger an instance, you must check its running state and then invoke the proper API:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var membershipStatus = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string runningStatus = membershipStatus == null ? &quot;NULL&quot; : membershipStatus.RuntimeStatus.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">log.Info($&quot;Instance running status: &#x27;{runningStatus}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    membershipStatus == null || </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    membershipStatus.RuntimeStatus != OrchestrationRuntimeStatus.Running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Code = code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await starter.StartNewAsync(&quot;E3_Membership&quot;, code, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Started a new membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Refreshed an existing membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="when-do-actors-get-terminated"></a>When do actors get terminated?<a class="hash-link" href="#when-do-actors-get-terminated" title="Direct link to heading">#</a></h2><p>They can be easily terminated using the <code>TerminateAsync</code> API. So I created a little HTTP trugger that would terminate instances:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpTerminateMemberships&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;post&quot;, Route = &quot;memberships/terminate/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.TerminateAsync(code, &quot;&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.OK);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.BadRequest, ex.Message);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The Azure Durable Functions maintain a state of all running instances in a task hub which is basically a storage resource with control queues, qork-item queues, a history table and lease blobs. You can read more about this <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable-functions-task-hubs" target="_blank" rel="noopener noreferrer">here</a>. </p><p>Effectively, the <code>host.json</code> <code>durableTask</code> indicate the hub name:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;durableTask&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;HubName&quot;: &quot;TestDurableFunctionsHub&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The run-time environment stores related information about running instances in storage keyed by the hub name.  </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-actor-state"></a>The actor state<a class="hash-link" href="#the-actor-state" title="Direct link to heading">#</a></h2><p>Each actor has an internal state! It is initially read by the singleton as an input:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and it is updated using:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">context.ContinueAsNew(membership);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>But it seems that the internal state is actually not persisted anywhere ...it is transient. When actors are initially created, a state is passed as an input i.e. <code>context.GetInput&lt;dynamic&gt;()</code> and the actor updates it with a call to <code>ContinueAsNew</code> which actually restarts itself with a new state. </p><p>The internal state can be read by using one of the APIs of the instance management:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var status = await client.GetStatusAsync(instanceId);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where <code>client</code> is <code>DurableOrchestrationClient</code>. The status input is the actor&#x27;s internal state:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Name&quot;: &quot;E3_MembershipWithTimer&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;InstanceId&quot;: &quot;U7CCR&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;CreatedTime&quot;: &quot;2017-12-29T21:12:24.8229285Z&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;LastUpdatedTime&quot;: &quot;2017-12-29T21:12:25.5309613Z&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Input&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;$type&quot;: &quot;&lt;&gt;f__AnonymousType0`3[[System.String, mscorlib],[System.String, mscorlib],[System.String, mscorlib]], VSSample&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Id&quot;: &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Code&quot;: &quot;U7CCR&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;CardNumber&quot;: &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Output&quot;: null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;RuntimeStatus&quot;: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I am not sure if the actor internal state is meant to hold big state though. Perhaps it is better if the actor exposes its state externally so HTTP triggers, for example, can read it directly from the external store. </p><p>One way of doing this is to modify the code to look something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpRefreshMemberships&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;post&quot;, Route = &quot;memberships/refresh/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var membershipStatus = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string runningStatus = membershipStatus == null ? &quot;NULL&quot; : membershipStatus.RuntimeStatus.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Instance running status: &#x27;{runningStatus}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus == null || </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus.RuntimeStatus != OrchestrationRuntimeStatus.Running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Given the membership code, read from an external source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var membership = await RetriveFromCosmosDB(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.StartNewAsync(&quot;E3_Membership&quot;, code, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Started a new membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Refreshed an existing membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var res = starter.CreateCheckStatusResponse(req, code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    res.Headers.RetryAfter = new RetryConditionHeaderValue(TimeSpan.FromSeconds(10));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the membership actor:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static class Membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [FunctionName(&quot;E3_Membership&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [OrchestrationTrigger] DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (membership == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Read from an external source </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            membership = await RetriveFromCosmosDB(context.InstanceId);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var operation = await context.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;***** received &#x27;{operation}&#x27; event.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        operation = operation?.ToLowerInvariant();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation == &quot;refresh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            membership = await Refresh(context, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation != &quot;end&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.ContinueAsNew(membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Refresh(DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                              TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Do something to refresh the membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Code = context.InstanceId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Store to an external source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await StoreToCosmosDB(context.InstanceId, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateTime now = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string formatDate = now.ToString(&quot;MM/dd/yyyy hh:mm:ss.fff tt&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;**** done refreshing &#x27;{context.InstanceId}&#x27; @ {formatDate}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the HTTP trigger that retrieves the membership actor state from an extenal source without dealing with the actor:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpGetMembership&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;get&quot;, Route = &quot;memberships/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var status = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (status != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.OK, await RetriveFromCosmosDB(code));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.BadRequest, $&quot;{code} membership actor is not found!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>So unlike regular actor implementation, Azure Functions singletons do not expose any method to be called from the outside! The platform only allows starting/creating, querying and terminating instances. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="comments--anamolies"></a>Comments &amp; Anamolies<a class="hash-link" href="#comments--anamolies" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="net-core-and-net-standard-20"></a>.NET Core and .NET Standard 2.0<a class="hash-link" href="#net-core-and-net-standard-20" title="Direct link to heading">#</a></h3><p>It is work in progress! It is best to use the .NET full framework with Azure Durable Functions. Hopefully this will change soon and we will be able to use .NET Core reliably.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="local-debugging"></a>Local Debugging<a class="hash-link" href="#local-debugging" title="Direct link to heading">#</a></h3><p>I had a very hard time with this. The symptoms that I experienced are unfortutanely not experienced by other developers who tried this as I could not see similar reported issues. I am using Vs2017 and Azure Functions Extension ...the latest at the time of writing DEC/2017. </p><p>Here are my comments:</p><ul><li>If you want to debug locally, make sure you set both the local.setting.json and host.json file to <code>copy always</code>. You do this from the properties window.</li><li>On both of my developer machines, I hit F5, it prompts me to install the Azure Functions Core tools and things look quite good. I was able to run locally.</li><li>But then subsequent F5, I get very different results ranging from:<ul><li>The CLI starts and exits on its own ...I could not find out what the reason is</li><li>The CLI starts and displays the functions URls. But it also complains about some files were changed and the host needs to restart. The URls are not responsive and there is nothing you can do except to terminate and restart.</li><li>The CLI statrs and actually works.....does not happen often ...but I have seen it work</li><li>F5 mostly causes the CLI to start and exit. Control-F5 does not exit ...but the function URLs are not accessible due to this <code>change detected</code> message.</li></ul></li><li>Effectively, local debugging did not work for me at all. It was a very frustrating experience. So I had to deploy everything (see deplyment below) to Azure and debug there....another frustrating experience. </li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h3><ul><li>The only effective way I was able to find out how to deploy a Durable Functions App is via Visual Studio. I have heard some people got it to work with VSTS. But, given that this is a test run, I did not really explore this option.</li><li>However, if you just click the <code>publish</code> button in VS, it will auto-create a storage account for you which names things really weird. My recommendation is to create the App Service, Service Plan, Storage and App Insights in portal or via Azure CLI and then use Visual Studio to publish into it. </li><li>If you renamed a function and re-deployed, Visual Studio will publish the new functions app with the new function. But the old function will still be there (you can see it from the portal). You can then use <code>Kudo</code>, navigate to the directory and actually delete the old function folder. </li><li>The local.settings.json entries are not deployed to Azure! This means you have to manually create them in the portal app settings or in Visual Studio deployment window. </li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="storage"></a>Storage<a class="hash-link" href="#storage" title="Direct link to heading">#</a></h3><p>As mentioned, an Azure Storage is required to maintain teh durable instances. They are keyed off the hub name you specify in the host. There are entries in blob, tables, files and queues. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="logging"></a>Logging<a class="hash-link" href="#logging" title="Direct link to heading">#</a></h3><p>Unless you turn on streaming on a function in the portal, you don&#x27;t get anything (or at least, I could not find a way to do it). But watching the log from the portal is very difficult as it times out and it is not very user friendly. This is one area that requires better UX in the portal. The logs are also stored on the app&#x27;s file system which you can access from <code>Kudo</code>. However, I noticed that, unless you request stream logging on a function, these files are not created. </p><p>So the story of logging is a little frustrating at best! I had to use App Insights trace to see what is going on.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="timers"></a>Timers<a class="hash-link" href="#timers" title="Direct link to heading">#</a></h3><p>As mentioned above, it is very important that we leverage the context to provide accurate timer information as opposed to <code>TimeSpan</code> and <code>DateTime.Now</code>, etc. Initially I used <code>TimeSpan.FromMinutes(30)</code> to wait for 30 minutes....but the way to do it is to always use the <code>context</code> such as <code>DateTime deadline = context.CurrentUtcDateTime.AddMinutes(30);</code>. After doing that, I started getting conistent timeout periods and things worked normally. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="instance-termination"></a>Instance Termination<a class="hash-link" href="#instance-termination" title="Direct link to heading">#</a></h3><p>Although <code>TerminateAsync</code> on an instance works, I am not exactly sure if it works the way it is supposed to:</p><ul><li>If I have a running instance and that instance is actually waiting on an external or time out event, <code>TerminateAsync</code> does not do anything. I guess because a message is enqueued to the instance but the instance is waiting on other events ....so it did not get the <code>terminate</code> signal yet.</li><li>If the instance is not waiting on anything, <code>TerminateAsync</code> replays the instance which runs code that you don&#x27;t necessarily want to run. For example, I had an instance that triggers a logic app once it receives an <code>end</code> operation which works. However, if I terminate the instance using <code>TerminateAync</code>, the code triggers the logic app again because it was replayed! </li></ul><p>Not sure if this behavior is correct and what the <code>terminate</code> signal actually do.       </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Reflecting on the little time that I spent with Azure Durable Functions, I think they will play an important part of my future solutions. I think they have what it takes to use as actors especially that the Azure Durable Functions are designed to <a href="https://social.msdn.microsoft.com/Forums/en-US/b6ffeae3-f62a-4e6d-a68a-e5dc6f9ffd62/durable-singletons?forum=AzureFunctions" target="_blank" rel="noopener noreferrer">support 1000&#x27;s of instances</a> . If we externalize the actor&#x27;s state, we will be able to query the external store as opposed to query the actors themselves to retrieve their state. </p><p>Azure Durable Actors can also employ reminders and other sophisticated techniques found in Service Fabric actors such as long-running, stateful, single-threaded, location-transparent and globally addressable (taken from the overview <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable-functions-overview" target="_blank" rel="noopener noreferrer">documentation page</a>). However, as stated above and unlike other actor implementations, Azure Functions singletons do not expose methods that can be called from the outside. </p><p>In any case, the Azure Durable Functions are still in preview. So we can expect many great features to be added soon.  </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/azure-functions">Azure Functions</a></div><div class="col text--right"><a aria-label="Read more about Actors in Serverless" href="/blog/2017/12/27/durable-functions"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/6875c492.dfa2ff96.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/5aee77e7.26a47450.js"></script>
<script src="/0f32c5fb.b89090b2.js"></script>
</body>
</html>