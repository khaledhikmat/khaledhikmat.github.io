<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">Posts tagged &quot;cosmosdb&quot; | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="Posts tagged &quot;cosmosdb&quot; | Coding Thoughts"><meta data-react-helmet="true" name="description" content="Blog | Tagged &quot;cosmosdb&quot;"><meta data-react-helmet="true" property="og:description" content="Blog | Tagged &quot;cosmosdb&quot;"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/6875c492.dfa2ff96.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/d60bfb02.3b07197f.js" as="script">
<link rel="preload" href="/fd7a688e.2afc96d7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><h1>1 post tagged with &quot;cosmosdb&quot;</h1><a href="/blog/tags">View All Tags</a><div class="margin-vert--xl"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/03/30/deletes-in-docdb">Document Deletion in Azure DocumentDB</a></h2><div class="margin-vert--md"><time datetime="2017-03-30T00:00:00.000Z" class="blogPostDate_Ta7i">March 30, 2017  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I saw many posts about deleting documents in Azure DocumentDB...but none of them worked quite well for me. So I spent a few hours on this and finally got it to work. Below is my solution. The following posts helped me tremendously (thank you):</p><ul><li><a href="https://talkingaboutdata.wordpress.com/2015/08/24/deleting-multiple-documents-from-azure-documentdb/" target="_blank" rel="noopener noreferrer">https://talkingaboutdata.wordpress.com/2015/08/24/deleting-multiple-documents-from-azure-documentdb/</a></li><li><a href="https://www.tutorialspoint.com/documentdb/documentdb_delete_document.htm" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/documentdb/documentdb_delete_document.htm</a></li><li><a href="http://stackoverflow.com/questions/29137708/how-to-delete-all-the-documents-in-documentdb-through-c-sharp-code" target="_blank" rel="noopener noreferrer">http://stackoverflow.com/questions/29137708/how-to-delete-all-the-documents-in-documentdb-through-c-sharp-code</a></li><li><a href="https://azure.microsoft.com/en-us/blog/working-with-dates-in-azure-documentdb-4/" target="_blank" rel="noopener noreferrer">https://azure.microsoft.com/en-us/blog/working-with-dates-in-azure-documentdb-4/</a></li></ul><p>I basically wanted to delete aging documents (based on number of hours) from a collection. So my final routine looks like this. Below is some explanation:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;int&gt; DeleteAgingDocuments(Uri docDbUri, string docDbKey, string databaseName, string collectionName, int hours)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using (var client = new DocumentClient(docDbUri, docDbKey))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var dbs = this._docDbClient.CreateDatabaseQuery().ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (dbs == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception(&quot;No databases in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var db = dbs.Where(d =&gt; d.Id == databaseName).FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (db == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;No database [{databaseName}] in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var collections = this._docDbClient.CreateDocumentCollectionQuery(db.CollectionsLink).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (collections == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;No collections in the [{databaseName}] database in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var collection = this._docDbClient.CreateDocumentCollectionQuery(db.CollectionsLink).Where(c =&gt; c.Id == collectionName).ToList().FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (collection == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;No collection [{collectionName}] in the [{databaseName}] database in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            int epocDateTime = DateTime.UtcNow.AddHours(-1 * hours).ToEpoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var dbQuery = &quot;SELECT VALUE {\&quot;link\&quot;: c._self, \&quot;source\&quot;: c.source} FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var link = (string)doc.link;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var source = (string)doc.source;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await this._docDbClient.DeleteDocumentAsync(link, new RequestOptions() { PartitionKey = new Microsoft.Azure.Documents.PartitionKey(source) });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return docs.Count;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // some debug </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="time"></a>Time<a class="hash-link" href="#time" title="Direct link to heading">#</a></h3><p>The first problem I encountered is how to select the aging documents! It turned out the best way to do this is to compare numbers as opposed to dates. This <a href="https://azure.microsoft.com/en-us/blog/working-with-dates-in-azure-documentdb-4/" target="_blank" rel="noopener noreferrer">post</a> helped me understand what the problem is and how to go around doing it properly. I ended it up using the built-in time stamp value stored as meta data in every DocDB document i.e. <code>_ts</code>. This may or may not work for every case. In my case my collection document date i.e. <code>eventDate</code> is actually the real UTC time ....so it was no problem. If this is not the case, you many need to store your own time stamp (in addition to the date) so u can do the query to pull the aging documents based on time. </p><p>so this query does exactly that:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">int epocDateTime = DateTime.UtcNow.AddHours(-1 * hours).ToEpoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = $&quot;SELECT * FROM c WHERE c._ts &lt; {epocDateTime}&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Notice how I am using the Epoc time for my aging time stamp. The <code>DateTime</code> extension is written this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static int ToEpoch(this DateTime date)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (date == null) return int.MinValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DateTime epoch = new DateTime(1970, 1, 1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TimeSpan epochTimeSpan = date - epoch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return (int)epochTimeSpan.TotalSeconds;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="partition-key"></a>Partition Key<a class="hash-link" href="#partition-key" title="Direct link to heading">#</a></h3><p>My collection was partitioned over a value in the document i.e. <code>source</code>, but I wanted to trim all aging documents across all partitions...not against a single partition. So I used this query options to force the query to span multiple partitions:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FeedOptions queryOptions = new FeedOptions { EnableCrossPartitionQuery = true };</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deletion"></a>Deletion<a class="hash-link" href="#deletion" title="Direct link to heading">#</a></h3><p>Finally, I wanted to loop through all aging documents and delete:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">int epocDateTime = DateTime.UtcNow.AddHours(-1 * hours).ToEpoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = &quot;SELECT VALUE {\&quot;link\&quot;: c._self, \&quot;source\&quot;: c.source} FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var link = (string)doc.link;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var source = (string)doc.source;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await this._docDbClient.DeleteDocumentAsync(link, new RequestOptions() { PartitionKey = new Microsoft.Azure.Documents.PartitionKey(source) });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="query"></a>Query<a class="hash-link" href="#query" title="Direct link to heading">#</a></h4><p>Please note that the query that I used above uses a projection to get only the document link and the partition key....we really do not need the entire document:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = &quot;SELECT VALUE {\&quot;link\&quot;: c._self, \&quot;source\&quot;: c.source} FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Also please note that I am using the <code>VALUE</code> modifier in the query so to force DocDB to return the value only. This will return a payload that looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwABAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;source&quot;: &quot;Digital Controller&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwACAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;source&quot;: &quot;Profiler&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If I don&#x27;t include the <code>VALUE</code> modifier, I get this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;$1&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwABAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;source&quot;: &quot;Digital Controller&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;$1&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwACAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;source&quot;: &quot;Profiler&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I chose the first one :-)  </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deletion-1"></a>Deletion<a class="hash-link" href="#deletion-1" title="Direct link to heading">#</a></h4><p>Finally, we pull the documents and delete one at a time:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var link = (string)doc.link;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var source = (string)doc.source;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await this._docDbClient.DeleteDocumentAsync(link, new RequestOptions() { PartitionKey = new Microsoft.Azure.Documents.PartitionKey(source) });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Initially, I only got the document link from the query thinking that this was the only requirement. So I did something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = &quot;SELECT VALUE c._self FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await this._docDbClient.DeleteDocumentAsync(doc);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This did not work! I needed to pass the partition key....this is why i changed the query to a projection so I can get the partition key. In my case the partition key is the <code>source</code>. There is a comment in this <a href="http://stackoverflow.com/questions/29137708/how-to-delete-all-the-documents-in-documentdb-through-c-sharp-code" target="_blank" rel="noopener noreferrer">post</a> that gave me a clue that the request option must include the partition key.</p><p>Thank you for reading! I hope this helps someone. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/cosmos-db">CosmosDB</a></div><div class="col text--right"><a aria-label="Read more about Document Deletion in Azure DocumentDB" href="/blog/2017/03/30/deletes-in-docdb"><strong>Read More</strong></a></div></footer></article></div></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/6875c492.dfa2ff96.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/d60bfb02.3b07197f.js"></script>
<script src="/fd7a688e.2afc96d7.js"></script>
</body>
</html>