<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">Blog | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="Blog | Coding Thoughts"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/a6aa9e1f.f048fb53.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/35569fa2.61750228.js" as="script">
<link rel="preload" href="/ec66d46e.bae7aea3.js" as="script">
<link rel="preload" href="/4be9694a.f3e9695f.js" as="script">
<link rel="preload" href="/8b38971f.bbacab40.js" as="script">
<link rel="preload" href="/2a82850d.6052dc04.js" as="script">
<link rel="preload" href="/b796d8fd.35fe7267.js" as="script">
<link rel="preload" href="/0532bc6e.31fdf76f.js" as="script">
<link rel="preload" href="/8eb4e46b.2f728d47.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/12/15/service-fabric-fundamentals">Service Fabric Fundamentals</a></h2><div class="margin-vert--md"><time datetime="2016-12-15T00:00:00.000Z" class="blogPostDate_Ta7i">December 15, 2016  Â· 20 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>The <a href="https://github.com/Azure-Samples/service-fabric-dotnet-iot" target="_blank" rel="noopener noreferrer">Service Fabric iOT sample app</a> is a great sample to follow for our own Service Fabric apps. In this post, I used code snippets and concepts from the iOT sample to build a small app to demonstrate some fundamentals concepts that I feel are important.</p><p>The source code for this post is available <a href="https://github.com/khaledhikmat/service-fabric-fundamentals" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-app-scenario"></a>The app scenario<a class="hash-link" href="#the-app-scenario" title="Direct link to heading">#</a></h2><p>The app is called Rate Aggregator where we have an app that monitors hotel rate requests coming in from somewhere (presumably from some site) and aggregates the result by city. I also wanted the app to be multi-tenant so we can have an app instance for each rate service provider i.e. Contoso and Fabrican. </p><p>The app is quite simple and consists of two services: Web Service to act as a front-end and a rates service to actually process the rates and aggregate them:</p><p><img src="http://i.imgur.com/trNQnSS.png" alt="App Components"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="source-code"></a>Source Code<a class="hash-link" href="#source-code" title="Direct link to heading">#</a></h2><p>The solution source code consists of 4 different projects:</p><ul><li>Common Project - a class library that has the common classes that are shared across the other projects. Please note that this library must be built using the <code>x64</code> platform.</li><li>Web Service - a stateless Service Fabric service created using the Visual Studio ASP.NET Core template.</li><li>Rates Service - a stateful Service Fabric service created using the Visual Studio ASP.NET Core template.</li><li>An app project to contain the Service Fabric instances and provide application manifests.</li><li>A collection of PowerShell scripts that manage the deployment, un-deployment, update, upgrade and test. We will go through those files in this post.</li></ul><p>Please note:</p><ul><li>I created the solution using VS 2015 Service Fabric template. But actually the projects are regular projects that include Service Fabric NuGet packages. The only project that is quite specific to Service Fabric is the app project i.e. <code>RateAggregatorApp</code> ...but as demonstrated in a <a href="/blog/2016/12/02/service-fabric-basics">previous post</a>, the app manifests and packaging can be easily generated manually.</li><li>The ASP.NET Code template in Service Fabric is still in preview. I noticed some odd stuff about it:<ul><li>The template assumes that you are building stateless services! To create Stateful services using the ASP.NET template, manual intervention have to take place which I will note in this post</li><li>The useful <code>ServiceEventSource.cs</code> class is not included in the generated project. So if you want to use ETW logging, you must create this file manually (copy it from another SF project)</li><li>The template includes, in the <code>Program.cs</code> file the Service Fabric registration code and the Service class. It is useful to break up apart and create a class (using the name of the service) to describe the service i.e. <code>WebService</code> and <code>RatesService</code></li></ul></li><li>The Service Fabric <code>RateAggregatorApp</code> <code>APplicationManifest.xml</code> file has a section for <code>DefaultServices</code> which automatically deploys the default services whenever an app is deployed. I usually remove the default services from the manifest file so i can better control the named app instance and service creation process (which I will demo in this post).</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="fundamental-concepts"></a>Fundamental Concepts<a class="hash-link" href="#fundamental-concepts" title="Direct link to heading">#</a></h2><p>The <a href="https://github.com/Azure-Samples/service-fabric-dotnet-iot" target="_blank" rel="noopener noreferrer">iOT</a> sample includes really nice code utilities that can be used to build <code>Uri</code>s for services especially when the service exposes HTTP endpoints. The most important concepts that I would like to convey are:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="http-endpoints"></a>HTTP Endpoints<a class="hash-link" href="#http-endpoints" title="Direct link to heading">#</a></h3><p>If you would like to expose HTTP Endpoints for your service, Microsoft strongly recommends that you build the URL as follows:</p><p><img src="http://i.imgur.com/qQdvX9h.png" alt="HTTP Endpoint URL"></p><p>Examples:</p><ol><li><code>Http://localhost:8084/ContosoRateAggregatorApp/7217642a-2ac8-4b29-b52d-3e92303ce1b2/131262989332452689/f74f07f7-d92f-47b9-8d6b-c86966c78d09</code></li><li><code>Http://localhost:8084/FabricanRateAggregatorApp/13049e47-9727-4e02-9086-8fd6e2457313/131262989924122573/3b3455d8-487e-4ec4-9bd8-64ba8e658662</code></li></ol><p>For stateful services, this makes total sense! The combination of <code>partitionId</code> and <code>instanceId</code> are great for diagnostics and the <code>guid</code> makes every endpoint unique which is really useful because services are sometimes moved around. However, for Stateless services, I think we can easily omit the <code>partitionId</code>, the <code>instanceId</code> and the <code>guid</code> since stateless service endpoints are usually load balanced as they accept traffic from the Internet. Examples of stateless services endpoints:</p><ol><li><code>Http://localhost:8082/FabricanRateAggregatorApp</code></li><li><code>Http://localhost:8082/ContosoRateAggregatorApp</code></li></ol><p>If you are planning to expose multiple stateless web services in each app instances, then perhaps adding the service name to the end of the URL would make sense.Examples:</p><ol><li><code>Http://localhost:8082/FabricanRateAggregatorApp/WebService</code></li><li><code>Http://localhost:8082/ContosoRateAggregatorApp/WebService</code></li></ol><p>The demo app source code common project includes a <code>WebHostCommunicationListener</code> class (which is borrowed from the iOT sample) shows a really good implementation of how to manage this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">string ip = this.serviceContext.NodeContext.IPAddressOrFQDN;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EndpointResourceDescription serviceEndpoint = this.serviceContext.CodePackageActivationContext.GetEndpoint(this.endpointName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EndpointProtocol protocol = serviceEndpoint.Protocol;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int port = serviceEndpoint.Port;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string host = &quot;+&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string listenUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string path = this.appPath != null ? this.appPath.TrimEnd(&#x27;/&#x27;) + &quot;/&quot; : &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (this.serviceContext is StatefulServiceContext)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    StatefulServiceContext statefulContext = this.serviceContext as StatefulServiceContext;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    listenUrl = $&quot;{serviceEndpoint.Protocol}://{host}:{serviceEndpoint.Port}/{path}{statefulContext.PartitionId}/{statefulContext.ReplicaId}/{Guid.NewGuid()}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    listenUrl = $&quot;{serviceEndpoint.Protocol}://{host}:{serviceEndpoint.Port}/{path}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">this.webHost = this.build(listenUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">this.webHost.Start();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">return Task.FromResult(listenUrl.Replace(&quot;://+&quot;, &quot;://&quot; + ip));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="http-web-apis"></a>HTTP Web APIs<a class="hash-link" href="#http-web-apis" title="Direct link to heading">#</a></h3><p>Using ASP.NET Core to implement the Stateless and Stateful services has the distinct advantage of allowing the services expose a Web API layer that can be used by clients to call on the services. The Web API layer has regular controllers with normal Web API decoration to allow the services be called from regular HTTP clients:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/[controller]&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class RatesController : Controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IReliableStateManager stateManager;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly StatefulServiceContext context;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly CancellationTokenSource serviceCancellationSource;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public RatesController(IReliableStateManager stateManager, StatefulServiceContext context, CancellationTokenSource serviceCancellationSource)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.stateManager = stateManager;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.context = context;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.serviceCancellationSource = serviceCancellationSource;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Route(&quot;queue/length&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; GetQueueLengthAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Please note that the service has the <code>IReliableStateManager</code>, the <code>StatefulServiceContext</code> and the <code>CancellationSource</code> injected. This allows the Web API controller to use the service reliable collections and anything else related to service context. For example, this is the implementation of the queue length Web API method:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Route(&quot;queue/length&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; GetQueueLengthAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IReliableQueue&lt;RateRequest&gt; queue = await this.stateManager.GetOrAddAsync&lt;IReliableQueue&lt;RateRequest&gt;&gt;(RatesService.RateQueueName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using (ITransaction tx = this.stateManager.CreateTransaction())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                long count = await queue.GetCountAsync(tx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return this.Ok(count);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Note how the API controller uses the injected <code>StateManager</code> to gain access to the reliable queue and reports on its length.</p><p>Since the service interface is implemented as regular Web API controllers (or controllers), they can also be exposed as <code>Swagger</code> and allow other an API management layer to front-end these services.  </p><p>To make this possible, the service must override the <code>CreateServiceInstanceListeners</code> in case of stateless services and <code>CreateServiceReplicaListeners</code> in case of stateful services. Here is an example of the Stateful service:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">protected override IEnumerable&lt;ServiceReplicaListener&gt; CreateServiceReplicaListeners()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new ServiceReplicaListener[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new ServiceReplicaListener(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                string tenantName = new Uri(context.CodePackageActivationContext.ApplicationName).Segments.Last();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return new WebHostCommunicationListener(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tenantName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;ServiceEndpoint&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    uri =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        ServiceEventSource.Current.Message($&quot;Listening on {uri}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return new WebHostBuilder().UseWebListener()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .ConfigureServices(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                services =&gt; services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                    .AddSingleton&lt;StatefulServiceContext&gt;(this.Context)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                    .AddSingleton&lt;IReliableStateManager&gt;(this.StateManager)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                    .AddSingleton&lt;CancellationTokenSource&gt;(this._webApiCancellationSource))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .UseContentRoot(Directory.GetCurrentDirectory())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .UseStartup&lt;Startup&gt;()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .UseUrls(uri)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Please note the use of the <code>WebHostCommunicationListener</code> and how we inject the service context, state manager and the cancellation token.</p><p>In our demo app, both statelss and stateful services implement their interface as Web API.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="http-vs-rcp-endpoints"></a>HTTP vs. RCP Endpoints<a class="hash-link" href="#http-vs-rcp-endpoints" title="Direct link to heading">#</a></h3><p>Instead of HTTP Web API, Services (especially stateful) can expose an interface using a built-in RCP communicaton listener. In this case, the service implements an interface and make it easy for clients to call upon the service using the interface. For example, a stateful service might have an interface that looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public interface ILookupService : IService</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task EnqueueEvent(SalesEvent sEvent);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task&lt;string&gt; GetNodeName();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task&lt;int&gt; GetEventsCounter(CancellationToken ct);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The service will then be implemented this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal sealed class LookupService : StatefulService, ILookupService</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The service will override the CreateServiceReplicaListeners as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protected override IEnumerable&lt;ServiceReplicaListener&gt; CreateServiceReplicaListeners()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return new[]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new ServiceReplicaListener(context =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    this.CreateServiceRemotingListener(context),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;rpcPrimaryEndpoint&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    false)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Although this looks nice and complies with Object Oriented programming, I think it should only be used with internal stateful services (those that do not expose an outside interface). Stateless services that are used by external clients are better off using an HTTP Web API interface which makes them easily consumable by many clients in different languages. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="reliable-collections"></a>Reliable Collections<a class="hash-link" href="#reliable-collections" title="Direct link to heading">#</a></h3><p>Since we have the state manager injected in the stateful service Web API controllers, it makes all the service reliable collections available to the Web API controllers. In our demo, the <code>RatesService</code> Web API controller i.e. <code>RatesController</code> uses the reliable queue to get the queue length and enqueue rate requests to the service. The service processes the incoming <code>RateRequest</code> in its <code>RunAsyc</code> method and aggregates the results in a reliable dictionary indexed by city/country:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">protected override async Task RunAsync(CancellationToken cancellationToken)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cancellationToken.Register(() =&gt; this._webApiCancellationSource.Cancel());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IReliableDictionary&lt;string, RateAggregation&gt; citiesDictionary = await this.StateManager.GetOrAddAsync&lt;IReliableDictionary&lt;string, RateAggregation&gt;&gt;(RateCitiesDictionaryName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IReliableQueue&lt;RateRequest&gt; queue = await this.StateManager.GetOrAddAsync&lt;IReliableQueue&lt;RateRequest&gt;&gt;(RateQueueName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while (true)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        cancellationToken.ThrowIfCancellationRequested();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using (var tx = this.StateManager.CreateTransaction())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var result = await queue.TryDequeueAsync(tx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (result.HasValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    RateRequest request = result.Value;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // TODO: Process the request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // TODO: Go against the reservation provider to pick up the rate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // TODO: How do I determine the reservation provider per tenant?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    int nights = (request.CheckOutDate - request.CheckInDate).Days;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    int netAmount = _random.Next(500) * nights;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var newAggregation = new RateAggregation();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    newAggregation.Transactions = 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    newAggregation.Nights = nights;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    newAggregation.Amount = (double) netAmount;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    await citiesDictionary.AddOrUpdateAsync(tx, $&quot;{request.City}/{request.Country}&quot;, newAggregation, (key, currentValue) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        currentValue.Transactions += newAggregation.Transactions;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        currentValue.Nights += newAggregation.Nights;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        currentValue.Amount += newAggregation.Amount;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return currentValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // This commits the add to dictionary and the dequeue operation.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    await tx.CommitAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        catch (Exception e)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await Task.Delay(TimeSpan.FromMilliseconds(500), cancellationToken);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The reliable dictionary is then used in the service contrloller to return the aggregated result in an API call. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="partitions-replicas-and-instances"></a>Partitions, Replicas and Instances<a class="hash-link" href="#partitions-replicas-and-instances" title="Direct link to heading">#</a></h3><p>In our demo app, we use partitions in the Stateful service i.e. <code>RatesService</code> to partition our data in 4 different buckets: </p><ol><li>Rate Requests for the United States</li><li>Rate Requests for Canada</li><li>Rate Requests for Australia</li><li>Rate Requests for other countries</li></ol><p>Hence our partition key range is 0 (Low Key) to 3 (High Key). We use a very simple method to select the appropriate partition based on the request&#x27;s country code:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">private long GetPartitionKey(RateRequest request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (request.Country == &quot;USA&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else if (request.Country == &quot;CAN&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else if (request.Country == &quot;AUS&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else // all others</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 3;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To allow for high availability, Service Fabric uses replicas for stateful services and instances for stateless services. In Service Fabric literature, the term replicas and instances are often exchanged. </p><p>In order to guarantee high availability of stateful service state, the state for each partition is usually replicated. The number of replicas is decided at the time of deploying the service (as we will see soon in the PowerShell script). This means that, if a stateful service has 4 partitions and the target replica count is 3, for example, then there are 12 instances of that service in Service Fabric.    </p><p>In order to guarantee high availability of stateless services, Service Fabric allows the instantiation of multiple instances. Usually the number of instances matches the number of nodes in the Service Fabric cluster which allows Service Fabric to distribute an instance on each node. The load balancer then distribute the load across all nodes. </p><p>Please note, however, that, unlike stateless service instances, a stateful service partitions cannot be changed at run-time once the service is deployed. The number of partitions must be decided initially before the service is deployed to the cluster. Of course, if the service state can be discarded, then of course changes to the partition are allowed. Stateless services number of instances can be updated at any time (up or down) at any time. In fact, this is one of the great features of Service Fabric.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="result-aggregation"></a>Result Aggregation<a class="hash-link" href="#result-aggregation" title="Direct link to heading">#</a></h3><p>Since the state is partitioned, does this mean that we have the reliable collections (i.e. queues and dictionaries) scattered among the different partitions? The answer is yes! For example, in order to get the queue length of a stateful service, the client has to query all partitions and ask each service instance about the queue length and add them together to determine the overall queue length for the stateful service:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Route(&quot;queue/length&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;IActionResult&gt; GetQueueLengthAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServiceUriBuilder uriBuilder = new ServiceUriBuilder(RatesServiceName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Uri serviceUri = uriBuilder.Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // service may be partitioned.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // this will aggregate the queue lengths from each partition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServicePartitionList partitions = await this.fabricClient.QueryManager.GetPartitionListAsync(serviceUri);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpClient httpClient = new HttpClient(new HttpServiceClientHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long count = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach (Partition partition in partitions)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Uri getUrl = new HttpServiceUriBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServiceName(serviceUri)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetPartitionKey(((Int64RangePartitionInformation)partition.PartitionInformation).LowKey)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServicePathAndQuery($&quot;/api/rates/queue/length&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpResponseMessage response = await httpClient.GetAsync(getUrl, this.cancellationSource.Token);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (response.StatusCode != System.Net.HttpStatusCode.OK)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.StatusCode((int)response.StatusCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string result = await response.Content.ReadAsStringAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        count += Int64.Parse(result);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return this.Ok(count);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><code>FabricClient</code> is the .NET client used to provide all sorts of management capabilities. It is injected in the Web Service controller to allow them to communicate with each partitition replica and get the needed results as shown above. Then the Web Service adds the count of each partition and return the total lenth of all partitions queues. </p><p>Similarly, the Web Service uses the <code>FabricClient</code> to communicate with the each partition replica to get and aggregate the result of each country cities:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Route(&quot;cities&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;IActionResult&gt; GetCitiesAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServiceUriBuilder uriBuilder = new ServiceUriBuilder(RatesServiceName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Uri serviceUri = uriBuilder.Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // service may be partitioned.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // this will aggregate cities from all partitions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServicePartitionList partitions = await this.fabricClient.QueryManager.GetPartitionListAsync(serviceUri);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpClient httpClient = new HttpClient(new HttpServiceClientHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CityStats&gt; cities = new List&lt;CityStats&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach (Partition partition in partitions)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Uri getUrl = new HttpServiceUriBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServiceName(serviceUri)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetPartitionKey(((Int64RangePartitionInformation)partition.PartitionInformation).LowKey)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServicePathAndQuery($&quot;/api/rates/cities&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpResponseMessage response = await httpClient.GetAsync(getUrl, this.cancellationSource.Token);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (response.StatusCode != System.Net.HttpStatusCode.OK)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.StatusCode((int)response.StatusCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        JsonSerializer serializer = new JsonSerializer();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (StreamReader streamReader = new StreamReader(await response.Content.ReadAsStreamAsync()))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using (JsonTextReader jsonReader = new JsonTextReader(streamReader))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                List&lt;CityStats&gt; result = serializer.Deserialize&lt;List&lt;CityStats&gt;&gt;(jsonReader);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (result != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    cities.AddRange(result);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return this.Ok(cities);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="multi-tenancy"></a>Multi-Tenancy<a class="hash-link" href="#multi-tenancy" title="Direct link to heading">#</a></h3><p>One of the great features of Service Fabric is its ability to allow the creation of multi-tenant scanarios. In our demo case, we may launch an app for Contoso rates and another one for Fabrican rates. We want these two apps to be of the same type but they should be completely isolated of each other. So we create two named app instances: <code>ConosoRateAggretor</code> and <code>FabricanRateAggregator</code>. This means that we have different set of services for each app operated independely and perhaps scaled, updated and upgraded independently.</p><p><img src="http://i.imgur.com/e6YmFNy.png" alt="Named App Instances"> </p><p>This is really useful in many scenarios and allows for many great advantages. In the next section, we will see how easy it is to actually deploy, un-deploy, update and upgrade these named instances.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="configuration"></a>Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">#</a></h3><p>Given that we have multiple named app instances, how do we pass different parameters for each named instance? In the <code>RatesService</code>, we would like to have the name of the provider (and probably other configuration items) so we can communicate with the provider to pull rates. In our demo app, we are not actually communicating with the provider.</p><p>To do this, we define parameters for the <code>RatesService</code> in the Service Settings file as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;Settings xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://schemas.microsoft.com/2011/01/fabric&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;!-- Add your custom configuration sections and parameters here --&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;Section Name=&quot;ParametersSection&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Parameter Name=&quot;ProviderName&quot; Value=&quot;&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/Section&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/Settings&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The section name can be anything. In our case, it is <code>ParametersSection</code>. To be able to override this value for a specific application instance, we create a <code>ConfigOverride</code> when we import the service manifest in the application manifest:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ServiceManifestImport&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ServiceManifestRef ServiceManifestName=&quot;RatesServicePkg&quot; ServiceManifestVersion=&quot;1.0.0&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ConfigOverrides&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;ConfigOverride Name=&quot;Config&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Settings&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &lt;Section Name=&quot;ParametersSection&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;Parameter Name=&quot;ProviderName&quot; Value=&quot;[RatesService_ProviderName]&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &lt;/Section&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;/Settings&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/ConfigOverride&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ConfigOverrides&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ServiceManifestImport&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><em>The convention is to name the value as <code>ServiceName_ParameterName</code></em></p><p>Finally, we must adjust the application manifest to include the required parameter:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ApplicationManifest xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; ApplicationTypeName=&quot;RateAggregatorAppType&quot; ApplicationTypeVersion=&quot;1.0.0&quot; xmlns=&quot;http://schemas.microsoft.com/2011/01/fabric&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;Parameters&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Parameter Name=&quot;RatesService_ProviderName&quot; DefaultValue=&quot;&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/Parameters&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ApplicationManifest&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Finally, at the deployment time (as you will see in more detail in the deployment script), we will specify a PowerShell <code>Hashtable</code> to override these parameters per named instance:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Contoso&quot;}  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Fabrican&quot;}  </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The <code>RatesService</code> code will then make sure of this parameter to contact the instance-bound provider.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="powershell-management-scripts"></a>PowerShell Management Scripts<a class="hash-link" href="#powershell-management-scripts" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h3><p><strong>This PowerShell script assumes that you used Visual Studio to generate the Service Fabric app package info (right-click the Service Fabric App and select <code>Package</code>) or you built the app package manually as demonstrated in a previous <a href="/blog/2016/12/02/service-fabric-basics">post</a>. The created package directory is expected to have the following format <code>v1.0.0</code> where 1.0.0 is the version number</strong></p><p>This PowerShell script copies the package to the cluster, registers the app type and creates two name app instances (i.e. Contoso and Fabrican). In each app instance, create two services: Web Service as a front-end and Rates service as a back-end. </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$imageStoreConnectionString = &quot;file:C:\SfDevCluster\Data\ImageStoreShare&quot;   # Use this with OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">If ($clusterUrl -ne &quot;localhost&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    $imageStoreConnectionString = &quot;fabric:ImageStore&quot;                       # Use this when not using OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Used only for the inmage store....it can be any name!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appPkgName = &quot;RateAggregatorAppTypePkg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the app and service types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appTypeName = &quot;RateAggregatorAppType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceTypeName = &quot;WebServiceType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ratesServiceTypeName = &quot;RatesServiceType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$version = &quot;1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;RateAggregatorApp\pkg\v$version&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the first aplication name (i.e. Contoso)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/ContosoRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ratesServiceName = $appName + &quot;/RatesService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Contoso&quot;}  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $webServiceTypeName -ServiceName $webServiceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># For stateful services, it is important to indicate in the service manifest that the service is stateful and that it has a persisted state:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># &lt;StatefulServiceType ServiceTypeName=&quot;RatesServiceType&quot; HasPersistedState=&quot;true&quot;/&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Actually all of these switches are important on the PowerShell command:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># -PartitionSchemeUniformInt64 $true -PartitionCount 4 -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -LowKey 0 -HighKey 3 -HasPersistedState</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $ratesServiceTypeName -ServiceName $ratesServiceName -PartitionSchemeUniformInt64 $true -PartitionCount 4 -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -LowKey 0 -HighKey 3 -HasPersistedState</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the second aplication name (i.e. Fabrican)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/FabricanRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ratesServiceName = $appName + &quot;/RatesService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Fabrican&quot;}  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $webServiceTypeName -ServiceName $webServiceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $ratesServiceTypeName -ServiceName $ratesServiceName -PartitionSchemeUniformInt64 $true -PartitionCount 4 -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -LowKey 0 -HighKey 3 -HasPersistedState</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="obliterate"></a>Obliterate<a class="hash-link" href="#obliterate" title="Direct link to heading">#</a></h3><p>This PowerShell script removes all application name instances and their services from the selected cluster. It does this based on the application type.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the app and service types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$applicationTypes = &quot;RateAggregatorAppType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Remove all application names instances and their services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-ServiceFabricApplication | Where-Object { $applicationTypes -contains $_.ApplicationTypeName } | Remove-ServiceFabricApplication -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-ServiceFabricApplicationType | Where-Object { $applicationTypes -contains $_.ApplicationTypeName } | Unregister-ServiceFabricApplicationType -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update"></a>Update<a class="hash-link" href="#update" title="Direct link to heading">#</a></h3><p>This PowerShell script updates the web service in each app named instance to have 5 instances. Please note that this works if the number of instances does  not exceed the number of nodes in the cluster.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the first aplication name (i.e. Contoso)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/ContosoRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Dynamically change the named service&#x27;s number of instances (the cluster must have at least 5 nodes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Update-ServiceFabricService -ServiceName $webServiceName -Stateless -InstanceCount 5 -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the first aplication name (i.e. Fabrican)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/FabricanRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Dynamically change the named service&#x27;s number of instances (the cluster must have at least 5 nodes) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Update-ServiceFabricService -ServiceName $webServiceName -Stateless -InstanceCount 5 -Force</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="upgrade"></a>Upgrade<a class="hash-link" href="#upgrade" title="Direct link to heading">#</a></h3><p>This PowerShell script upgrades the application named instances to a higher version i.e. 1.1.0. As noted earlier, this assumes that you have a new folder named v1.1.0 which contains the upgraded application package. The script uses <code>monitored</code> upgrade modes and performs the upgrade using upgrade domains. </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$imageStoreConnectionString = &quot;file:C:\SfDevCluster\Data\ImageStoreShare&quot;   # Use this with OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">If ($clusterUrl -ne &quot;localhost&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    $imageStoreConnectionString = &quot;fabric:ImageStore&quot;                       # Use this when not using OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Used only for the inmage store....it can be any name!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appPkgName = &quot;RateAggregatorAppTypePkg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the new version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$version = &quot;1.1.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;RateAggregatorApp\pkg\v$version&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the first aplication name (i.e. Contoso)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/ContosoRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the application to the new version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Start-ServiceFabricApplicationUpgrade -ApplicationName $appName -ApplicationTypeVersion $version -Monitored -UpgradeReplicaSetCheckTimeoutSec 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the second aplication name (i.e. Fabrican)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/FabricanRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the application to the new version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Start-ServiceFabricApplicationUpgrade -ApplicationName $appName -ApplicationTypeVersion $version -Monitored -UpgradeReplicaSetCheckTimeoutSec 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="test"></a>Test<a class="hash-link" href="#test" title="Direct link to heading">#</a></h3><p>This PowerShell scripts defines functions to exercise the Service Fabric Web service APIs for each named application instance.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function Generate-RateRequests($appName = &#x27;Contoso&#x27;, $iterations = 20)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Generating $iterations random rate requests against $appName ....&quot; -ForegroundColor Green</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $url = &quot;Http://localhost:8082/$appName&quot; + &quot;RateAggregatorApp/api/requests&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach($i in 1..$iterations)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $checkInDate = get-date -Year (get-random -minimum 2012 -maximum 2016) -Month (get-random -minimum 1 -maximum 12) -Day (get-random -minimum 1 -maximum 28)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $nights = get-random -minimum 1 -maximum 30</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $checkOutDate = $checkInDate.AddDays($nights)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $hotelId = get-random -input &quot;1&quot;, &quot;2&quot;, &quot;3&quot; -count 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $body = @{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                CheckInDate = get-date $checkInDate -Format &quot;yyy-MM-ddTHH:mm:ss&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                CheckOutDate = get-date $checkOutDate -Format &quot;yyy-MM-ddTHH:mm:ss&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                HotelId = $hotelId;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                HotelName = &quot;Hotel$hotelId&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                City = &quot;City$hotelId&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Country = get-random -input &quot;USA&quot;, &quot;USA&quot;, &quot;USA&quot;, &quot;CAN&quot;, &quot;CAN&quot;, &quot;CAN&quot;, &quot;AUS&quot;, &quot;AUS&quot;, &quot;AUS&quot;, &quot;FRA&quot;, &quot;GER&quot;, &quot;UAE&quot; -count 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Write-Host &quot;This is the JSON we are generating for iteration # $i....&quot; -ForegroundColor yellow</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $json = ConvertTo-Json $body -Depth 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $result = Invoke-RestMethod -Uri $url -Headers @{&quot;Content-Type&quot;=&quot;application/json&quot; } -Body $json -Method POST -TimeoutSec 600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } Catch {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure message: $_.Exception.Message&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure stack trace: $_.Exception.StackTrace&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure inner exception: $_.Exception.InnerException&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function View-QueueLength($appName = &#x27;Contoso&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;View Queue Length for $appName....&quot; -ForegroundColor Green</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $url = &quot;Http://localhost:8082/$appName&quot; + &quot;RateAggregatorApp/api/stats/queue/length&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $result = Invoke-RestMethod -Uri $url -Headers @{&quot;Content-Type&quot;=&quot;application/json&quot; } -Method GET -TimeoutSec 600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json = ConvertTo-Json $result -Depth 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } Catch {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure message: $_.Exception.Message&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure stack trace: $_.Exception.StackTrace&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure inner exception: $_.Exception.InnerException&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function View-Cities($appName = &#x27;Contoso&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;View cities for $appName....&quot; -ForegroundColor Green</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $url = &quot;Http://localhost:8082/$appName&quot; + &quot;RateAggregatorApp/api/stats/cities&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $result = Invoke-RestMethod -Uri $url -Headers @{&quot;Content-Type&quot;=&quot;application/json&quot; } -Method GET -TimeoutSec 600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json = ConvertTo-Json $result -Depth 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } Catch {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure message: $_.Exception.Message&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure stack trace: $_.Exception.StackTrace&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure inner exception: $_.Exception.InnerException&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Generate-RateRequests -appName Contoso -iterations 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Generate-RateRequests -appName Fabrican -iterations 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-QueueLength -appName Contoso</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-QueueLength -appName Fabrican</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-Cities -appName Contoso</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-Cities -appName Fabrican</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-is-next"></a>What is next?<a class="hash-link" href="#what-is-next" title="Direct link to heading">#</a></h2><p>I think Service Fabric has a lot of great and useful features that make it is a great candidate for a lot of scenarios. I will post more articles about Service Fabric as I expand my knowledge in this really cool technology. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/service-fabric">Service Fabric</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/12/02/service-fabric-basics">Service Fabric Basics</a></h2><div class="margin-vert--md"><time datetime="2016-12-02T00:00:00.000Z" class="blogPostDate_Ta7i">December 2, 2016  Â· 14 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>Service Fabric is a cool technology from Microsoft! It has advanced features that allows many scenarios. But in this post, we will only cover basic concepts that are usually misunderstood by a lot of folks.</p><p>For the purpose of this demo, we are going to develop a very basic guest executable service written as a console app. We will use very basic application and service manifests and PowerShell script to deploy to Service Fabric and show how Service Fabric monitors services, reports their health and allows for upgrade and update. </p><p>The source code for this post is available <a href="/blog/2016/12/02/service-fabric-basics">here</a>. Most of the code and ideas are credited to Jeff Richter of the Service Fabric Team.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="guest-service"></a>Guest Service<a class="hash-link" href="#guest-service" title="Direct link to heading">#</a></h2><p>The Guest service is a basic <code>Win32</code> console app that invokes an <code>HttpListener</code> on a port that is passed in the argument. The little web server responds to requests like so:</p><p><img src="http://i.imgur.com/YqTjqBD.png" alt="Web Server"></p><p>Note that the service is NOT running the Service Fabric cluster.</p><p>That is it!! This simple web server accepts a command called <code>crash</code> which will kill the service completely:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">http://localhost:8800?cmd=crash</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In fact, it does support multiple commands:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var command = request.QueryString[&quot;cmd&quot;];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (!string.IsNullOrEmpty(command))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    switch (command.ToLowerInvariant())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        case &quot;delay&quot;:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Int32.TryParse(request.QueryString[&quot;delay&quot;], out _delay);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        case &quot;crash&quot;:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Environment.Exit(-1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            break;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In order to make this service highly available, let us see how we can package this service to run within Service Fabric. Please note that this service is not cognizant of any Service Fabric. It is purely a simple <code>Win32</code> service written as a console app.</p><p><strong>Please note:</strong></p><ul><li>To debug the service locally from Visual Studio, you need to start VS in administrator mode.</li><li>Service Fabric requires the projects be <code>X64</code>! So you must change your projects to use <code>X64</code> by using the Visual Studio Configuration Manager.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="application-package"></a>Application Package<a class="hash-link" href="#application-package" title="Direct link to heading">#</a></h2><p>Application Package in Service Fabric is nothing but a folder that contains certain manifests in specific sub-folders! We will build the directory by hand instead of using Visual Studio so we can find out exactly how to do these steps. Let us create a directory called <code>BasicAvailabilityApp</code> (i.e.  <code>c:\BasicAvailabilityApp</code>) to describe the Service Fabric application. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-root-folder"></a>The root folder<a class="hash-link" href="#the-root-folder" title="Direct link to heading">#</a></h3><p>The root folder contains the application manifest and a sub-folder for each service in contains. Here is how the application manifest looks like for this demo application:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ApplicationManifest</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ApplicationTypeName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">BasicAvailabilityAppType</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ApplicationTypeVersion</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.0.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsd</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsi</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xmlns</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://schemas.microsoft.com/2011/01/fabric</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifestImport</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifestRef</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceManifestName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceTypePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceManifestVersion</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.0.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifestImport</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ApplicationManifest</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There are several pieces of information in this manifest:</p><ul><li>The application type: <code>BasicAvailabilityAppType</code>.</li><li>The application version: <code>1.0.0</code>.</li><li>The application contains a single service type <code>CrashableServiceTypePkg</code> with version <code>1.0.0</code>.</li><li>The XML name spaces are not important to us.</li></ul><p>This is how the application folder looks like: </p><p><img src="http://i.imgur.com/VMARUS3.png" alt="Root Application Folder"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-service-folder"></a>The service folder<a class="hash-link" href="#the-service-folder" title="Direct link to heading">#</a></h3><p>The service folder contains the service manifest and a sub-folder for each service in contains. Here is how the application manifest looks like for this demo application:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifest</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceTypePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.0.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xmlns</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://schemas.microsoft.com/2011/01/fabric</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsd</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsi</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceTypes</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">StatelessServiceType</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceTypeName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceType</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">UseImplicitHost</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">true</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceTypes</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableCodePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">1.0.0</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">CrashableService.exe</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">8800</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- ACL the 8800 port where the crashable service listens --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Resources</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoints</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoint</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">InputEndpoint</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Port</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">8800</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Protocol</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Type</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Input</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoints</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Resources</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifest</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There are several pieces of information in this manifest:</p><ul><li>The service package: <code>CrashableServiceTypePkg</code>.</li><li>The service version: <code>1.0.0</code>.</li><li>The service type: <code>CrashableServiceType</code>.</li><li>The service type is stateless.</li><li>The service code package exists in a sub-folder called <code>CodePkg</code> and it is of version <code>1.0.0</code>.</li><li>The service code consists of an executable called <code>CrashableService.exe</code>.</li><li>The XML name spaces are not important to us.</li><li>The <code>Endoints</code> must be specified to allow the Service Fabric to <code>ACL</code> the port that we want opened for our service to listen on. The <code>Input</code> type instructs SF to accepts input from the Internet.</li></ul><p>This is how the service folder looks like: </p><p><img src="http://i.imgur.com/0bA48hy.png" alt="service Folder"></p><p>This is what it takes to package an application in Service Fabric. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h2><p>Please note that the package we created in the previous step needs to be deployed to Service Fabric in order to run. To do this, we will need to use either Visual Studio or PowerShell. Since we want to use the lower level commands, we will use PowerShell instead of Visual Studio:</p><p>Here is the PowerShell script that we can use:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define equates (hard-coded):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$imageStoreConnectionString = &quot;file:C:\SfDevCluster\Data\ImageStoreShare&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appPkgName = &quot;BasicAvailabilityAppTypePkg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appTypeName = &quot;BasicAvailabilityAppType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/BasicAvailabilityApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$serviceTypeName = &quot;CrashableServiceType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$serviceName = $appName + &quot;/CrashableService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;BasicAvailabilityApp&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package from the cluster image store</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion &quot;1.0.0&quot; -ApplicationName $appName </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $serviceTypeName -ServiceName $serviceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The key commands are the last two where we:</p><ul><li>Create a named application name from the registered application type and version:</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion &quot;1.0.0&quot; -ApplicationName $appName </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>Create a named service within the named app from the service type:</li></ul><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $serviceTypeName -ServiceName $serviceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This is extremely significant as it allows us to create multiple application instances within the same cluster and each named application instance has its own set of services. This is how the named application and services are related to the cluster (this is taken from Service Fabric team presentation):</p><p><img src="http://i.imgur.com/377RP4J.png" alt="Naming Stuff"></p><p>Once the named application and the named service are deployed, the Service Fabric explorer shows it like this:</p><p><img src="http://i.imgur.com/tTLgIMX.png" alt="Success Deployment"></p><p>Now, if we access the service in Service Fabric, we will get a response that clearly indicates that the service is indeed running in Service Fabric:</p><p><img src="http://i.imgur.com/AI9jYOV.png" alt="Deployed in SF"></p><p>Note that the service is running in Node 1 of the Service Fabric cluster.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="availability"></a>Availability<a class="hash-link" href="#availability" title="Direct link to heading">#</a></h2><p>One of the major selling points of Service Fabric is its ability to make services highly available by monitoring them and restarting them if necessary.  </p><p>Regardless of whether the service is guest executable or Service Fabric cognizant service, Service Fabric monitors the service to make sure it runs correctly. In our case, the service will crash whenever a <code>crash</code> command is submitted. So if you crash the service, you will see that Service Fabric detects the failure and reports a bad health on the Service Fabric Explorer:</p><p><img src="http://i.imgur.com/XdY1JHg.png" alt="Error Deployment"></p><p>You will notice that the little web server is no longer available when you try to access it. But if you wait for a few seconds and try again, you will be very happy to know that the web server is available again. This is because Service Fabric detected that the service went down, restarted it and made it available holding to the promise of <code>high availability</code> or <code>self healing</code>.</p><p>However, there is only one little problem! The unhealthy indicators (warning or errors) on the explorer may never go away because there isn&#x27;t anything that resets them. So the health checks will also be shown once they are reported. This could become a little of a problem if you have an external tool that read health check state. </p><p><strong>The above statement is not entirely true! I have seen the latest versions of Service Fabric remove the warning/errors after a little while.</strong></p><p>In any case, I will show a better way (in my opinion) to deal with this shortly in this post. So read on if you are interested.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cleanup"></a>Cleanup<a class="hash-link" href="#cleanup" title="Direct link to heading">#</a></h2><p>In order to remove the named application and its services, you can issue these PowerShell commands:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Delete the named service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricService -ServiceName $serviceName -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Delete the named application and its named services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplication -ApplicationName $appName -Force</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In order to delete the application type:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># If no named apps are running, you can delete the app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Unregister-ServiceFabricApplicationType -ApplicationTypeName $appTypeName -ApplicationTypeVersion &quot;1.0.0&quot; -Force</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="versions--upgrade"></a>Versions &amp; Upgrade<a class="hash-link" href="#versions--upgrade" title="Direct link to heading">#</a></h2><p>It turned out that Service Fabric does not really care how you name your versions! If you name your versions as numbers like 1.0.0 or 1.1.0, this naming convention is referred to as <code>Semantic Versioning</code>. But you are free to use whatever version naming convention you want. </p><p>Let us use a different version scheme for our simple app. How about alpha, beta and productionV1, productionV2, etc. Let us cleanup our app from the cluster (as shown above), apply some changes to the <code>crashable</code> service, update the manifest files to make the version <code>Beta</code> and re-deploy using the beta version:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-application-manifest"></a>The Application Manifest<a class="hash-link" href="#the-application-manifest" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ApplicationManifest</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ApplicationTypeName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">BasicAvailabilityAppType</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ApplicationTypeVersion</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsd</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsi</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                     </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xmlns</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://schemas.microsoft.com/2011/01/fabric</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifestImport</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifestRef</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceManifestName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceTypePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceManifestVersion</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifestImport</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ApplicationManifest</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-service-manifest"></a>The Service Manifest<a class="hash-link" href="#the-service-manifest" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifest</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceTypePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xmlns</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://schemas.microsoft.com/2011/01/fabric</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsd</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsi</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceTypes</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">StatelessServiceType</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceTypeName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceType</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">UseImplicitHost</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">true</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceTypes</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableCodePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">CrashableService.exe</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">8800</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- ACL the 8800 port where the crashable service listens --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Resources</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoints</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoint</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">InputEndpoint</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Port</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">8800</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Protocol</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Type</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Input</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoints</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Resources</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifest</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment-1"></a>Deployment<a class="hash-link" href="#deployment-1" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define equates (hard-coded):</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$imageStoreConnectionString = &quot;file:C:\SfDevCluster\Data\ImageStoreShare&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appPkgName = &quot;BasicAvailabilityAppTypePkg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appTypeName = &quot;BasicAvailabilityAppType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/BasicAvailabilityApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$serviceTypeName = &quot;CrashableServiceType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$serviceName = $appName + &quot;/CrashableService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;BasicAvailabilityApp&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package from the cluster image store</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion &quot;Beta&quot; -ApplicationName $appName </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $serviceTypeName -ServiceName $serviceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="upgrade"></a>Upgrade<a class="hash-link" href="#upgrade" title="Direct link to heading">#</a></h3><p>Now that the beta version is deployed, let us make another change in the service, change the version to ProdutionV1 (in the application and service manifests) and issue the following PowerShell commands to register and upgrade to <code>ProductionV1</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package ProductionV1 to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;BasicAvailabilityApp-ProductionV1&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the application from Beta to ProductionV1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Start-ServiceFabricApplicationUpgrade -ApplicationName $appName -ApplicationTypeVersion &quot;ProductionV1&quot; -UnmonitoredAuto -UpgradeReplicaSetCheckTimeoutSec 100</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The upgrade takes place using a concept called Upgrade Domains which makes sure that the service that is being upgraded does not ever become unavailable:</p><p><img src="http://i.imgur.com/eSmVVHd.png" alt="Upgrade Domains"></p><p>Once the upgrade is done, the new application and service version is <code>ProductionV1</code>:</p><p><img src="http://i.imgur.com/l5Ohfgk.png" alt="Production V1"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="updates"></a>Updates<a class="hash-link" href="#updates" title="Direct link to heading">#</a></h2><p>Now that our service is in production, let us see what how we can increase and decrease its number of instances at will. This is very useful to scale the service up and down depending on parameters determined by the operations team. </p><p>You may have noticed that we have always used instance count 1 when we deployed our named service:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $serviceTypeName -ServiceName $serviceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Let us try to increase the instance count to 5 using PowerShell:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Dynamically change the named service&#x27;s number of instances</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Update-ServiceFabricService -ServiceName $serviceName -Stateless -InstanceCount 5 -Force</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Please note</strong> that if your test cluster has less than 5 nodes, you will get health warnings from Service Fabric because SF will not be place more instances than the number of available nodes. This is because SF cannot guarantee availability if it places multiple instances on the same node.</p><p>Anyway, if you get health warning or if you would like to scale back on your service, you can downgrade the number of instances using this PowerShell command:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Update-ServiceFabricService -ServiceName $serviceName -Stateless -InstanceCount 1 -Force</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Please notice how fast the scaling (up or down) takes place!!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="better-high-availability"></a>Better High Availability<a class="hash-link" href="#better-high-availability" title="Direct link to heading">#</a></h2><p>In a previous section in this post, we deployed the <code>crashable</code> service and watched it crash when we submitted a <code>crash</code> command. Service Fabric reported the failure, restarted the service and made it available again. Now we will modify the deployment process to provide a better way to take care of the re-start process. </p><p>To do so, we will need another service that monitors our <code>crashable</code> service and reports health checks to Service Fabric. This new code is Service Fabric aware and is demonstrated by Jeff Richter of the Service Fabric team.</p><p>Let us modify the application package to include this new code. Remember our goal is not to change the <code>crashable</code> service at all. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-service-manifest-1"></a>The Service Manifest<a class="hash-link" href="#the-service-manifest-1" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-xml codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifest</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceTypePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xmlns</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://schemas.microsoft.com/2011/01/fabric</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsd</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token tag" style="color:rgb(255, 85, 114)">                 </span><span class="token tag attr-name namespace" style="color:rgb(178, 204, 214)">xmlns:</span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">xsi</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http://www.w3.org/2001/XMLSchema-instance</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceTypes</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">StatelessServiceType</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">ServiceTypeName</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableServiceType</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">UseImplicitHost</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">true</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceTypes</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- Code that is NOT Service-Fabric aware --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- Remove Console Redirection in production --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-deploy-existing-app --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">CrashableCodePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">CrashableService.exe</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">8800</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ConsoleRedirection</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">FileRetentionCount</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">5</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">FileMaxSizeInKb</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">2048</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- Code that is Service-Fabric aware --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- Remove Console Redirection in production --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-deploy-existing-app --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">MonitorCodePkg</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Version</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Beta</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">MonitorService.exe</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Program</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain">8800</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Arguments</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">ConsoleRedirection</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">FileRetentionCount</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">5</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">FileMaxSizeInKb</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">2048</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ExeHost</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">EntryPoint</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">CodePackage</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">&lt;!-- ACL the 8800 port where the crashable service listens --&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Resources</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoints</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoint</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Name</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">InputEndpoint</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Port</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">8800</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Protocol</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">http</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag attr-name" style="color:rgb(255, 203, 107)">Type</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">=</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag attr-value" style="color:rgb(255, 85, 114)">Input</span><span class="token tag attr-value punctuation" style="color:rgb(199, 146, 234)">&quot;</span><span class="token tag" style="color:rgb(255, 85, 114)"> </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">/&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Endpoints</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">Resources</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&lt;/</span><span class="token tag" style="color:rgb(255, 85, 114)">ServiceManifest</span><span class="token tag punctuation" style="color:rgb(199, 146, 234)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>There are several things here:</p><ul><li>Our <code>crashable</code> service is still the same. It accepts an argumengt to tell it which port number to listen on.</li><li><code>ConsoleRedirection</code> is added to allow us to see the console output in the SF log files. This is to be removed in production.</li><li>Now there is one service i.e. <code>CrashableServiceType</code> but two code bases: one for the original exe and another code for the monitor that will monitor our <code>crashable</code> service. This is really nice as it allows us to add Service Fabric code to an existing service without much of intervention.</li><li>The <code>Endoints</code> must be specified to allow the Service Fabric to <code>ACL</code> the port that we want opened for our service to listen on. The <code>Input</code> type instructs SF to accepts input from the Internet.</li></ul><p>The package folders look like this:</p><p><img src="http://i.imgur.com/fYG5oLe.png" alt="Advanced Service Dir"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-monitor-service"></a>The Monitor Service<a class="hash-link" href="#the-monitor-service" title="Direct link to heading">#</a></h3><p>It is also a console app!! But it includes a Service Fabric Nuget package so it can use the <code>FabricClient</code> to communicate health checks to the local cluster. Basically, it sets up a timer to check the performance and availability of our <code>crashable</code> service. It reports to Service Fabric when failures take place. </p><p>Doing so makes our <code>crashable</code> service much more resilient to crashes or slow performances as it is monitored by the monitored service and re-started if necessary by Service Fabric. The health checks are also cleared much quicker.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="console-outputs-in-the-local-cluster"></a>Console Outputs in the local cluster<a class="hash-link" href="#console-outputs-in-the-local-cluster" title="Direct link to heading">#</a></h3><p>You can use the Service Fabric cluster explorer to find out where Service Fabric stores services on disk. This is available from the Nodes section:</p><p><img src="http://i.imgur.com/bvXbjc2.png" alt="SF Cluster Nodes"></p><p><img src="http://i.imgur.com/lqq6NJ4.png" alt="Node Disk"></p><p>This directory has a <code>log</code> folder that stores the output of each service. This can be very useful for debug purposes. To use it, however, you must have the <code>ConsoleRedirection</code> turned on as shown above.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-is-next"></a>What is next?<a class="hash-link" href="#what-is-next" title="Direct link to heading">#</a></h2><p>In future posts, I will use Service Fabric .NET programming model to develop and deploy stateless and stateful services to demonstrate Service Fabric fundamental concepts. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/service-fabric">Service Fabric</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/11/24/presentation-evaluation">Xamarin Forms App using VS for mac</a></h2><div class="margin-vert--md"><time datetime="2016-11-24T00:00:00.000Z" class="blogPostDate_Ta7i">November 24, 2016  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I am new to Xamarin development and I also wanted to try the newly announced VS for mac! So I created a little Camera app that can be used to evaluate presentations. The app allows the user to take a <code>selfie</code>. When committed, the picture is sent to an Azure cognitive function to extract the gender, male and smile (a measure of emotion). The app then displays the taken picture and returned result in the app. It also sends the result to PowerBI real-time stream to allow the visualization of the evaluation results.</p><p>So in essence, a user uses the app to take a selfie with a smile or a frown to indicate whether the presentation was good, not so good or somewhere in between. For example, if the user submitted a picture that looks like this:</p><p><img src="http://i.imgur.com/QPF0LI8.png" alt="Evaluation"></p><p>The cognitive result might look like this:</p><p><img src="http://i.imgur.com/0U4IaRH.png" alt="Cognitive Result"></p><p>and the result will be pushed in real-time to a PowerBI dashboard:</p><p><img src="http://i.imgur.com/XvnGaVs.png" alt="PowerBI"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="xamarin-app"></a>Xamarin App<a class="hash-link" href="#xamarin-app" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="taking-a-camera-picture"></a>Taking a Camera picture<a class="hash-link" href="#taking-a-camera-picture" title="Direct link to heading">#</a></h3><p>Using VS for mac, I created a blank XAML forms app solution with Android and iOS. Added the following Xamarin plugin to all of its projects (portable, iOS and Droid):</p><ul><li>Xam.Plugin.Media</li></ul><p>This allows me to use the Camera without having to deal with iOs or Android. I wrote the following simple XAML in the main page:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ContentPage xmlns=&quot;http://xamarin.com/schemas/2014/forms&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xmlns:x=&quot;http://schemas.microsoft.com/winfx/2009/xaml&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        xmlns:local=&quot;clr-namespace:PresentationEvaluation&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        x:Class=&quot;PresentationEvaluation.PresentationEvaluationPage&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;StackLayout&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;Button x:Name=&quot;btnTakePicture&quot; Clicked=&quot;btnTakePicture_Clicked&quot; Text=&quot;Take selfie with emotion&quot;/&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;ActivityIndicator x:Name=&quot;Indicator&quot; Color=&quot;Black&quot;/&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;StackLayout x:Name=&quot;ResultPanel&quot; Padding=&quot;10&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;Image x:Name=&quot;Image&quot; HeightRequest=&quot;240&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;StackLayout x:Name=&quot;Age&quot; Orientation=&quot;Horizontal&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Label&gt;Age&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Label x:Name=&quot;AgeData&quot;&gt;&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;/StackLayout&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;StackLayout x:Name=&quot;Gender&quot; Orientation=&quot;Horizontal&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Label&gt;Gender&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Label x:Name=&quot;GenderData&quot;&gt;&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;/StackLayout&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;StackLayout x:Name=&quot;Smile&quot; Orientation=&quot;Horizontal&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Label&gt;Smile&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Label x:Name=&quot;SmileData&quot;&gt;&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;/StackLayout&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;Label x:Name=&quot;Result&quot;&gt;&lt;/Label&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;/StackLayout&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;/StackLayout&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ContentPage&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and I had this in the behind code:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">namespace PresentationEvaluation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public partial class PresentationEvaluationPage : ContentPage</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public PresentationEvaluationPage()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            InitializeComponent();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ResultPanel.IsVisible = false;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private async void btnTakePicture_Clicked(object sender, EventArgs e)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await CrossMedia.Current.Initialize();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (!CrossMedia.Current.IsCameraAvailable || !CrossMedia.Current.IsTakeVideoSupported)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    throw new Exception($&quot;There is no camera on the device!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var file = await CrossMedia.Current.TakePhotoAsync(new Plugin.Media.Abstractions.StoreCameraMediaOptions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    SaveToAlbum = true,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    Name = &quot;SelfieEvaluation.jpg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (file == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    throw new Exception($&quot;Picture not captured to disk!!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Image.Source = ImageSource.FromStream(() =&gt; file.GetStream());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                //TODO: Do something with the image </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await DisplayAlert(&quot;Sorry&quot;, &quot;An error occurred: &quot; + ex.Message, &quot;Ok&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            finally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="communicating-with-cognitive"></a>Communicating with Cognitive<a class="hash-link" href="#communicating-with-cognitive" title="Direct link to heading">#</a></h3><p>Now that we got the picture from the Camera, I wanted to send it to Azure Cognitive to detect the age, gender and smile. I added some NuGet packages:</p><ul><li>Microsoft.Net.Http</li><li>Newton.Json</li></ul><p>First I had to convert the media image file to an array of bytes:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static byte[] GetBytes(MediaFile file)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    byte[] fileBytes = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using (var ms = new MemoryStream())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        file.GetStream().CopyTo(ms);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        file.Dispose();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fileBytes = ms.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return fileBytes;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Then submitted to the congnitive APIs:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        byte[] picture = GetBytes(file);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        float age = -1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string gender = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        float smile = -1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Submit to Cognitive</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var httpClient = new HttpClient())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            httpClient.DefaultRequestHeaders.Add(&quot;Ocp-Apim-Subscription-Key&quot;, &quot;get-your-own&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            HttpResponseMessage response;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var content = new ByteArrayContent(picture);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            content.Headers.ContentType = new MediaTypeHeaderValue(&quot;application/octet-stream&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            response = await httpClient.PostAsync(FacialApi, content);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string responseData = await response.Content.ReadAsStringAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (!response.IsSuccessStatusCode)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;Unable to post to cognitive service: {response.StatusCode.ToString()}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Face[] faces = JsonConvert.DeserializeObject&lt;Face[]&gt;(responseData);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (faces != null &amp;&amp; faces.Length &gt; 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Face face = faces[0];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                age = face.faceAttributes.age;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                gender = face.faceAttributes.gender;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                smile = face.faceAttributes.smile;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where the Face classes are defined as follows (I just special pasted the docs JSON example into my Visual Studio to create these classes):</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Face</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public string faceId { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public Facerectangle faceRectangle { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public Faceattributes faceAttributes { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public string glasses { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public Headpose headPose { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Facerectangle</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public int width { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public int height { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public int left { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public int top { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Faceattributes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public float age { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public string gender { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public float smile { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public Facialhair facialHair { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Facialhair</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public float mustache { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public float beard { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public float sideburns { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class Headpose</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public float roll { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public int yaw { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public int pitch { get; set; }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Because I have a free cognitive account and I could be throttled, I created a randomizer to generate random values in case i don&#x27;t wato to use the cognitive functions for testing. So I created a flag that I can change whenever I want to test without cognitive:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Submit to Cognitive</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (IsCognitive)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ///same as above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    gender = genders.ElementAt(random.Next(genders.Count - 1));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    age = ages.ElementAt(random.Next(ages.Count - 1));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    smile = smiles.ElementAt(random.Next(smiles.Count - 1));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="powerbi"></a>PowerBI<a class="hash-link" href="#powerbi" title="Direct link to heading">#</a></h3><p>Once I get the result back from the cognitive function, I create a real time event (and refer to the smile range as score after I multiply it by 10) and send it to <a href="https://powerbi.microsoft.com/en-us/documentation/powerbi-service-real-time-streaming/" target="_blank" rel="noopener noreferrer">PowerBI real-time</a> very useful feature which displays visualizations in real-time:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">using (var httpClient = new HttpClient())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var realTimeEvent = new</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        time = DateTime.Now,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        age = (int)age,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        score = (int)(smile * 10),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        gender = gender</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var data = new dynamic[1];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    data[0] = realTimeEvent;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var postData = JsonConvert.SerializeObject(data);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpContent httpContent = new StringContent(postData, Encoding.UTF8, &quot;application/json&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpResponseMessage response = await httpClient.PostAsync(PowerBIApi, httpContent);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string responseString = await response.Content.ReadAsStringAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (!response.IsSuccessStatusCode)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        throw new Exception(&quot;Unable to post to PowerBI: &quot; + response.StatusCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>where PowerBIApi is the real-time API that you must post it. You will get this from PowerPI service when you create your own Real-Time dataset.</p><p>This allows people to watch the presentation evaluation result in real-time:</p><p><img src="http://i.imgur.com/XvnGaVs.png" alt="PowerBI"></p><p>That was a nice exercise! I liked the ease of developing stuff in Xamarin forms as it shields me almost completely from Android and iOS. Visual Studio for mac (in preview), however, has a lot of room of improvement...it feels heavy, clunky and a bit buggy. Finally I would like to say that, in non-demo situations, it is probably better to send the picture to an Azure storage which will trigger an Azure Function that will send to cognitive and PowerBI. </p><p>The code is available in GitHub <a href="https://github.com/khaledhikmat/presentation-evaluation" target="_blank" rel="noopener noreferrer">here</a></p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/xamarin">Xamarin</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/09/09/aspnet-core-file-return">Return a file in ASP.NET Core from a Web API</a></h2><div class="margin-vert--md"><time datetime="2016-09-09T00:00:00.000Z" class="blogPostDate_Ta7i">September 9, 2016  Â· 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>In ASP .NET 4.x, I had this code to return a file from an ASP.NET Web API. This worked well and allowed a client-side JavaScript client to download the file with a progress indicator:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Route(&quot;api/some/file&quot;, Name = &quot;SomeFile&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;HttpResponseMessage&gt; GetFile()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var error = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //TODO: Get the file in a string called contentData</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        MemoryStream stream = new MemoryStream();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        StreamWriter writer = new StreamWriter(stream);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        writer.Write(contentData);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        writer.Flush();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        stream.Position = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var result = new HttpResponseMessage(HttpStatusCode.OK)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Content = new StreamContent(stream)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        result.Content.Headers.ContentType = new MediaTypeHeaderValue(&quot;application/octet-stream&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        result.Content.Headers.ContentLength = stream.Length;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        result.Content.Headers.ContentDisposition = new ContentDispositionHeaderValue(&quot;attachment&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FileName = &quot;content.json&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Size = stream.Length</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception e)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // The tag = ControllerName.RouteName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        error = e.Message;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: do something with the error</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return new HttpResponseMessage(HttpStatusCode.BadRequest);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Recently I created a new ASP.NET Core project for some other purpose which also had a requirement to download a file from a Web API. So naturally I copied the same code over. But that did not work...I end up getting the result in JSON....it looks something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-json codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;version&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;major&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;minor&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;build&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;revision&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;majorRevision&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;minorRevision&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> - </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;content&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token property">&quot;headers&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;key&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Content-Type&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;application/octet-stream&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;key&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Content-Length&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2346262&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;key&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Content-Disposition&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token property">&quot;value&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;attachment; filename=content.json; size=2346262&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;statusCode&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;reasonPhrase&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;OK&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;headers&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;requestMessage&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token null keyword" style="font-style:italic">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token property">&quot;isSuccessStatusCode&quot;</span><span class="token operator" style="color:rgb(137, 221, 255)">:</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>After several attempts, I eventually I found out that this below code works well in ASP.NET Core and my JavaScript is able to show a download progress bar:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Route(&quot;api/some/file&quot;, Name = &quot;SomeFile&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;HttpResponseMessage&gt; GetFile()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var error = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        //TODO: Get the file in a string called contentData</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpContext.Response.ContentType = &quot;application/json&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpContext.Response.ContentLength = Encoding.ASCII.GetBytes(contentData).Length;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpContext.Response.Headers[&quot;Content-Disposition&quot;] = new ContentDispositionHeaderValue(&quot;attachment&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FileName = &quot;content.json&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Size = HttpContext.Response.ContentLength</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpContext.Response.Headers[&quot;Content-Length&quot;] = &quot;&quot; + HttpContext.Response.ContentLength;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        FileContentResult result = new FileContentResult(Encoding.ASCII.GetBytes(contentData), &quot;application/octet-stream&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            FileDownloadName = &quot;content.json&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception e)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Handle error</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpContext.Response.StatusCode = 400;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I hope this tip helps someone!</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/asp-net">ASP.NET</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/04/30/kicking-powerapps-tires">Kicking PowerApps Tires</a></h2><div class="margin-vert--md"><time datetime="2016-04-30T00:00:00.000Z" class="blogPostDate_Ta7i">April 30, 2016  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>PowerApps is a newly released platform/service to build Line-of-business applications from Microsoft. Reading some documentation and attending some online webcasts, I think the PowerApps product is well positioned for LOB! There is definitely a need to create LOB mobile apps at the enterprise level and distribute them seamlessly without the friction of the app stores.</p><p>The thing is that the last two (at least) platforms that Microsoft created to build LOB applications were eventually abandoned i.e. SilverLight and LightSwitch. Hence there could be some resistance from some developers to start learning this new platform knowing that it might also have the same fate as its predecessors. However, from the first couple of hours that I spent on PowerApps, it seems to be a very capable environment and really easy to do stuff in. So I wanted to show off a very simple app that demonstrates some simple but important capabilities. </p><p>Another thing to note is that although, at the time of writing, the product had just made it to public preview from a gated preview, the <a href="https://powerapps.microsoft.com/en-us/tutorials/getting-started/" target="_blank" rel="noopener noreferrer">documentation</a> looks really complete and actually quite good. There also seems to be strong and engaging community!!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="simple-app"></a>Simple App<a class="hash-link" href="#simple-app" title="Direct link to heading">#</a></h3><p>I am building an app that presents tabular sales data to users and allows them to drill through the hierarchical nature of the data. For example, at the top level, users will see sales data for different regions and then can drill down to see the sales data for individual countries:</p><p><img src="http://i.imgur.com/Lz0ydEr.png" alt="Hierarchy Sales Data"></p><p>So I wanted the ability to navigate to the same screen in PowerApps but with different data. The sample then shows how I solved this particular problem in PowerApps.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="navigation-scheme"></a>Navigation Scheme<a class="hash-link" href="#navigation-scheme" title="Direct link to heading">#</a></h3><p>I created two screens: the first is an initial page to present the users certain options and allows them to start viewing the sales data and the second one is the sales data screen that will be navigated to and from in order to view the drill through sales data.</p><p>In order to manage the navigation, I created a Stack collection (in PowerApps it is called a collection...but it is like a table) that holds the navigation history of each screen. Upon initial navigation from the initial screen, I clear the collection. When the user drills down, I push (i.e. add) to the collection the screen id of the screen that I just navigated from. When the user drills up, I pop (i.e. remove the last item) from the collection the screen id that I must navigate to. For this app, the only column that I have in this collection is the screen id:</p><p><img src="http://i.imgur.com/Ky1EmUL.png" alt="Navigation Scheme"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="initial-screen"></a>Initial Screen<a class="hash-link" href="#initial-screen" title="Direct link to heading">#</a></h3><p>In PowerApps studio, this is how the initial screen looks like:</p><p><img src="http://i.imgur.com/XKmqkp5.png" alt="Initial Screen"></p><p>So when the user taps the initial drill down icon, the following script is executed:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Clear(Stack); Navigate(Screen2, ScreenTransition.Fade, {Screen:{Id: 1}})</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This script consists of 3 main things:</p><ul><li><code>Clear(Stack);</code> clears the navigation collection that I named <code>Stack</code>.</li><li><code>Navigate(Screen2, ScreenTransition.Fade, {Screen:{Id: 1}})</code> navigates to screen2 (which is the data screen) with a fade</li><li><code>{Screen:{Id: 1}}</code> adds a context variable called <code>Screen</code> with a single column called <code>Id</code> that contains the value 1 i.e. Level 1   </li></ul><p>This <a href="https://powerapps.microsoft.com/en-us/tutorials/function-updatecontext/" target="_blank" rel="noopener noreferrer">context variable</a> is short-lived as it is only available within the boundary of a single screen. I use it to pass the screen id from one screen to another.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="data-screen---drill-down"></a>Data Screen - Drill Down<a class="hash-link" href="#data-screen---drill-down" title="Direct link to heading">#</a></h3><p>In PowerApps studio, the data screen drill down looks like this:</p><p><img src="http://i.imgur.com/qnQjFwz.png" alt="Data Screen Drill Down"></p><p>So when the user taps the drill down icon, the following script is executed:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Collect(Stack, {Id: Screen.Id}); Navigate(Screen2, ScreenTransition.Fade, {Screen:{Id: Last(Stack).Id + 1}})</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This script consists of 3 main things:</p><ul><li><code>Collect(Stack, {Id: Screen.Id});</code> adds (i.e. collects in PowerApps terminology) the screen id that was passed from the initial screen or the screen that I navigated from. The collection stores the screen ID. </li><li><code>Navigate(Screen2, ScreenTransition.Fade, {Screen:{Id: Last(Stack).Id + 1}})</code> navigates to the same screen (screen2) with a fade</li><li><code>{Screen:{Id: Last(Stack).Id + 1}}</code> adds a context variable called <code>Screen</code> with a single column called <code>Id</code> that contains the value of the last item in the Stack i.e. <code>Last(Stack).Id</code> plus one! This what makes the context variable so powerful.   </li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="data-screen---drill-up"></a>Data Screen - Drill Up<a class="hash-link" href="#data-screen---drill-up" title="Direct link to heading">#</a></h3><p>In PowerApps studio, the data screen drill up looks like this:</p><p><img src="http://i.imgur.com/S1buIWP.png" alt="Data Screen Drill Up"></p><p>So when the user taps the drill up icon, the following script is executed:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Navigate(Screen2, ScreenTransition.Fade, {Screen:{Id: Last(Stack).Id}}); Remove(Stack, Last( Stack))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This script consists of 3 main things:</p><ul><li><code>Navigate(Screen2, ScreenTransition.Fade, {Screen:{Id: Last(Stack).Id}});</code> navigates to the same screen (screen2) with a fade</li><li><code>{Screen:{Id: Last(Stack).Id}}</code> adds a context variable called <code>Screen</code> with a single column called <code>Id</code> that contains the value of the last item in the Stack i.e. <code>Last(Stack).Id</code>. </li><li><code>Remove(Stack, Last( Stack))</code> removes the last item from the Stack! Effectively we are doing a pop.   </li></ul><p>In order to prevent un-supported drill ups, the drill up icon has a visibility property that is controlled by the following script:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">If (CountRows(Stack) &gt; 0, true)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>So as long as there are items in the Stack collection, the drill-up icon is visible. </p><p>I hope this is a helpful short post to show how powerful and useful PowerApps can be. I am hoping to be able to add more posts about PowerApps in future posts.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/power-apps">PowerApps</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/04/25/open-azure-vm-port">Open Azure VM Port</a></h2><div class="margin-vert--md"><time datetime="2016-04-25T00:00:00.000Z" class="blogPostDate_Ta7i">April 25, 2016  Â· 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>For a project I was working on, I needed to create a Windows VS2015 VM for testing. It is quit easy to spawn a VM in Azure ...it only takes a couple of seconds to do it from the portal. The next task was to open up port 8080 on that machine as I needed to access that port for testing.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="windows-server-2012"></a>Windows Server 2012<a class="hash-link" href="#windows-server-2012" title="Direct link to heading">#</a></h3><p>Since the VM is a Windows Server 2012, all I needed to do is to go the server&#x27;s Server Manager =&gt; Local Server and access the Windows Firewall. At the firewall, I access the advanced setting to add a new inbound rule for protocol type TCP and local port is 8080:</p><p><img src="http://i.imgur.com/gqnnSyV.png" alt="Inbound Rule"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-endpoints"></a>Azure Endpoints<a class="hash-link" href="#azure-endpoints" title="Direct link to heading">#</a></h3><p>The above step is not enough to expose port 8080! What we also need is to let the VM&#x27;s Network Security Group about this new endpoint that we want to allow. To do that, you also need to locate the VM&#x27;s Resource Group. The new ARM-based Azure VMs have several things in the resource group:</p><ul><li>Virtual Machine</li><li>Network Interface</li><li>Network Security Group</li><li>Public IP Address</li><li>Virtual Network</li><li>Storage Account</li></ul><p>We access the Network Security Group:</p><p><img src="http://i.imgur.com/VIJyh6U.png" alt="Network Security Group"></p><p>and add the Inbound Rule for port 8080:</p><p><img src="http://i.imgur.com/Pi32vAf.png" alt="NSG Inbound Rule"></p><p>This will allow us to access port 8080 in the VM.</p><p>Please note that the instructions above are for the Azure ARM-based VMs...not the classic ones.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/windows">Windows</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/02/19/asp-net-api-versioning">ASP.NET API Versioning</a></h2><div class="margin-vert--md"><time datetime="2016-02-19T00:00:00.000Z" class="blogPostDate_Ta7i">February 19, 2016  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>A while back, I created an ASP.NET Web API 2 to be a back-end for a mobile app. I used basic authentication to make it easier for mobile apps to consume the Web API. I now decided to provide better security so I wanted to move to a token-based authentication. The problem is that if I change the Web API to a token-based, all existing mobile apps in the field will not function as they will be refused Web API connection. </p><p>The answer is to use Web API versioning! This way existing mobile users can continue to use the current version that uses basic authentication until the app is upgraded. The updated app version will switch over to use the new version which is based on token authentication. This post will discuss how I accomplished this versioning scheme.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="controller-selector"></a>Controller Selector<a class="hash-link" href="#controller-selector" title="Direct link to heading">#</a></h2><p>The first step is to configure the ASP.NET framework to use a custom controller selector. In the <code>WebApiConfig</code> <code>Register</code> method, we tell the framework to use the custom selector:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">config.Services.Replace(typeof(IHttpControllerSelector), new VersionAwareControllerSelector(config));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The selector is coded as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class VersionAwareControllerSelector : DefaultHttpControllerSelector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private const string VERSION_HEADER_NAME = &quot;some-value&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private const string VERSION_QUERY_NAME = &quot;v&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private HttpConfiguration _configuration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public VersionAwareControllerSelector(HttpConfiguration configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        : base(configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _configuration = configuration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // This works for Web API 2 and Attributed Routing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // FROM: http://stackoverflow.com/questions/19835015/versioning-asp-net-web-api-2-with-media-types/19882371#19882371</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // BLOG: http://webstackoflove.com/asp-net-web-api-versioning-with-media-types/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public override HttpControllerDescriptor SelectController(HttpRequestMessage request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpControllerDescriptor controllerDescriptor = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Get a list of all controllers provided by the default selector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        IDictionary&lt;string, HttpControllerDescriptor&gt; controllers = GetControllerMapping();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        IHttpRouteData routeData = request.GetRouteData();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (routeData == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            throw new HttpResponseException(HttpStatusCode.NotFound);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Pick up the API Version from the header...but we could also do query string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var apiVersion = GetVersionFromHeader(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Check if this route is actually an attribute route</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        IEnumerable&lt;IHttpRouteData&gt; attributeSubRoutes = routeData.GetSubRoutes();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (attributeSubRoutes == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string controllerName = GetRouteVariable&lt;string&gt;(routeData, &quot;controller&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (controllerName == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new HttpResponseException(HttpStatusCode.NotFound);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string newControllerName = String.Concat(controllerName, apiVersion);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (controllers.TryGetValue(newControllerName, out controllerDescriptor))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return controllerDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new HttpResponseException(HttpStatusCode.NotFound);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string newControllerNameSuffix = String.Concat(&quot;V&quot;, apiVersion); ;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IEnumerable&lt;IHttpRouteData&gt; filteredSubRoutes = attributeSubRoutes.Where(attrRouteData =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                HttpControllerDescriptor currentDescriptor = GetControllerDescriptor(attrRouteData);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                bool match = currentDescriptor.ControllerName.EndsWith(newControllerNameSuffix);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (match &amp;&amp; (controllerDescriptor == null))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    controllerDescriptor = currentDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return match;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            routeData.Values[&quot;MS_SubRoutes&quot;] = filteredSubRoutes.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return controllerDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private HttpControllerDescriptor GetControllerDescriptor(IHttpRouteData routeData)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return ((HttpActionDescriptor[])routeData.Route.DataTokens[&quot;actions&quot;]).First().ControllerDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get a value from the route data, if present.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private static T GetRouteVariable&lt;T&gt;(IHttpRouteData routeData, string name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        object result = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (routeData.Values.TryGetValue(name, out result))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (T)result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return default(T);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private string GetVersionFromHeader(HttpRequestMessage request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (request.Headers.Contains(VERSION_HEADER_NAME))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var header = request.Headers.GetValues(VERSION_HEADER_NAME).FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (header != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return header;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return &quot;1&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private string GetVersionFromQueryString(HttpRequestMessage request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var query = HttpUtility.ParseQueryString(request.RequestUri.Query);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var version = query[VERSION_QUERY_NAME];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (version != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return version;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return &quot;1&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As demonstarted above, I chose to send the version information as a header value! There are other options ...one of them is to pass it in the query string such as <code>http://example.com/api/stats?v=2</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="controller-versions"></a>Controller Versions<a class="hash-link" href="#controller-versions" title="Direct link to heading">#</a></h2><p>The above allows us to have versioned controllers with the following naming convention:</p><p><img src="http://i.imgur.com/5jxk3S5.png" alt="Controller Versions"></p><p>The framework will pick version 1 (i.e. <code>StatsV1Controller</code>) by default unless the request&#x27;s header contains a version header value. If the value is 2, then <code>StatsV2Controller</code> will be picked.</p><p>The V1 controller is defined this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[BasicAuthorize()]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class StatsV1Controller : ApiController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/stats&quot;, Name = &quot;Stats&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public virtual IHttpActionResult GetStats()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>while the V2 controller is defined this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[TokenAuthorize()]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class StatsV2Controller : StatsV1Controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/stats&quot;, Name = &quot;StatsV2&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public override IHttpActionResult GetStats()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return base.GetStats();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>The V1 controller uses basic authorization (as decorated by the attribute on top of the controller class) and V2 uses token authentication as decorated. </li><li>The V2 controller inherits from the V1 controller so there is no need to re-implement the methods.</li><li>However, there is a need to supply a different route name for the V2 controller otherwise we will get a conflict. This is done by giving the V2 controller a route name that ends with V1 i.e. StatsV2. This is a little unfortunate but this is how it is. Had it not been for this, we could have simply inherited from V1 without having to repeat any method.</li><li>Since V2 inherits from V1, I noticed that both authentication filters run per request. This means that when V2 is picked, the token authorize filer will run first and then followed by the basic authorize filter. This can cause problems. So what I did is at the end of the token authorize filter, I inject a value in the request properties. In the basic authorize filter, I check if the value exists, and, it if it does, I abort the basic authorize filter since the token filter has already run.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="request-property"></a>Request Property<a class="hash-link" href="#request-property" title="Direct link to heading">#</a></h2><p>Here is one way to inject a property in the request in the token filter:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">actionContext.Request.Properties[&quot;some-key&quot;] = &quot;some-value&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Then in the basic filter, I check for this property existence. If it does exist, it means the request is authenticated and there is no need to perform basic authentication.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">string accessToken;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (!actionContext.Request.Properties.TryGetValue(&quot;sone-key&quot;, out accessToken))            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I hope someone finds this post helpful. Having multiple versions has provided me with a way to transition my mobile app users from basic authentication to token authentication without breaking the existing mobile apps.
</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/asp-net">ASP.NET</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/a6aa9e1f.f048fb53.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/35569fa2.61750228.js"></script>
<script src="/ec66d46e.bae7aea3.js"></script>
<script src="/4be9694a.f3e9695f.js"></script>
<script src="/8b38971f.bbacab40.js"></script>
<script src="/2a82850d.6052dc04.js"></script>
<script src="/b796d8fd.35fe7267.js"></script>
<script src="/0532bc6e.31fdf76f.js"></script>
<script src="/8eb4e46b.2f728d47.js"></script>
</body>
</html>