<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">Blog | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="Blog | Coding Thoughts"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/a6aa9e1f.f048fb53.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/94e919bf.0a3e419d.js" as="script">
<link rel="preload" href="/bee94a88.4fc3e9d9.js" as="script">
<link rel="preload" href="/c39f8217.edeb2472.js" as="script">
<link rel="preload" href="/5aee77e7.26a47450.js" as="script">
<link rel="preload" href="/f2741b72.6222c6ed.js" as="script">
<link rel="preload" href="/d60bfb02.3b07197f.js" as="script">
<link rel="preload" href="/e6152ae6.2517b391.js" as="script">
<link rel="preload" href="/55951e93.320cea7e.js" as="script">
<link rel="preload" href="/e054a98d.5d410ab7.js" as="script">
<link rel="preload" href="/22c51f25.c28260cd.js" as="script">
<link rel="preload" href="/b2b675dd.99e7d1db.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk"></span></div><div class="react-toggle-track-x"><span class="toggle_3NWk"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></h2><div class="margin-vert--md"><time datetime="2018-01-06T00:00:00.000Z" class="blogPostDate_Ta7i">January 6, 2018  路 4 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>Having been exposed to <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a> and <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-overview" target="_blank" rel="noopener noreferrer">Microsoft&#x27;s Service Fabric</a>, the following are some of my notes about both platforms:</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="similarities"></a>Similarities<a class="hash-link" href="#similarities" title="Direct link to heading">#</a></h2><p>They are both orchestrators and pretty much can handle: </p><ul><li>Container Images Hosting</li><li>Scaling</li><li>Healing</li><li>Monitoring</li><li>Rolling Updates</li><li>Service Location</li></ul><p>However, Service Fabric support for containers came recently. Initially, Azure Service Fabric was mostly an orchestrator for .NET processes running Windows only. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="strengths"></a>Strengths<a class="hash-link" href="#strengths" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kubernetes"></a>Kubernetes:<a class="hash-link" href="#kubernetes" title="Direct link to heading">#</a></h4><p>In 2017, k8s became an industry standard. Every Cloud vendor offers full support and some offer Kubernetes as a Service such as Azure Kubernetes Service (AKS) where the vendor takes care of the cluster creation, maintenance and management.</p><p>Given this, it became obvious that if any business is planning to adopt Microservices as a developmemt strategy, they are most likely thinking about employing Kubernetes. Managed services offered by many Cloud vendors such as Azure AKS makes this decison a lot easier as dvelopers no longer have to worry about provisioning or maintaining k8s clusters.  </p><p>Besides the huge developer and industry support that it is currently receiving, K8s is a joy to work with. Deployments can be described in yaml or json and thrown at the cluster so it can make sure that the desired state is realized. Please refer to <a href="/blog/2018/01/04/netapp-docker-k8s">this post</a> for more information. </p><p>Not sure about these:</p><ul><li>Can k8s create singletons?</li><li>Can I have multiple depoyments of the same Docker instance with different enviroment variables?</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="service-fabric"></a>Service Fabric:<a class="hash-link" href="#service-fabric" title="Direct link to heading">#</a></h4><p>In my opinion, one of the most differentiating factor for Service Fabric is its developer-friendly programming model. It supports reliable stateless, stateful and actor models in a powerful yet abstracted way which makes programming in Service Fabric safe and easy. Please refer to earlier posts <a href="/blog/2016/12/15/service-fabric-fundamentals">here</a> and <a href="/blog/2017/01/10/service-fabric-notes">here</a> for more information. </p><p>In addition, Service Fabric supports different ways to host code:</p><ul><li>Guest Executable i.e. unmodified Win32 applications or services</li><li>Guest Windows and Linux containers</li><li>Reliable stateless and stateful services in .NET C#, F# and Java</li><li>Reliable actors in .NET C#, F# and Java</li></ul><p>The concept of app in Service Fabric is quite sophisticated allowing developers to create an app type and instantiate many copies of it making the concept work well in multi-tenant deployments. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="weaknesses"></a>Weaknesses<a class="hash-link" href="#weaknesses" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kubernetes-1"></a>Kubernetes:<a class="hash-link" href="#kubernetes-1" title="Direct link to heading">#</a></h4><p>I am not in a position to state any weaknesses for k8s. But, from (perhaps) a very naive perspective, I would say that:</p><ul><li>The lack of standard programming models is definitely something that can be improved.</li><li>K8s can only work with containers! So any piece of code that must deployed to k8s must be containerized first. </li><li>Currently k8s is only a Linux orchestrator. Although a beta 1.9 version is said to support Windows containers. </li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="service-fabric-1"></a>Service Fabric<a class="hash-link" href="#service-fabric-1" title="Direct link to heading">#</a></h4><p>One of the major setbacks for Service Fabric (or at least the public version that was made available) is that it was conceived at a time when k8s is burgeoning into an industry standard. It is becoming very difficult for Microsoft to convince developers and businesses to adopt this semi-proprieytary platform when they can use k8s. </p><p>There are also a couple of things that can be improved:</p><ul><li>Service Fabric relies on XML documents to describe services and configuration.</li><li>Reliance on Visual Studio although it is possible to do things in Service Fabric without Visual Studio as demonstrated <a href="/blog/2016/12/02/service-fabric-basics">here</a> </li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="future"></a>Future<a class="hash-link" href="#future" title="Direct link to heading">#</a></h2><p>I love Service Fabric! But unfortunately (I say unfortyantely because I actually did spend a lot of time on it), I don&#x27;t think it has a particularly great future given the strength and the momentum of k8s. Ideally Microsoft should continue to suppprt k8s in a strong way, perhaps port its Service Fabric programming model to work on k8s using .NET Core and eventually phase out Service Fabric.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/service-fabric">Service Fabric</a><a class="margin-horiz--sm" href="/blog/tags/kubernetes">Kubernetes</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></h2><div class="margin-vert--md"><time datetime="2018-01-04T00:00:00.000Z" class="blogPostDate_Ta7i">January 4, 2018  路 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I wanted to assess Azure Cosmos DB to see possibilities of converting some of our backend applications to use this database technology to provide a globally distributed database that we desperately need as our services now cover a bigger geographic location. However, this post is not about Cosmos DB specifically! It is mainly about notes about the architecture of the pieces that surround Cosmos and how I am thinking to implement them.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="macro-architecture"></a>Macro Architecture<a class="hash-link" href="#macro-architecture" title="Direct link to heading">#</a></h2><p>This is how I imagines our system to look like:</p><p><img alt="Avalon Macro Architecture" src="/assets/images/avalon-architecture-4ebd1ec1a7a88f773c346fb24690235d.png"></p><p>In this post, I would like to concentrate only on the components that are boxed in orange. Namely, the Web API layer and the two processors.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-app-service-docker--kubernetes"></a>Azure App Service, Docker &amp; Kubernetes<a class="hash-link" href="#azure-app-service-docker--kubernetes" title="Direct link to heading">#</a></h2><p>We have been using Azure App Service for a while and we are happy with it. We have experience in managing it, scaling it and configuring it. I did not want to change that. So I decided to continue to use Azure App Service to host our Web API layer which will be written in .NET Core. This layer communicates with Cosmos DB to provide a multi-regional access to our customers. </p><p>I wanted to monitor Cosmos DB changes to launch different Microservices in the form of Azure Functions, Logic Apps or other processes. I could use Azure Functions to track the Cosmos DB changes but I decided to write my own little .NET Core stand-alone Console app using the Microsoft Change Feed library which makes things quite easy.</p><p>Normally, I use WebJobs to handle queue processing and I do have a lot of experience with this. However, in .NET Core, the deployment of a WebJob is not very clear to me so I decided to write a stand-alone console app based on WebJobs SDK but can be deployed somewhere else.</p><p>To host and deploy the two stand-alone .NET core console apps i.e. Change Feeder and Queue Processor, opted to make them Docker images and deploy them to a Kubernetes cluster.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="containerizing-the-webjobs-console-app"></a>Containerizing the WebJobs Console App<a class="hash-link" href="#containerizing-the-webjobs-console-app" title="Direct link to heading">#</a></h2><p>I based my code on this <a href="http://matt-roberts.me/azure-webjobs-in-net-core-2-with-di-and-configuration/" target="_blank" rel="noopener noreferrer">blog post by Matt Roberts</a>. My solution has several projects...but two are important for this step: <code>AvalonWebJobs</code> and <code>AvalonWebDal</code>. <code>AvalonWebDal</code> is a class library that has common functionality that I depend on. I used the following Docker file to build the WebJobs console app:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-sdk as build</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY . .</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonWebDal</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonWebJobs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet publish --output /output --configuration Release</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-runtime</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY --from=build /output /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENTRYPOINT [ &quot;dotnet&quot;, &quot;AvalonWebJobs.dll&quot; ]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I used the following Docker command to build the image:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker build --file docketfile.webjobs --no-cache -t avalonwebjobs .</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following to test locally:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker run --rm -ti avalonwebjobs</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="containerizing-the-change-feeder-app"></a>Containerizing the Change Feeder App<a class="hash-link" href="#containerizing-the-change-feeder-app" title="Direct link to heading">#</a></h2><p>I based my code on this <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/change-feed#change-feed-processor" target="_blank" rel="noopener noreferrer">documentation post by Microsoft</a>. My solution has several projects...but two are important for this step: <code>AvalonChangeFeeder</code> and <code>AvalonWebDal</code>. <code>AvalonWebDal</code> is a class library that has common functionality that I depend on. I used the following Docker file to build the WebJobs console app:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-sdk as build</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY . .</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonWebDal</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app/AvalonChangeFeeder</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet restore</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">RUN dotnet publish --output /output --configuration Release</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FROM microsoft/dotnet:2.0-runtime</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COPY --from=build /output /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ENTRYPOINT [ &quot;dotnet&quot;, &quot;AvalonChangeFeeder.dll&quot; ]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I used the following Docker command to build the image:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker build --file docketfile.changefeeder --no-cache -t avalonchangefeeder .</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following to test locally:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker run --rm -ti avalonchangefeeder</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><strong>Important note:</strong></p><p>Make sure that the <code>.csproj</code> project file contains the following item groups so that the appsettings will be available in the container. Failure to do so will cause an error message <code>unable to find appsettngs.json and it is not optional</code>:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ItemGroup&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;None Remove=&quot;appsettings.json&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/ItemGroup&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;ItemGroup&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Content Include=&quot;appsettings.json&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &lt;CopyToPublishDirectory&gt;PreserveNewest&lt;/CopyToPublishDirectory&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;/Content&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/ItemGroup&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kubernetes"></a>Kubernetes<a class="hash-link" href="#kubernetes" title="Direct link to heading">#</a></h2><p>I used <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough" target="_blank" rel="noopener noreferrer">this documentation link</a> to spawn a test 1-node k8s cluster in Azure. The process is really simple and quick. I tagged and published my two container images to an Azure Container Registry using <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-get-started-azure-cli" target="_blank" rel="noopener noreferrer">this documentaion link</a>.</p><p>Now time to actually deploy to the k8s cluster. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployments"></a>Deployments<a class="hash-link" href="#deployments" title="Direct link to heading">#</a></h3><p>Becasue I wanted to scale the two web jobs and the change feeder separately, I opted to create two deployments: one for the web jobs and another for the change feeder. Alternatively, I could have used a two-pod deployment but this will have meant that my two containers will need to be scaled the same since the unit of scaling in k8s is the deployment ...not the pod. Please refer to <a href="https://stackoverflow.com/questions/43217006/kubernetes-multi-pod-deployment" target="_blank" rel="noopener noreferrer">this stack overflow issue</a> for more information.</p><p>I used the following <code>.yml</code> file for the WebJobs k8s deployment:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: extensions/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: avalon-webjobs-deploy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  replicas: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  minReadySeconds: 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  strategy:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type: RollingUpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rollingUpdate:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxUnavailable: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxSurge: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  template:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app: avalon-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - name: avalon-webjobs-pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        image: avalonacr.azurecr.io/avalonwebjobs:v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        imagePullPolicy: Always</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following <code>kubectl</code> command to deploy:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create -f avalon-webjobs-app.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I used the following <code>.yml</code> file for the Change feeder k8s deployment:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: extensions/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: avalon-changefeeder-deploy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  replicas: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  minReadySeconds: 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  strategy:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type: RollingUpdate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    rollingUpdate:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxUnavailable: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      maxSurge: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  template:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app: avalon-app</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - name: avalon-changefeeder-pod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        image: avalonacr.azurecr.io/avalonchangefeeder:v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        imagePullPolicy: Always</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the following <code>kubectl</code> command to deploy:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create -f avalon-changefeeder-app.yml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="observations"></a>Observations<a class="hash-link" href="#observations" title="Direct link to heading">#</a></h3><p>Initialy I set the number of replicas to one so I can make sure that everything is running well before I scale the k8s deployments.</p><p>After the deployment as above, I used <code>kubectl get pods</code> to see the status of the nodes. I noticed that the webjobs pod is in <code>running</code> state (which is desired) while the change feeder container is in <code>CrashLoopBackOff</code> state. Humm....after some reasearch, I found <a href="https://stackoverflow.com/questions/41604499/my-kubernetes-pods-keep-crashing-with-crashloopbackoff-but-i-cant-find-any-lo" target="_blank" rel="noopener noreferrer">this helpful stack overflow issue</a>. So I used the following command to see the actual console logs:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl logs avalon-changefeeder-deploy-1476356743-35g55  -c avalon-changefeeder-pod</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>After fiddling with it for a while, I discovered the problem has to do with how the change feeder console app was coded. It uses a typical <code>Console.ReadKey</code> method to make the application run until a key is pressed. So I modified my code based on <a href="https://carlos.mendible.com/2017/10/15/prepare-a-net-core-console-app-for-docker/" target="_blank" rel="noopener noreferrer">this useful code snippet</a>, rebuild my container and re-deployed and yes....the change feeder pod is in <code>running</code> state.</p><p>It took me a while to get the above to work. This is because I was updating the image in the container registry without changing the tag. This did not force a re-pull and I ended up not using the latest image that I was deploying to the container. It seems that k8s caches the images unless you add to the deployment file a <code>imagePullPolicy: Always</code> in the container spec. Doing so forces k8s to re-pull the image. The other option is to change the image tag.</p><p>Now things look better ...but there is another problem. Upon termination, the change feeder container needs to de-register and clean up some resources. Unfortunately I noticed when I issue a <code>docker stop &lt;id&gt;</code>, the process is abruplty terminated and there is no change for the change feeder thread to clean up. I found a good article that describes how to <a href="https://www.ctl.io/developers/blog/post/gracefully-stopping-docker-containers/" target="_blank" rel="noopener noreferrer">gracefully stop Docker containers</a> which goes into some detail to describe the best way to handle it. However, since I am using a .NET Core app, I really did not find an easy way to handle the two Linux signales: <code>SIGINT</code> and <code>SIGTERM</code>. I did find a lot of discussions about it <a href="https://github.com/aspnet/Hosting/issues/870" target="_blank" rel="noopener noreferrer">here</a>. As it stands now, if I run the container in an intercative mode using <code>docker run --rm -ti avalonchangefeeder</code>, for example, and then perform control-c or control-break, the container shuts down gracefully. However, if I issue a <code>docker stop</code>, the container abruplty exists without giving any chance for the change feeder to do any cleanup :-(</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="application-insights"></a>Application Insights<a class="hash-link" href="#application-insights" title="Direct link to heading">#</a></h2><p>I used <code>Application Insights</code> to trace and track what is happening inside the container. This provide a really powerful way to monitor what is happening inside the container. I noticed that the Application Insights has a Kubernetes extension....but I am not using it yet.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="scaling"></a>Scaling<a class="hash-link" href="#scaling" title="Direct link to heading">#</a></h2><p>Now that everything is in Kubernetes, we can scale the deployments up and down as we need. Scaling the web jobs deployment up to multiple replicas provide several consumers of the queue and scaling the change feeder deployment up to multiple replicas automatically adjusts the divide the work among themselves. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/net-core">.NET Core</a><a class="margin-horiz--sm" href="/blog/tags/docker">Docker</a><a class="margin-horiz--sm" href="/blog/tags/kubernetes">Kubernetes</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></h2><div class="margin-vert--md"><time datetime="2018-01-02T00:00:00.000Z" class="blogPostDate_Ta7i">January 2, 2018  路 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>This is just a note about <a href="https://docs.microsoft.com/en-us/cli/azure/overview?view=azure-cli-latest" target="_blank" rel="noopener noreferrer">Azure CLI</a> login options.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="option-1"></a>Option 1:<a class="hash-link" href="#option-1" title="Direct link to heading">#</a></h2><p>Login interactively via a browser</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az login</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="option-2"></a>Option 2:<a class="hash-link" href="#option-2" title="Direct link to heading">#</a></h2><p>The best way to login is to use an Azure Service Principal though. So I registered an application in Azure Directory i.e. <code>AzureCliScriptApp</code> and assigned a service principal. I will use this service principal to login.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="create-a-service-principal"></a>Create a service principal:<a class="hash-link" href="#create-a-service-principal" title="Direct link to heading">#</a></h3><p>Make sure you are in the same tenant that you want to authenticate against. If not, use &#x27;az account set --subscription &quot;your-subs&quot;&#x27; to set the account.</p><p>To display the Azure Directory apps:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az ad app list --display-name AzureCliScriptApp</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The above will yield the app id ...a big string that looks like this: <code>e68ab97f-cff2-4b50-83d5-eec9fe266ccc</code></p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az ad sp create-for-rbac --name e68ab97f-cff2-4b50-83d5-eec9fe266ccc --password s0me_passw0rd</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;appId&quot;: &quot;some-app-id-you-will-use-to-sign-in&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;displayName&quot;: &quot;e68ab97f-cff2-4b50-83d5-eec9fe266ccc&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;name&quot;: &quot;http://e68ab97f-cff2-4b50-83d5-eec9fe266ccc&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;password&quot;: &quot;s0me_passw0rd&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;tenant&quot;: &quot;your-tenant-id&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To login with service principal:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az login --service-principal -u some-app-id-you-will-use-to-sign-in -p s0me_passw0rd --tenant your-tenant-id</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="useful-commands"></a>Useful Commands:<a class="hash-link" href="#useful-commands" title="Direct link to heading">#</a></h2><p>List all subscriptions</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az account list --output table</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Set the default account</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az account set --subscription &quot;Mosaic&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>List the Clouds</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az cloud list --output table</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">az cloud show --name AzureCloud --output json</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="kubernetes"></a>Kubernetes<a class="hash-link" href="#kubernetes" title="Direct link to heading">#</a></h2><p>if you are using the Azure CLI to provision a Kubernetes cluster, you should use this command if you used the service principal to login</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">az aks create --resource-group $rgName --name $k8sClusterName --service-principal $spAppId --client-secret $spPassword --node-count $k8sNodesCount --generate-ssh-keys</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where:
<code>$rgName</code> is the PowerShell variable that holds the resource group name
<code>$k8sClusterName</code> is the PowerShell variable that holds the k8s cluster name
<code>$spAppId</code> is the PowerShell variable that holds the service principal app id
<code>$spPassword</code> is the PowerShell variable that holds the service principal password
<code>$k8sNodesCount</code> is the PowerShell variable that holds the k8s cluster desired nodes count</p><p>Refer to this <a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-service-principal" target="_blank" rel="noopener noreferrer">doc</a> for more information</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/azure">Azure</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></h2><div class="margin-vert--md"><time datetime="2017-12-27T00:00:00.000Z" class="blogPostDate_Ta7i">December 27, 2017  路 14 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I started with this <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable-functions-install" target="_blank" rel="noopener noreferrer">documentation page</a> to learn about Azure durable Functions. I wanted to know if I can build a way to implement actors in Azure Functions. Actors Programming Model is pretty interesting and I did some work on it before.</p><p>Following the Azure Functions sample instructions mentioned in the above link, I quickly got up and running. However, I wanted to answer the following questions about actors in Azure Functions:</p><ul><li>Create a new actor giving a provided actor id</li><li>Signal an existing actor to perform something</li><li>When do actors get created?</li><li>When do actors get terminated?</li><li>Can we read the actor&#x27;s internal state?</li><li>What about .NET Core and .NET Standard 2.0 and other stuff?</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="create-a-new-actor"></a>Create a new actor:<a class="hash-link" href="#create-a-new-actor" title="Direct link to heading">#</a></h2><p>I created an HTTP trigger that looks like this where I provide a code that can be used as an instance id for the singleton i.e. membership actor. If the membership actor status is null or not running, then I start it with a <code>StartNewAsync</code>: </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpRefreshMemberships&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;post&quot;, Route = &quot;memberships/refresh/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var membershipStatus = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string runningStatus = membershipStatus == null ? &quot;NULL&quot; : membershipStatus.RuntimeStatus.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Instance running status: &#x27;{runningStatus}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus == null || </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus.RuntimeStatus != OrchestrationRuntimeStatus.Running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Code = code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.StartNewAsync(&quot;E3_Membership&quot;, code, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Started a new membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Refreshed an existing membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var res = starter.CreateCheckStatusResponse(req, code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    res.Headers.RetryAfter = new RetryConditionHeaderValue(TimeSpan.FromSeconds(10));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="signal-an-existing-actor-to-perform-something"></a>Signal an existing actor to perform something<a class="hash-link" href="#signal-an-existing-actor-to-perform-something" title="Direct link to heading">#</a></h2><p>If the membership actor does exist, we raise a <code>refresh</code> event to wake up the singleton so it can do work:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The actual membership actor code looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static class Membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [FunctionName(&quot;E3_Membership&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [OrchestrationTrigger] DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (membership == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;Something is bad! I should start with a valid membership.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var operation = await context.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;***** received &#x27;{operation}&#x27; event.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        operation = operation?.ToLowerInvariant();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation == &quot;refresh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            membership = await Refresh(context, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation != &quot;end&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.ContinueAsNew(membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Refresh(DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                              TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Do something to refresh the membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Code = context.InstanceId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateTime now = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string formatDate = now.ToString(&quot;MM/dd/yyyy hh:mm:ss.fff tt&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;**** done refreshing &#x27;{context.InstanceId}&#x27; @ {formatDate}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="multiple-signals"></a>Multiple signals<a class="hash-link" href="#multiple-signals" title="Direct link to heading">#</a></h3><p>But what happens if the actor is signaled frantically via raising an external event from an HTTP trigger, for example? The event signals are actually enqueued to the instance so they should run as many  times as they are sginaled. </p><p>If you are observing the actor&#x27;s streaming logs when you try this, it could get very confusing. This is because durable functions manage long-term running processes in short-lived functions is by taking advantage of state retrieved in the <code>context</code> and replaying the function to resume at the next step (from <a href="https://hackernoon.com/serverless-and-bitcoin-creating-price-watchers-dynamically-beea36ef194e" target="_blank" rel="noopener noreferrer">this article</a>). Effectively what you will see if that functions are started, completed and re-started again to resume state.     </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="code-delays"></a>Code Delays<a class="hash-link" href="#code-delays" title="Direct link to heading">#</a></h3><p>Singletons should not use <code>Task</code> functions such as <code>Task.Delay(millis)</code> to simulate code delays. This will cause run-time errors:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function &#x27;E3_Membership (Orchestrator)&#x27;, version &#x27;&#x27; failed with an error. Reason: System.InvalidOperationException: Multithreaded execution was detected. his can happen if the orchestrator function previously resumed from an unsupported async callback.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The preferred way for delays or timeouts is:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">await context.CreateTimer(deadline, CancellationToken.None);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where <code>deadline</code> is defined:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">DateTime deadline = context.CurrentUtcDateTime.AddMinutes(30);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>It is very important that we leverage the <code>context</code> to provide accurate timer information as opposed to <code>TimeSpan</code> and <code>DateTime.Now</code>, etc. I have seen very varying (not correct) results when I used <code>TimeSpan.FromMinutes(30)</code>, for example. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="wait-on-multiple-events"></a>Wait on multiple events<a class="hash-link" href="#wait-on-multiple-events" title="Direct link to heading">#</a></h3><p>What if we want the actor to wait on an external event or on a internal timeout event to perhaps refresh our membership periodically? I created another membership function i.e. <code>E3_MembershipWithTimer</code> that awaits on either an operation event or a timeout event:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;E3_MembershipWithTimer&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;dynamic&gt; RunWithTimer(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationTrigger] DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;E3_MembershipWithTimer starting.....&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (membership == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Something is bad! I should start with a valid membership.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string operation = &quot;refresh&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using (var cts = new CancellationTokenSource())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var operationTask = context.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateTime deadline = context.CurrentUtcDateTime.AddMinutes(30);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var timeoutTask = context.CreateTimer(deadline, cts.Token);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task winner = await Task.WhenAny(operationTask, timeoutTask);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (winner == operationTask)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;An operation event received!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            operation = operationTask.Result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            cts.Cancel();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Default the timeout task to mean a &#x27;refresh&#x27; operation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;A timeout event received!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            operation = &quot;refresh&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;***** received &#x27;{operation}&#x27; event.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    operation = operation?.ToLowerInvariant();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (operation == &quot;refresh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membership = await Refresh(context, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (operation != &quot;end&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        context.ContinueAsNew(membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="when-do-actors-get-created"></a>When do actors get created?<a class="hash-link" href="#when-do-actors-get-created" title="Direct link to heading">#</a></h2><p>Actors or singletons actually do persist in storage (please see the section about termination)......this is how an Azure Functions knows how to start them when it restarts. So if you create actors with specific instance ids (or actor ids), shut down the functions and restart it, the singleton instances are available. When you want to trigger an instance, you must check its running state and then invoke the proper API:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var membershipStatus = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string runningStatus = membershipStatus == null ? &quot;NULL&quot; : membershipStatus.RuntimeStatus.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">log.Info($&quot;Instance running status: &#x27;{runningStatus}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    membershipStatus == null || </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    membershipStatus.RuntimeStatus != OrchestrationRuntimeStatus.Running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Code = code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await starter.StartNewAsync(&quot;E3_Membership&quot;, code, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Started a new membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Refreshed an existing membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="when-do-actors-get-terminated"></a>When do actors get terminated?<a class="hash-link" href="#when-do-actors-get-terminated" title="Direct link to heading">#</a></h2><p>They can be easily terminated using the <code>TerminateAsync</code> API. So I created a little HTTP trugger that would terminate instances:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpTerminateMemberships&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;post&quot;, Route = &quot;memberships/terminate/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.TerminateAsync(code, &quot;&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.OK);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.BadRequest, ex.Message);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The Azure Durable Functions maintain a state of all running instances in a task hub which is basically a storage resource with control queues, qork-item queues, a history table and lease blobs. You can read more about this <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable-functions-task-hubs" target="_blank" rel="noopener noreferrer">here</a>. </p><p>Effectively, the <code>host.json</code> <code>durableTask</code> indicate the hub name:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;durableTask&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;HubName&quot;: &quot;TestDurableFunctionsHub&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The run-time environment stores related information about running instances in storage keyed by the hub name.  </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-actor-state"></a>The actor state<a class="hash-link" href="#the-actor-state" title="Direct link to heading">#</a></h2><p>Each actor has an internal state! It is initially read by the singleton as an input:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and it is updated using:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">context.ContinueAsNew(membership);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>But it seems that the internal state is actually not persisted anywhere ...it is transient. When actors are initially created, a state is passed as an input i.e. <code>context.GetInput&lt;dynamic&gt;()</code> and the actor updates it with a call to <code>ContinueAsNew</code> which actually restarts itself with a new state. </p><p>The internal state can be read by using one of the APIs of the instance management:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var status = await client.GetStatusAsync(instanceId);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Where <code>client</code> is <code>DurableOrchestrationClient</code>. The status input is the actor&#x27;s internal state:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Name&quot;: &quot;E3_MembershipWithTimer&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;InstanceId&quot;: &quot;U7CCR&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;CreatedTime&quot;: &quot;2017-12-29T21:12:24.8229285Z&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;LastUpdatedTime&quot;: &quot;2017-12-29T21:12:25.5309613Z&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Input&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;$type&quot;: &quot;&lt;&gt;f__AnonymousType0`3[[System.String, mscorlib],[System.String, mscorlib],[System.String, mscorlib]], VSSample&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Id&quot;: &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;Code&quot;: &quot;U7CCR&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;CardNumber&quot;: &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;Output&quot;: null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;RuntimeStatus&quot;: 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I am not sure if the actor internal state is meant to hold big state though. Perhaps it is better if the actor exposes its state externally so HTTP triggers, for example, can read it directly from the external store. </p><p>One way of doing this is to modify the code to look something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpRefreshMemberships&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;post&quot;, Route = &quot;memberships/refresh/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var membershipStatus = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string runningStatus = membershipStatus == null ? &quot;NULL&quot; : membershipStatus.RuntimeStatus.ToString();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Instance running status: &#x27;{runningStatus}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus == null || </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        membershipStatus.RuntimeStatus != OrchestrationRuntimeStatus.Running</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Given the membership code, read from an external source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var membership = await RetriveFromCosmosDB(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.StartNewAsync(&quot;E3_Membership&quot;, code, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Started a new membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await starter.RaiseEventAsync(code, &quot;operation&quot;, &quot;refresh&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Refreshed an existing membership actor with code = &#x27;{code}&#x27;.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var res = starter.CreateCheckStatusResponse(req, code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    res.Headers.RetryAfter = new RetryConditionHeaderValue(TimeSpan.FromSeconds(10));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return res;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the membership actor:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static class Membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [FunctionName(&quot;E3_Membership&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [OrchestrationTrigger] DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = context.GetInput&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (membership == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Read from an external source </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            membership = await RetriveFromCosmosDB(context.InstanceId);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var operation = await context.WaitForExternalEvent&lt;string&gt;(&quot;operation&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;***** received &#x27;{operation}&#x27; event.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        operation = operation?.ToLowerInvariant();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation == &quot;refresh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            membership = await Refresh(context, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (operation != &quot;end&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context.ContinueAsNew(membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public static async Task&lt;dynamic&gt; Refresh(DurableOrchestrationContext context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                              TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Do something to refresh the membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        dynamic membership = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Id = &quot;asas&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Code = context.InstanceId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            CardNumber = &quot;977515900121213&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // TODO: Store to an external source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await StoreToCosmosDB(context.InstanceId, membership);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        DateTime now = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string formatDate = now.ToString(&quot;MM/dd/yyyy hh:mm:ss.fff tt&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;**** done refreshing &#x27;{context.InstanceId}&#x27; @ {formatDate}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return membership;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>and the HTTP trigger that retrieves the membership actor state from an extenal source without dealing with the actor:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[FunctionName(&quot;HttpGetMembership&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task&lt;HttpResponseMessage&gt; Run(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [HttpTrigger(AuthorizationLevel.Function, methods: &quot;get&quot;, Route = &quot;memberships/{code}&quot;)] HttpRequestMessage req,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [OrchestrationClient] DurableOrchestrationClient starter,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    string code,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var status = await starter.GetStatusAsync(code);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (status != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.OK, await RetriveFromCosmosDB(code));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return req.CreateResponse&lt;dynamic&gt;(HttpStatusCode.BadRequest, $&quot;{code} membership actor is not found!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>So unlike regular actor implementation, Azure Functions singletons do not expose any method to be called from the outside! The platform only allows starting/creating, querying and terminating instances. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="comments--anamolies"></a>Comments &amp; Anamolies<a class="hash-link" href="#comments--anamolies" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="net-core-and-net-standard-20"></a>.NET Core and .NET Standard 2.0<a class="hash-link" href="#net-core-and-net-standard-20" title="Direct link to heading">#</a></h3><p>It is work in progress! It is best to use the .NET full framework with Azure Durable Functions. Hopefully this will change soon and we will be able to use .NET Core reliably.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="local-debugging"></a>Local Debugging<a class="hash-link" href="#local-debugging" title="Direct link to heading">#</a></h3><p>I had a very hard time with this. The symptoms that I experienced are unfortutanely not experienced by other developers who tried this as I could not see similar reported issues. I am using Vs2017 and Azure Functions Extension ...the latest at the time of writing DEC/2017. </p><p>Here are my comments:</p><ul><li>If you want to debug locally, make sure you set both the local.setting.json and host.json file to <code>copy always</code>. You do this from the properties window.</li><li>On both of my developer machines, I hit F5, it prompts me to install the Azure Functions Core tools and things look quite good. I was able to run locally.</li><li>But then subsequent F5, I get very different results ranging from:<ul><li>The CLI starts and exits on its own ...I could not find out what the reason is</li><li>The CLI starts and displays the functions URls. But it also complains about some files were changed and the host needs to restart. The URls are not responsive and there is nothing you can do except to terminate and restart.</li><li>The CLI statrs and actually works.....does not happen often ...but I have seen it work</li><li>F5 mostly causes the CLI to start and exit. Control-F5 does not exit ...but the function URLs are not accessible due to this <code>change detected</code> message.</li></ul></li><li>Effectively, local debugging did not work for me at all. It was a very frustrating experience. So I had to deploy everything (see deplyment below) to Azure and debug there....another frustrating experience. </li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h3><ul><li>The only effective way I was able to find out how to deploy a Durable Functions App is via Visual Studio. I have heard some people got it to work with VSTS. But, given that this is a test run, I did not really explore this option.</li><li>However, if you just click the <code>publish</code> button in VS, it will auto-create a storage account for you which names things really weird. My recommendation is to create the App Service, Service Plan, Storage and App Insights in portal or via Azure CLI and then use Visual Studio to publish into it. </li><li>If you renamed a function and re-deployed, Visual Studio will publish the new functions app with the new function. But the old function will still be there (you can see it from the portal). You can then use <code>Kudo</code>, navigate to the directory and actually delete the old function folder. </li><li>The local.settings.json entries are not deployed to Azure! This means you have to manually create them in the portal app settings or in Visual Studio deployment window. </li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="storage"></a>Storage<a class="hash-link" href="#storage" title="Direct link to heading">#</a></h3><p>As mentioned, an Azure Storage is required to maintain teh durable instances. They are keyed off the hub name you specify in the host. There are entries in blob, tables, files and queues. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="logging"></a>Logging<a class="hash-link" href="#logging" title="Direct link to heading">#</a></h3><p>Unless you turn on streaming on a function in the portal, you don&#x27;t get anything (or at least, I could not find a way to do it). But watching the log from the portal is very difficult as it times out and it is not very user friendly. This is one area that requires better UX in the portal. The logs are also stored on the app&#x27;s file system which you can access from <code>Kudo</code>. However, I noticed that, unless you request stream logging on a function, these files are not created. </p><p>So the story of logging is a little frustrating at best! I had to use App Insights trace to see what is going on.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="timers"></a>Timers<a class="hash-link" href="#timers" title="Direct link to heading">#</a></h3><p>As mentioned above, it is very important that we leverage the context to provide accurate timer information as opposed to <code>TimeSpan</code> and <code>DateTime.Now</code>, etc. Initially I used <code>TimeSpan.FromMinutes(30)</code> to wait for 30 minutes....but the way to do it is to always use the <code>context</code> such as <code>DateTime deadline = context.CurrentUtcDateTime.AddMinutes(30);</code>. After doing that, I started getting conistent timeout periods and things worked normally. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="instance-termination"></a>Instance Termination<a class="hash-link" href="#instance-termination" title="Direct link to heading">#</a></h3><p>Although <code>TerminateAsync</code> on an instance works, I am not exactly sure if it works the way it is supposed to:</p><ul><li>If I have a running instance and that instance is actually waiting on an external or time out event, <code>TerminateAsync</code> does not do anything. I guess because a message is enqueued to the instance but the instance is waiting on other events ....so it did not get the <code>terminate</code> signal yet.</li><li>If the instance is not waiting on anything, <code>TerminateAsync</code> replays the instance which runs code that you don&#x27;t necessarily want to run. For example, I had an instance that triggers a logic app once it receives an <code>end</code> operation which works. However, if I terminate the instance using <code>TerminateAync</code>, the code triggers the logic app again because it was replayed! </li></ul><p>Not sure if this behavior is correct and what the <code>terminate</code> signal actually do.       </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Reflecting on the little time that I spent with Azure Durable Functions, I think they will play an important part of my future solutions. I think they have what it takes to use as actors especially that the Azure Durable Functions are designed to <a href="https://social.msdn.microsoft.com/Forums/en-US/b6ffeae3-f62a-4e6d-a68a-e5dc6f9ffd62/durable-singletons?forum=AzureFunctions" target="_blank" rel="noopener noreferrer">support 1000&#x27;s of instances</a> . If we externalize the actor&#x27;s state, we will be able to query the external store as opposed to query the actors themselves to retrieve their state. </p><p>Azure Durable Actors can also employ reminders and other sophisticated techniques found in Service Fabric actors such as long-running, stateful, single-threaded, location-transparent and globally addressable (taken from the overview <a href="https://docs.microsoft.com/en-us/azure/azure-functions/durable-functions-overview" target="_blank" rel="noopener noreferrer">documentation page</a>). However, as stated above and unlike other actor implementations, Azure Functions singletons do not expose methods that can be called from the outside. </p><p>In any case, the Azure Durable Functions are still in preview. So we can expect many great features to be added soon.  </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/azure-functions">Azure Functions</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></h2><div class="margin-vert--md"><time datetime="2017-12-21T00:00:00.000Z" class="blogPostDate_Ta7i">December 21, 2017  路 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>This PowerShell script creates self-signed root and client certificates, export them and import what is needed:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Assume you are on Windows 10</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$myPassword = &quot;some_password&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$certsPath = &quot;C:\YourDir\Certificates&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$certNamePrefix = &quot;YourNameP2S&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$date = Get-date &quot;2040-01-01&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a self-signed ROOT cert </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$rootCert = New-SelfSignedCertificate -Type Custom -KeySpec Signature -Subject &quot;CN=$($certNamePrefix)Cert&quot; -KeyExportPolicy Exportable -HashAlgorithm sha256 -KeyLength 2048 -CertStoreLocation &quot;Cert:\CurrentUser\My&quot; -KeyUsageProperty Sign -KeyUsage CertSign -NotAfter $date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Export the cert to base64 so it can be uploaded to the Point-to-Site VPN connection: refer to https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-certificates-point-to-site</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upload the .cer ending with &#x27;_Encoded&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Export-Certificate -Cert $rootCert -FilePath &quot;$certsPath\$($certNamePrefix)Cert.cer&quot; </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Start-Process -FilePath &#x27;certutil.exe&#x27; -ArgumentList &quot;-encode $certsPath\$($certNamePrefix)Cert.cer $certsPath\$($certNamePrefix)Cert_Encoded.cer&quot; -WindowStyle Hidden</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># NOTE: Download the VPN Client from Azure AFTER you upload the encoded certificate i.e. .cer file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Generate a client certificate from the self-signed certificate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># NOTE: The self-siged root cert and the client cert must have the same subject!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clientCert = New-SelfSignedCertificate -Type Custom -KeySpec Signature -Subject &quot;CN=$($certNamePrefix)Cert&quot; -KeyExportPolicy Exportable -HashAlgorithm sha256 -KeyLength 2048 -CertStoreLocation &quot;Cert:\CurrentUser\My&quot; -Signer $rootCert -TextExtension @(&quot;2.5.29.37={text}1.3.6.1.5.5.7.3.2&quot;) -NotAfter $date</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Export the client certificate as PFX</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Export-PfxCertificate -Cert $clientCert -ChainOption BuildChain -FilePath  &quot;$certsPath\$($certNamePrefix)Cert.pfx&quot; -Password $(ConvertTo-SecureString -String $myPassword -AsPlainText -Force)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Import the PFX client cert into the user store</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Import-PfxCertificate -CertStoreLocation Cert:\CurrentUser\my\ -FilePath &quot;$certsPath\$($certNamePrefix)Cert.pfx&quot; -Exportable -Password $(ConvertTo-SecureString -String $myPassword -AsPlainText -Force)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I hope it helps someone.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/azure">Azure</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/03/30/deletes-in-docdb">Document Deletion in Azure DocumentDB</a></h2><div class="margin-vert--md"><time datetime="2017-03-30T00:00:00.000Z" class="blogPostDate_Ta7i">March 30, 2017  路 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I saw many posts about deleting documents in Azure DocumentDB...but none of them worked quite well for me. So I spent a few hours on this and finally got it to work. Below is my solution. The following posts helped me tremendously (thank you):</p><ul><li><a href="https://talkingaboutdata.wordpress.com/2015/08/24/deleting-multiple-documents-from-azure-documentdb/" target="_blank" rel="noopener noreferrer">https://talkingaboutdata.wordpress.com/2015/08/24/deleting-multiple-documents-from-azure-documentdb/</a></li><li><a href="https://www.tutorialspoint.com/documentdb/documentdb_delete_document.htm" target="_blank" rel="noopener noreferrer">https://www.tutorialspoint.com/documentdb/documentdb_delete_document.htm</a></li><li><a href="http://stackoverflow.com/questions/29137708/how-to-delete-all-the-documents-in-documentdb-through-c-sharp-code" target="_blank" rel="noopener noreferrer">http://stackoverflow.com/questions/29137708/how-to-delete-all-the-documents-in-documentdb-through-c-sharp-code</a></li><li><a href="https://azure.microsoft.com/en-us/blog/working-with-dates-in-azure-documentdb-4/" target="_blank" rel="noopener noreferrer">https://azure.microsoft.com/en-us/blog/working-with-dates-in-azure-documentdb-4/</a></li></ul><p>I basically wanted to delete aging documents (based on number of hours) from a collection. So my final routine looks like this. Below is some explanation:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;int&gt; DeleteAgingDocuments(Uri docDbUri, string docDbKey, string databaseName, string collectionName, int hours)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    using (var client = new DocumentClient(docDbUri, docDbKey))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var dbs = this._docDbClient.CreateDatabaseQuery().ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (dbs == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception(&quot;No databases in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var db = dbs.Where(d =&gt; d.Id == databaseName).FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (db == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;No database [{databaseName}] in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var collections = this._docDbClient.CreateDocumentCollectionQuery(db.CollectionsLink).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (collections == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;No collections in the [{databaseName}] database in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var collection = this._docDbClient.CreateDocumentCollectionQuery(db.CollectionsLink).Where(c =&gt; c.Id == collectionName).ToList().FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (collection == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new Exception($&quot;No collection [{collectionName}] in the [{databaseName}] database in the Docdb account!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            int epocDateTime = DateTime.UtcNow.AddHours(-1 * hours).ToEpoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var dbQuery = &quot;SELECT VALUE {\&quot;link\&quot;: c._self, \&quot;source\&quot;: c.source} FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var link = (string)doc.link;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var source = (string)doc.source;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await this._docDbClient.DeleteDocumentAsync(link, new RequestOptions() { PartitionKey = new Microsoft.Azure.Documents.PartitionKey(source) });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return docs.Count;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // some debug </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="time"></a>Time<a class="hash-link" href="#time" title="Direct link to heading">#</a></h3><p>The first problem I encountered is how to select the aging documents! It turned out the best way to do this is to compare numbers as opposed to dates. This <a href="https://azure.microsoft.com/en-us/blog/working-with-dates-in-azure-documentdb-4/" target="_blank" rel="noopener noreferrer">post</a> helped me understand what the problem is and how to go around doing it properly. I ended it up using the built-in time stamp value stored as meta data in every DocDB document i.e. <code>_ts</code>. This may or may not work for every case. In my case my collection document date i.e. <code>eventDate</code> is actually the real UTC time ....so it was no problem. If this is not the case, you many need to store your own time stamp (in addition to the date) so u can do the query to pull the aging documents based on time. </p><p>so this query does exactly that:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">int epocDateTime = DateTime.UtcNow.AddHours(-1 * hours).ToEpoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = $&quot;SELECT * FROM c WHERE c._ts &lt; {epocDateTime}&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Notice how I am using the Epoc time for my aging time stamp. The <code>DateTime</code> extension is written this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static int ToEpoch(this DateTime date)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (date == null) return int.MinValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DateTime epoch = new DateTime(1970, 1, 1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    TimeSpan epochTimeSpan = date - epoch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return (int)epochTimeSpan.TotalSeconds;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="partition-key"></a>Partition Key<a class="hash-link" href="#partition-key" title="Direct link to heading">#</a></h3><p>My collection was partitioned over a value in the document i.e. <code>source</code>, but I wanted to trim all aging documents across all partitions...not against a single partition. So I used this query options to force the query to span multiple partitions:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">FeedOptions queryOptions = new FeedOptions { EnableCrossPartitionQuery = true };</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deletion"></a>Deletion<a class="hash-link" href="#deletion" title="Direct link to heading">#</a></h3><p>Finally, I wanted to loop through all aging documents and delete:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">int epocDateTime = DateTime.UtcNow.AddHours(-1 * hours).ToEpoch();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = &quot;SELECT VALUE {\&quot;link\&quot;: c._self, \&quot;source\&quot;: c.source} FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var link = (string)doc.link;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var source = (string)doc.source;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await this._docDbClient.DeleteDocumentAsync(link, new RequestOptions() { PartitionKey = new Microsoft.Azure.Documents.PartitionKey(source) });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="query"></a>Query<a class="hash-link" href="#query" title="Direct link to heading">#</a></h4><p>Please note that the query that I used above uses a projection to get only the document link and the partition key....we really do not need the entire document:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = &quot;SELECT VALUE {\&quot;link\&quot;: c._self, \&quot;source\&quot;: c.source} FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Also please note that I am using the <code>VALUE</code> modifier in the query so to force DocDB to return the value only. This will return a payload that looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwABAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;source&quot;: &quot;Digital Controller&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwACAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;source&quot;: &quot;Profiler&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If I don&#x27;t include the <code>VALUE</code> modifier, I get this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;$1&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwABAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;source&quot;: &quot;Digital Controller&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;$1&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;link&quot;: &quot;dbs/XEthAA==/colls/XEthAL4dCwA=/docs/XEthAL4dCwACAAAAAAAAAA==/&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;source&quot;: &quot;Profiler&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">]</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I chose the first one :-)  </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deletion-1"></a>Deletion<a class="hash-link" href="#deletion-1" title="Direct link to heading">#</a></h4><p>Finally, we pull the documents and delete one at a time:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var link = (string)doc.link;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var source = (string)doc.source;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await this._docDbClient.DeleteDocumentAsync(link, new RequestOptions() { PartitionKey = new Microsoft.Azure.Documents.PartitionKey(source) });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Initially, I only got the document link from the query thinking that this was the only requirement. So I did something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">var dbQuery = &quot;SELECT VALUE c._self FROM c WHERE c._ts &lt; &quot; + epocDateTime;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">var docs = this._docDbClient.CreateDocumentQuery(collection.SelfLink, dbQuery, new FeedOptions { EnableCrossPartitionQuery = true }).ToList();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (var doc in docs)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    await this._docDbClient.DeleteDocumentAsync(doc);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This did not work! I needed to pass the partition key....this is why i changed the query to a projection so I can get the partition key. In my case the partition key is the <code>source</code>. There is a comment in this <a href="http://stackoverflow.com/questions/29137708/how-to-delete-all-the-documents-in-documentdb-through-c-sharp-code" target="_blank" rel="noopener noreferrer">post</a> that gave me a clue that the request option must include the partition key.</p><p>Thank you for reading! I hope this helps someone. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/cosmos-db">CosmosDB</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/02/21/service-fabric-secure-cluster">Service Fabric Secure Cluster Deployment</a></h2><div class="margin-vert--md"><time datetime="2017-02-21T00:00:00.000Z" class="blogPostDate_Ta7i">February 21, 2017  路 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>In this post, I just used the Service Fabric team article <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-cluster-creation-via-arm</a> to create a PowerShell script that will do the entire deployment. I also downloaded all the required helper PowerShell modules and placed them in one <a href="https://github.com/khaledhikmat/service-fabric-secure-deployment" target="_blank" rel="noopener noreferrer">repository</a> so it would be easier for others to work with the deployment.</p><p>Here are some of my notes:</p><ul><li>The account you use to log in to Azure with must be a Global admin.</li><li>In case of errors during deployment, please check the Azure Activity Logs. It is pretty good and provides a very useful insight to what went wrong.</li><li>After a deployment is successful, you can modify the ARM template and re-deploy. This will update the cluster. For example, if you added a new LN port and re-deployed using the PowerShell script, that new port will be available.</li><li>To connect to a secure cluster, use this guide: <a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-connect-to-secure-cluster" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-connect-to-secure-cluster</a> </li><li>Connect to the cluster using the browser <a href="https://your-cluster.westus.cloudapp.azure.com:19080/Explorer/index.html" target="_blank" rel="noopener noreferrer">https://your-cluster.westus.cloudapp.azure.com:19080/Explorer/index.html </a> will cause a certificate error. This is expected as the script uses a self-signed certificate. Just proceed.  </li><li>To log in to the fabric explorer requires that you complete the steps where you go to the AD in which the cluster belongs to, select the app that was created and assign an admin role to it as described in the above article. This must be done from the classic portal.</li><li>To connect using PowerShell, use <code>Connect-ServiceFabricCluster -ConnectionEndpoint ${dnsName}:19000 -ServerCertThumbprint &quot;6C84CEBF914FF489551385BA128542BA63A16222&quot; -AzureActiveDirectory</code>. Please note that, similar to the browser, this requires that the user be assigned as in the previous step.</li><li>Please note that securing the cluster does not mean that your own application endpoint is secured. You must do whatever you need to do to enable HTTPs in your own application and provide some sort of token authentication. </li><li>I noticed that the only VM size that worked reliably was the Standard_D2. Anything less than that causes health issues due to disk space, etc. I heard from Microsoft <a href="https://social.msdn.microsoft.com/Forums/en-US/04915062-63fd-4608-94fb-f018c32e15c3/will-there-be-a-service-fabric-managed-service?forum=AzureServiceFabric" target="_blank" rel="noopener noreferrer">here</a> that they are working on ways to reduce the cost of the VMs, particularly by allowing us to use smaller VMs and still get the reasonable reliability/durability levels, which would help reduce costs without sacrificing the safety or uptime of our service.</li></ul></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/service-fabric">Service Fabric</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/02/15/web-test-thoughts">Web Tests Thoughts</a></h2><div class="margin-vert--md"><time datetime="2017-02-15T00:00:00.000Z" class="blogPostDate_Ta7i">February 15, 2017  路 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>If a Web App is deployed on Azure, both the <a href="https://azure.microsoft.com/en-us/services/application-insights/" target="_blank" rel="noopener noreferrer">App Insights</a> and <a href="https://azure.microsoft.com/en-us/services/app-service/web/" target="_blank" rel="noopener noreferrer">Web Apps</a> offer a utility that can hammer the app&#x27;s endpoints from different regions. While this functionality is quite nice and comes bundled in, it is considered an alert-based system and is slightly rudimentary as one cannot customize the test or get access to the full results easily. This post describes an alternative approach that uses <a href="https://azure.microsoft.com/en-us/services/functions/" target="_blank" rel="noopener noreferrer">Azure Functions</a> or <a href="https://azure.microsoft.com/en-us/services/service-fabric/" target="_blank" rel="noopener noreferrer">Service Fabric</a> to implement a web test that can test and endpoint and report its test to PowerBI in real time.</p><p>What I really wanted to do is to conduct a web test for a duration of time from different regions against a new product&#x27;s endpoints at launch time and immediately view the test results with executives. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-functions"></a>Azure Functions<a class="hash-link" href="#azure-functions" title="Direct link to heading">#</a></h2><p>Briefly, here is what I decided to do:</p><ul><li>Use PowerShell to provision resource groups in four different regions. Each resource group contains an Azure Function App that loads its source code from a code repository.</li><li>Use source code changes to trigger updates to all the functions apps at the same time.</li><li>Configure the Azure Functions App to test a Web URL or a collection. This test can be sophisticated because we have the full power of an Azure Function to conduct the test. In other words, the test can be running through a use case scenario as opposed to just posting to a URL, for example. </li><li>Auto-trigger the Azure Functions by a timer (i.e. configurable) to repeat the test.</li><li>Report the source (i.e region), duration, URL, date time and status code to a PowerBI real-time data set at the end of every test iteration.</li><li>Create a real-time visualization to see, in real-time, the test results.</li><li>Use PowerShell script to de-provision the resource groups when the test is no longer needed. </li></ul><p>The source code can be found <a href="https://github.com/khaledhikmat/serverless-webtest" target="_blank" rel="noopener noreferrer">here</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="macro-architecture"></a>Macro Architecture<a class="hash-link" href="#macro-architecture" title="Direct link to heading">#</a></h3><p><img src="http://i.imgur.com/2NMuHBC.png" alt="Web Test using Azure Functions"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-resource-group-template"></a>Azure Resource Group Template<a class="hash-link" href="#azure-resource-group-template" title="Direct link to heading">#</a></h3><p>I downloaded an Azure Function template and modified it to suit my needs. The main thing in the template is that it defines the repository URL and branch from which the source code is to be imported and the definitions of the app strings:</p><p>Here is the entire template:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;$schema&quot;: &quot;http://schemas.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;parameters&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;appName&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;string&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;metadata&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;description&quot;: &quot;The name of the function app that you wish to create.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;storageAccountType&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;string&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;defaultValue&quot;: &quot;Standard_LRS&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;allowedValues&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;Standard_LRS&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;Standard_GRS&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;Standard_ZRS&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;Premium_LRS&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;metadata&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;description&quot;: &quot;Storage Account type&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;repoURL&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;string&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;defaultValue&quot;: &quot;https://&lt;ourown&gt;.visualstudio.com/DefaultCollection/Misc/_git/WebTest&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;metadata&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;description&quot;: &quot;The URL for the GitHub repository that contains the project to deploy.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;branch&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;string&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;defaultValue&quot;: &quot;master&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;metadata&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;description&quot;: &quot;The branch of the GitHub repository to use.&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;variables&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;functionAppName&quot;: &quot;[parameters(&#x27;appName&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;hostingPlanName&quot;: &quot;[parameters(&#x27;appName&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;storageAccountName&quot;: &quot;[concat(uniquestring(resourceGroup().id), &#x27;azfunctions&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;storageAccountid&quot;: &quot;[concat(resourceGroup().id,&#x27;/providers/&#x27;,&#x27;Microsoft.Storage/storageAccounts/&#x27;, variables(&#x27;storageAccountName&#x27;))]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;resources&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;Microsoft.Storage/storageAccounts&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;name&quot;: &quot;[variables(&#x27;storageAccountName&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;apiVersion&quot;: &quot;2015-06-15&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;location&quot;: &quot;[resourceGroup().location]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;properties&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;accountType&quot;: &quot;[parameters(&#x27;storageAccountType&#x27;)]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;Microsoft.Web/serverfarms&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;apiVersion&quot;: &quot;2015-04-01&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;name&quot;: &quot;[variables(&#x27;hostingPlanName&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;location&quot;: &quot;[resourceGroup().location]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;properties&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;name&quot;: &quot;[variables(&#x27;hostingPlanName&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;computeMode&quot;: &quot;Dynamic&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;sku&quot;: &quot;Dynamic&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;apiVersion&quot;: &quot;2015-08-01&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;type&quot;: &quot;Microsoft.Web/sites&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;name&quot;: &quot;[variables(&#x27;functionAppName&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;location&quot;: &quot;[resourceGroup().location]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;kind&quot;: &quot;functionapp&quot;,            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;dependsOn&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;[resourceId(&#x27;Microsoft.Web/serverfarms&#x27;, variables(&#x27;hostingPlanName&#x27;))]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;[resourceId(&#x27;Microsoft.Storage/storageAccounts&#x27;, variables(&#x27;storageAccountName&#x27;))]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;properties&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;serverFarmId&quot;: &quot;[resourceId(&#x27;Microsoft.Web/serverfarms&#x27;, variables(&#x27;hostingPlanName&#x27;))]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                &quot;siteConfig&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;appSettings&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;AzureWebJobsDashboard&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;[concat(&#x27;DefaultEndpointsProtocol=https;AccountName=&#x27;, variables(&#x27;storageAccountName&#x27;), &#x27;;AccountKey=&#x27;, listKeys(variables(&#x27;storageAccountid&#x27;),&#x27;2015-05-01-preview&#x27;).key1)]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;AzureWebJobsStorage&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;[concat(&#x27;DefaultEndpointsProtocol=https;AccountName=&#x27;, variables(&#x27;storageAccountName&#x27;), &#x27;;AccountKey=&#x27;, listKeys(variables(&#x27;storageAccountid&#x27;),&#x27;2015-05-01-preview&#x27;).key1)]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;WEBSITE_CONTENTAZUREFILECONNECTIONSTRING&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;[concat(&#x27;DefaultEndpointsProtocol=https;AccountName=&#x27;, variables(&#x27;storageAccountName&#x27;), &#x27;;AccountKey=&#x27;, listKeys(variables(&#x27;storageAccountid&#x27;),&#x27;2015-05-01-preview&#x27;).key1)]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;WEBSITE_CONTENTSHARE&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;[toLower(variables(&#x27;functionAppName&#x27;))]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;FUNCTIONS_EXTENSION_VERSION&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;~1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;WEBSITE_NODE_DEFAULT_VERSION&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;6.5.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;location&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;[resourceGroup().location]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;name&quot;: &quot;testUrl&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            &quot;value&quot;: &quot;http://your-own.azurewebsites.net&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;resources&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;apiVersion&quot;: &quot;2015-08-01&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;name&quot;: &quot;web&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;type&quot;: &quot;sourcecontrols&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;dependsOn&quot;: [</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;[resourceId(&#x27;Microsoft.Web/Sites&#x27;, variables(&#x27;functionAppName&#x27;))]&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    ],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;properties&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;RepoUrl&quot;: &quot;[parameters(&#x27;repoURL&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;branch&quot;: &quot;[parameters(&#x27;branch&#x27;)]&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        &quot;isManualIntegration&quot;: false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ]                     </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Here is the template parameters file:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;$schema&quot;: &quot;http://schema.management.azure.com/schemas/2015-01-01/deploymentParameters.json#&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;contentVersion&quot;: &quot;1.0.0.0&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &quot;parameters&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;appName&quot;: {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;value&quot;: &quot;WebTestFunctions&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="powershell-script"></a>PowerShell Script<a class="hash-link" href="#powershell-script" title="Direct link to heading">#</a></h3><p>The PowerShell script is the main driver that orchestrates the deployment and of the different Azure Functions to different resource groups. Here is the complete script:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Login to Azure first</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Login-AzureRmAccount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Select the subscription</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-AzureRmSubscription | select SubscriptionName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$subscr = &quot;YourOwn&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Select-AzureRmSubscription -SubscriptionName $subscr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 1. create a new resource group in west US</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroup -Name WebTest4WestUS -Location &quot;West US&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 1.5. deploy the template to the west us resource group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroupDeployment -Name WebTest4WestUSDeployment -ResourceGroupName WebTest4WestUS `</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -TemplateFile azuredeploy.json  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 2. create a new resource group in west europe</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroup -Name WebTest4WestEurope -Location &quot;West Europe&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 2.5. deploy the template to the west europe resource group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroupDeployment -Name WebTest4WestEuropeDeployment -ResourceGroupName WebTest4WestEurope `</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -TemplateFile azuredeploy.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 3. create a new resource group in West Japan</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroup -Name WebTest4WestJapan -Location &quot;Japan West&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 3.5. deploy the template to the west japan resource group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroupDeployment -Name WebTest4WestJapanDeployment -ResourceGroupName WebTest4WestJapan `</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -TemplateFile azuredeploy.json    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 4. create a new resource group in South Brazil</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroup -Name WebTest4SouthBrazil -Location &quot;Brazil South&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># 4.5. deploy the template to the south brazil resource group</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-AzureRmResourceGroupDeployment -Name WebTest4SouthBrazilDeployment -ResourceGroupName WebTest4SouthBrazil `</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -TemplateFile azuredeploy.json  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">######</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Delete the resource groups</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-AzureRmResourceGroup -Name WebTest4WestUS -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-AzureRmResourceGroup -Name WebTest4WestEurope -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-AzureRmResourceGroup -Name WebTest4WestJapan -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-AzureRmResourceGroup -Name WebTest4SouthBrazil -Force   </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Once you run the deployments, u will see something like this in your subscription resource groups:</p><p><img src="http://i.imgur.com/8LgDuHA.png" alt="Resource Groups"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="powerbi-real-time-dataset"></a>PowerBI Real-Time Dataset<a class="hash-link" href="#powerbi-real-time-dataset" title="Direct link to heading">#</a></h3><p>Using this <a href="https://powerbi.microsoft.com/en-us/documentation/powerbi-service-real-time-streaming/" target="_blank" rel="noopener noreferrer">nifty feature</a> in PowerBI, I defined a real-time dataset that looks like this:</p><p><img src="http://i.imgur.com/x6SvVgS.png" alt="PowerBI Real Time Dataset"></p><p>This gave me a URL that I can use from Azure Functions to pump data into this Real-time dataset. Also please note that I enbaled the <code>historic data analysis</code> to allow me to report on the data and visualize it in real-time and beyond.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="azure-function-source-code"></a>Azure Function Source Code<a class="hash-link" href="#azure-function-source-code" title="Direct link to heading">#</a></h3><p>Finally, the Azure Function source code that conducts the test and reports to PowerBI:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#r &quot;Newtonsoft.Json&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Text;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using System.Net.Http.Headers;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">using Newtonsoft.Json;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static async Task Run(TimerInfo cacheTimer, TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var location = GetEnvironmentVariable(&quot;location&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    log.Info($&quot;Web Test trigger executed at {DateTime.Now} from {location}&quot;);    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var testUrl = GetEnvironmentVariable(&quot;testUrl&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!string.IsNullOrEmpty(testUrl))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string [] results = await TestUrl(testUrl, log);                </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (results != null &amp;&amp; results.Length == 2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                // Condition the event to meet the Real-Time PowerBI expectation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var realTimeEvent = new {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    time = DateTime.Now,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    source = GetEnvironmentVariable(&quot;location&quot;),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    url  = testUrl,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    duration  = Double.Parse(results[1]),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    result = results[0]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var events = new List&lt;dynamic&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                events.Add(realTimeEvent);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                await PostToPowerBI(events, log);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                log.Info($&quot;Bad results from testing url!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            log.Info($&quot;No Test URL!&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception e)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;Encountered a failure: {e.Message}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">private async static Task&lt;string []&gt; TestUrl(string url, TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var results = new string[2];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var statusCode = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpClient client = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DateTime startTime = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    DateTime endTime = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        client = new HttpClient();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpResponseMessage response = await client.GetAsync(url);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        statusCode = response.StatusCode.ToString();    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;TestUrl failed: {ex.Message}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        statusCode = &quot;500&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    finally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (client != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            client.Dispose();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    endTime = DateTime.Now;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    results[0] = statusCode;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    results[1] = (endTime - startTime).TotalSeconds + &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return results;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">private async static Task PostToPowerBI(object realTimeEvents, TraceWriter log)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpClient client = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // The URL for PowerBI Real Time Dataset</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var url = &quot;https://api.powerbi.com/beta/your-own&quot;; // Should be made into an app setting</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        client = new HttpClient();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var postData = Newtonsoft.Json.JsonConvert.SerializeObject(realTimeEvents);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpContent httpContent = new StringContent(postData, Encoding.UTF8, &quot;application/json&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpResponseMessage response = await client.PostAsync(url , httpContent);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string responseString = await response.Content.ReadAsStringAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (!response.IsSuccessStatusCode)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            throw new Exception(&quot;Bad return code: &quot; + response.StatusCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        log.Info($&quot;PostToPowerBI failed: {ex.Message}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    finally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (client != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            client.Dispose();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public static string GetEnvironmentVariable(string name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return System.Environment.GetEnvironmentVariable(name, EnvironmentVariableTarget.Process);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="results-visualization"></a>Results Visualization<a class="hash-link" href="#results-visualization" title="Direct link to heading">#</a></h3><p>If we deploy the Azure Functions and collect the results in PowerBI, we can get real-time results that look like this:</p><p><img src="http://i.imgur.com/Dc1B6Jm.png" alt="Web Test Results 1"></p><p><img src="http://i.imgur.com/ZI3Qfps.png" alt="Web Test Results 2"></p><p>Hopefully this visualization helps executives to see a clear indication that the product launch is not that successful :-) </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="service-fabric"></a>Service Fabric<a class="hash-link" href="#service-fabric" title="Direct link to heading">#</a></h2><p>I also wanted to mantion that Azure Service Fabric could also be used to conduct a web test from hammering the test site from multiple instances. Briefly, here is what I thought of doing:</p><ul><li>Create a Web Test Application Type. The Service Fabric app contains a single stateless service which does work on its RunAsync method.</li><li>Use a PowerShell script to instantiate multiple tenants (or named applications): one for each region. Please note that the tenants simulate the different regions as they are all sitting in the same cluster!</li><li>Update (i.e increase or decrease the number of the stateless service instances) each tenant (or named application) independently. This means that, unlike the Azure Functions, the system under-test can be hammered from multiple instances within the same tenant if need be.</li><li>Write sophisticated tests within Service Fabric because the stateless service is doing it and the service can have a lot of configuration to govern that process.</li><li>Report the source (i.e region), duration, URL, date time and status code to a PowerBI real-time data set at the end of every test iteration.</li><li>Create a real-time visualization to see, in real-time, the test results.</li><li>Use PowerShell script to de-provision the resource groups when the test is no longer needed. </li></ul><p>I will publish the Service Fabric web test solution in a different blog post. For now, here is the macro architecture that I am thinking about:</p><p><img src="http://i.imgur.com/3f1bA7X.png" alt="Azure Service Fabric Macro Architecture"></p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/test">Test</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2017/01/10/service-fabric-notes">Service Fabric Notes</a></h2><div class="margin-vert--md"><time datetime="2017-01-10T00:00:00.000Z" class="blogPostDate_Ta7i">January 10, 2017  路 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I am compiling notes when working with <a href="https://azure.microsoft.com/en-us/services/service-fabric/" target="_blank" rel="noopener noreferrer">Service Fabric</a> from the folks at Microsoft! In this post, I will enumerate a few things that I ran into which I think might be helpful to others who are learning the environment as well. This will not be a complete list ....so I will add to it as I go along.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="actor-turn-based-concurrency"></a>Actor Turn-based Concurrency<a class="hash-link" href="#actor-turn-based-concurrency" title="Direct link to heading">#</a></h3><p>Actors are single threaded! They only allow one thread to be acting on them at any given time. In fact, in the Service Fabric terminology, this is referred to as Turn-based treading. From my observation, it seems that this is how the platform and the actors </p><p>What happens to the clients who are calling the actors? If two clients are trying to access an actor at the same time, one blocks until the actor finishes the first client method. This is to ensure that an actor works on one thing at a time. </p><p>Let us say, we have an actor that has two methods like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public Task&lt;string&gt; GetThing1()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Simulate long work</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.Sleep(5000);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return Task.FromResult&lt;string&gt;(&quot;thing1&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public Task&lt;string&gt; GetThing2()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Simulate long work</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Thread.Sleep(10000);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return Task.FromResult&lt;string&gt;(&quot;thing2&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you call <code>GetThing1</code> from one client and immediately call <code>GetThing2</code> from another client (or Postman session), the second client will wait at least 15 seconds to get the string <code>thing2</code> response.</p><p>Given this:</p><ul><li>I think it is best to front-end actors with a service that can invoke methods on actors when it receives requests from a queue. This way the service is waiting on actors to complete processing while it is in its <code>RunAsync</code> method.</li><li>It is important to realize that actors should really not be queried and that actors should employ several things:<ul><li>Backup state to an external store such as DocumentDB or others. This way the external store can be queried instead.</li><li>Aggregate result externally perhaps via Azure Function into some outside store so queries could run against this store</li><li>Aggregate result to an aggregator actor that can quickly respond to queries which will relieve the processing actors from worrying about query requests.</li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="actor-reminders"></a>Actor Reminders<a class="hash-link" href="#actor-reminders" title="Direct link to heading">#</a></h3><p><a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-actors-timers-reminders/" target="_blank" rel="noopener noreferrer">Actor Reminders</a> are really nice to have. In the sample app that I am working on, I use them to schedule processing after I return to the caller. Effectively they seem to give me the ability to run things asynchronously and return to the caller right away. Without this, the actor processing throughput may not be at best if the the processing takes a while to complete. </p><p>In addition to firing a future event, they do allow me to pack an item or object that can be retrieved when the reminder triggers. This makes a lot of scenarios possible because we are able to pack the item that we want the reminder to work on.</p><p><em>Please note, however, that when a reminder is running in an actor, that actor cannot respond to other method invocation! This is because the platform makes sure that there is only a single threaded operating on an actor at any time.</em> </p><p>The best way I found out to schedule reminders to fire immediately is something like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task Process(SomeItem item)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    var error = &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (item == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ...removed for brevity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await this.RegisterReminderAsync(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ReprocessReminder,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ObjectToByteArray(item),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            TimeSpan.FromSeconds(0),            // If 0, remind immediately</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            TimeSpan.FromMilliseconds(-1));     // Disable periodic firing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        error = ex.Message;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    finally</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ...removed for brevity</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>When the reminder triggers, <code>ReprocessReminder</code> is called to process the item that was packed within the reminder: <code>ObjectToByteArray(item)</code>. Here are possible implementation of packing and unpacking the item:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">private byte[] ObjectToByteArray(Object obj)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (obj == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    BinaryFormatter bf = new BinaryFormatter();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var ms = new MemoryStream())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            bf.Serialize(ms, obj);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return ms.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">private Object ByteArrayToObject(byte[] arrBytes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (var memStream = new MemoryStream())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var binForm = new BinaryFormatter();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            memStream.Write(arrBytes, 0, arrBytes.Length);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            memStream.Seek(0, SeekOrigin.Begin);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var obj = binForm.Deserialize(memStream);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return obj;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    catch (Exception ex)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="actor-interface"></a>Actor Interface<a class="hash-link" href="#actor-interface" title="Direct link to heading">#</a></h3><p>From this <a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-actors-notes-on-actor-type-serialization/" target="_blank" rel="noopener noreferrer">article</a>: <em>The arguments of all methods, result types of the tasks returned by each method in an actor interface, and objects stored in an actor&#x27;s State Manager must be Data Contract serializable. This also applies to the arguments of the methods defined in actor event interfaces. (Actor event interface methods always return void.)</em> </p><p>In my actor interface, I had many methods and everything was working great until I added these two methods:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Task&lt;SomeView&gt; GetView(int year, int month);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Task&lt;SomeView&gt; GetView(int year);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>If you to compile a Service Fabric solution that has an interface that looks like the above, you will be met with a very strange compilation error:</p><p><img src="http://i.imgur.com/cO972hG.png" alt="Actor Compilation Error"></p><p>What? What is that? Why? After hours, it turned out you can actually <a href="http://stackoverflow.com/questions/35820191/how-to-ignore-a-servicetype-from-servicefabric-manifest-file-on-build-deploy" target="_blank" rel="noopener noreferrer">turn off</a> this error. From the above Stack Overflow post:</p><p>By changing the project file .csproj of the project containing the actors and setting property:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;UpdateServiceFabricManifestEnabled&gt;false&lt;/UpdateServiceFabricManifestEnabled&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>So this tool can be disabled!! But still why is this happening? It turned out that the actor interfaces may not have overridden methods!! So the tool was complaining about the interface containing just that i.e. overridden methods. If the above interface is changed to the below, everything will work well:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Task&lt;SomeView&gt; GetViewByYearNMonth(int year, int month);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Task&lt;SomeView&gt; GetViewByYear(int year);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>In addition, the actor event methods may not return anything but <code>void</code>. So if you have something like this, you will get the same <code>FabActUtil.exe</code> error:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public interface IMyActorEvents : IActorEvents</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Task MeasuresRecalculated(....);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I am hoping to add to this post as I go along. Hopefully this has been helpful.
</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/service-fabric">Service Fabric</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_3-lP"><a href="/blog/2016/12/23/how-to-generate-this-site">How to generate a static site using Wyam</a></h2><div class="margin-vert--md"><time datetime="2016-12-23T00:00:00.000Z" class="blogPostDate_Ta7i">December 23, 2016  路 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>I use <a href="https://wyam.io/" target="_blank" rel="noopener noreferrer">Wyam</a> to statically generate this site. This is to document the steps I take to run <a href="https://wyam.io/" target="_blank" rel="noopener noreferrer">Wyam</a> locally, test my posts and push the site to <a href="https://www.github.com" target="_blank" rel="noopener noreferrer">GitHub</a>:</p><p>I have a directory structure that looks like this:</p><p><img src="https://mosaicapi.blob.core.windows.net/images/1788cf26-c285-4f7b-b9ad-da65f73574b6.png" alt="Wyam Dir Structure"></p><p>The <code>Input</code> directory looks like this:</p><p><img src="https://mosaicapi.blob.core.windows.net/images/5cbc7cab-bd19-4e81-af36-ce2b8cb3157c.png" alt="Wyam input Dir Structure"></p><p>I place my posts in <code>Markdown</code> in the <code>posts</code> directory.</p><p>The <code>run.cmd</code> contains the following:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@echo off</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">..\..\Wyam-Exec\Wyam-v0.15.1-beta\Wyam.exe -r Blog -t CleanBlog -pw</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This assumes that:</p><ul><li>I have <code>Wyam-Exec</code> directory two directories above my blog directory </li><li>I have different Wyam versions I can test with. For example, I am using a beta version here</li></ul><p>The <code>config.wyam</code> contains the following:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Settings.Host = &quot;khaledhikmat.github.io&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GlobalMetadata[&quot;Title&quot;] = &quot;Khaled Hikmat&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GlobalMetadata[&quot;Description&quot;] = &quot;Coding Thoughts&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GlobalMetadata[&quot;Intro&quot;] = &quot;Software old timer&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">GlobalMetadata[&quot;Image&quot;] = &quot;images/liquid.jpg&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This drives the site&#x27;s metadata.</p><p>While I am in my blog directory, I open up a command box and type:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cmd</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This starts Wyam, launches its internal web site listening on port 5080 and it also monitors the input directory for any changes. I add my blogs, edit them and test locally using the 5080 site. </p><p>Once I am satisfied, I copy the content of the <code>output</code> directory:</p><p><img src="https://mosaicapi.blob.core.windows.net/images/949ce5de-3540-460f-ae44-b82ae6bda923.png" alt="Wyam output Dir Structure"></p><p>and paste it into my site <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub pages</a> structure and replace all files. To publish to GitHub, I issue the following <code>git</code> commands:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">git add --all</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git commit -am &quot;Added/Edited new/existing posts&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git push</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>This publishes my changes to <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub pages</a>. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/wyam">Wyam</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/page/2"><div class="pagination-nav__label">Older Entries 禄</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright 漏 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/a6aa9e1f.f048fb53.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/94e919bf.0a3e419d.js"></script>
<script src="/bee94a88.4fc3e9d9.js"></script>
<script src="/c39f8217.edeb2472.js"></script>
<script src="/5aee77e7.26a47450.js"></script>
<script src="/f2741b72.6222c6ed.js"></script>
<script src="/d60bfb02.3b07197f.js"></script>
<script src="/e6152ae6.2517b391.js"></script>
<script src="/55951e93.320cea7e.js"></script>
<script src="/e054a98d.5d410ab7.js"></script>
<script src="/22c51f25.c28260cd.js"></script>
<script src="/b2b675dd.99e7d1db.js"></script>
</body>
</html>