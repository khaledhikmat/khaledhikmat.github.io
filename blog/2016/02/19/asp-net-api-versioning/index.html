<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">ASP.NET API Versioning | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="ASP.NET API Versioning | Coding Thoughts"><meta data-react-helmet="true" name="description" content="A while back, I created an ASP.NET Web API 2 to be a back-end for a mobile app. I used basic authentication to make it easier for mobile apps to consume the Web API. I now decided to provide better security so I wanted to move to a token-based authentication. The problem is that if I change the Web API to a token-based, all existing mobile apps in the field will not function as they will be refused Web API connection."><meta data-react-helmet="true" property="og:description" content="A while back, I created an ASP.NET Web API 2 to be a back-end for a mobile app. I used basic authentication to make it easier for mobile apps to consume the Web API. I now decided to provide better security so I wanted to move to a token-based authentication. The problem is that if I change the Web API to a token-based, all existing mobile apps in the field will not function as they will be refused Web API connection."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/ccc49370.7b39bdf5.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/8b1bbe25.bee37c7d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">ASP.NET API Versioning</h1><div class="margin-vert--md"><time datetime="2016-02-19T00:00:00.000Z" class="blogPostDate_Ta7i">February 19, 2016  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>A while back, I created an ASP.NET Web API 2 to be a back-end for a mobile app. I used basic authentication to make it easier for mobile apps to consume the Web API. I now decided to provide better security so I wanted to move to a token-based authentication. The problem is that if I change the Web API to a token-based, all existing mobile apps in the field will not function as they will be refused Web API connection. </p><p>The answer is to use Web API versioning! This way existing mobile users can continue to use the current version that uses basic authentication until the app is upgraded. The updated app version will switch over to use the new version which is based on token authentication. This post will discuss how I accomplished this versioning scheme.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="controller-selector"></a>Controller Selector<a class="hash-link" href="#controller-selector" title="Direct link to heading">#</a></h2><p>The first step is to configure the ASP.NET framework to use a custom controller selector. In the <code>WebApiConfig</code> <code>Register</code> method, we tell the framework to use the custom selector:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">config.Services.Replace(typeof(IHttpControllerSelector), new VersionAwareControllerSelector(config));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The selector is coded as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class VersionAwareControllerSelector : DefaultHttpControllerSelector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private const string VERSION_HEADER_NAME = &quot;some-value&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private const string VERSION_QUERY_NAME = &quot;v&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private HttpConfiguration _configuration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public VersionAwareControllerSelector(HttpConfiguration configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        : base(configuration)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        _configuration = configuration;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // This works for Web API 2 and Attributed Routing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // FROM: http://stackoverflow.com/questions/19835015/versioning-asp-net-web-api-2-with-media-types/19882371#19882371</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // BLOG: http://webstackoflove.com/asp-net-web-api-versioning-with-media-types/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public override HttpControllerDescriptor SelectController(HttpRequestMessage request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpControllerDescriptor controllerDescriptor = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Get a list of all controllers provided by the default selector</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        IDictionary&lt;string, HttpControllerDescriptor&gt; controllers = GetControllerMapping();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        IHttpRouteData routeData = request.GetRouteData();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (routeData == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            throw new HttpResponseException(HttpStatusCode.NotFound);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Pick up the API Version from the header...but we could also do query string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var apiVersion = GetVersionFromHeader(request);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Check if this route is actually an attribute route</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        IEnumerable&lt;IHttpRouteData&gt; attributeSubRoutes = routeData.GetSubRoutes();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (attributeSubRoutes == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string controllerName = GetRouteVariable&lt;string&gt;(routeData, &quot;controller&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (controllerName == null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new HttpResponseException(HttpStatusCode.NotFound);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string newControllerName = String.Concat(controllerName, apiVersion);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (controllers.TryGetValue(newControllerName, out controllerDescriptor))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return controllerDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                throw new HttpResponseException(HttpStatusCode.NotFound);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            string newControllerNameSuffix = String.Concat(&quot;V&quot;, apiVersion); ;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IEnumerable&lt;IHttpRouteData&gt; filteredSubRoutes = attributeSubRoutes.Where(attrRouteData =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                HttpControllerDescriptor currentDescriptor = GetControllerDescriptor(attrRouteData);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                bool match = currentDescriptor.ControllerName.EndsWith(newControllerNameSuffix);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (match &amp;&amp; (controllerDescriptor == null))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    controllerDescriptor = currentDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return match;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            routeData.Values[&quot;MS_SubRoutes&quot;] = filteredSubRoutes.ToArray();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return controllerDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private HttpControllerDescriptor GetControllerDescriptor(IHttpRouteData routeData)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return ((HttpActionDescriptor[])routeData.Route.DataTokens[&quot;actions&quot;]).First().ControllerDescriptor;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Get a value from the route data, if present.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private static T GetRouteVariable&lt;T&gt;(IHttpRouteData routeData, string name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        object result = null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (routeData.Values.TryGetValue(name, out result))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return (T)result;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return default(T);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private string GetVersionFromHeader(HttpRequestMessage request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (request.Headers.Contains(VERSION_HEADER_NAME))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            var header = request.Headers.GetValues(VERSION_HEADER_NAME).FirstOrDefault();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            if (header != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return header;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return &quot;1&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    private string GetVersionFromQueryString(HttpRequestMessage request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var query = HttpUtility.ParseQueryString(request.RequestUri.Query);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        var version = query[VERSION_QUERY_NAME];</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (version != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return version;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return &quot;1&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>As demonstarted above, I chose to send the version information as a header value! There are other options ...one of them is to pass it in the query string such as <code>http://example.com/api/stats?v=2</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="controller-versions"></a>Controller Versions<a class="hash-link" href="#controller-versions" title="Direct link to heading">#</a></h2><p>The above allows us to have versioned controllers with the following naming convention:</p><p><img src="http://i.imgur.com/5jxk3S5.png" alt="Controller Versions"></p><p>The framework will pick version 1 (i.e. <code>StatsV1Controller</code>) by default unless the request&#x27;s header contains a version header value. If the value is 2, then <code>StatsV2Controller</code> will be picked.</p><p>The V1 controller is defined this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[BasicAuthorize()]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class StatsV1Controller : ApiController</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/stats&quot;, Name = &quot;Stats&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public virtual IHttpActionResult GetStats()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>while the V2 controller is defined this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[TokenAuthorize()]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public class StatsV2Controller : StatsV1Controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/stats&quot;, Name = &quot;StatsV2&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public override IHttpActionResult GetStats()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return base.GetStats();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><ul><li>The V1 controller uses basic authorization (as decorated by the attribute on top of the controller class) and V2 uses token authentication as decorated. </li><li>The V2 controller inherits from the V1 controller so there is no need to re-implement the methods.</li><li>However, there is a need to supply a different route name for the V2 controller otherwise we will get a conflict. This is done by giving the V2 controller a route name that ends with V1 i.e. StatsV2. This is a little unfortunate but this is how it is. Had it not been for this, we could have simply inherited from V1 without having to repeat any method.</li><li>Since V2 inherits from V1, I noticed that both authentication filters run per request. This means that when V2 is picked, the token authorize filer will run first and then followed by the basic authorize filter. This can cause problems. So what I did is at the end of the token authorize filter, I inject a value in the request properties. In the basic authorize filter, I check if the value exists, and, it if it does, I abort the basic authorize filter since the token filter has already run.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="request-property"></a>Request Property<a class="hash-link" href="#request-property" title="Direct link to heading">#</a></h2><p>Here is one way to inject a property in the request in the token filter:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">actionContext.Request.Properties[&quot;some-key&quot;] = &quot;some-value&quot;;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Then in the basic filter, I check for this property existence. If it does exist, it means the request is authenticated and there is no need to perform basic authentication.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">string accessToken;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (!actionContext.Request.Properties.TryGetValue(&quot;sone-key&quot;, out accessToken))            </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>I hope someone finds this post helpful. Having multiple versions has provided me with a way to transition my mobile app users from basic authentication to token authentication without breaking the existing mobile apps.
</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/asp-net">ASP.NET</a></div></footer></article><div><a href="https://github.com/facebook/docusaurus/edit/master/website/blog/blog/2016-02-19-asp-net-api-versioning.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2016/04/25/open-azure-vm-port"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Open Azure VM Port</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#controller-selector" class="table-of-contents__link">Controller Selector</a></li><li><a href="#controller-versions" class="table-of-contents__link">Controller Versions</a></li><li><a href="#request-property" class="table-of-contents__link">Request Property</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/ccc49370.7b39bdf5.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/8b1bbe25.bee37c7d.js"></script>
</body>
</html>