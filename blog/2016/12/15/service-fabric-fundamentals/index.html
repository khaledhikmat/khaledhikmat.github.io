<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Coding Thoughts Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Coding Thoughts Blog Atom Feed"><title data-react-helmet="true">Service Fabric Fundamentals | Coding Thoughts</title><meta data-react-helmet="true" property="og:title" content="Service Fabric Fundamentals | Coding Thoughts"><meta data-react-helmet="true" name="description" content="The Service Fabric iOT sample app is a great sample to follow for our own Service Fabric apps. In this post, I used code snippets and concepts from the iOT sample to build a small app to demonstrate some fundamentals concepts that I feel are important."><meta data-react-helmet="true" property="og:description" content="The Service Fabric iOT sample app is a great sample to follow for our own Service Fabric apps. In this post, I used code snippets and concepts from the iOT sample to build a small app to demonstrate some fundamentals concepts that I feel are important."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.157dcc77.css">
<link rel="preload" href="/styles.4fbf0ec5.js" as="script">
<link rel="preload" href="/runtime~main.fc898453.js" as="script">
<link rel="preload" href="/main.ece73c67.js" as="script">
<link rel="preload" href="/1.4ea9cb82.js" as="script">
<link rel="preload" href="/2.dd29e16f.js" as="script">
<link rel="preload" href="/ccc49370.7b39bdf5.js" as="script">
<link rel="preload" href="/ccb03a98.23fefe2f.js" as="script">
<link rel="preload" href="/1e5353d5.8803fc73.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/chalk.jpg" alt="Site Logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Khaled Hikmat</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/khaledhikmat" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--2"><div class="sidebar_SWld thin-scrollbar"><h3 class="sidebarItemTitle_Km2m">Recent posts</h3><ul class="sidebarItemList_3UpA"><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/06/kubernetes-vs-service-fabric">Kubernetes vs. Service Fabric</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/04/netapp-docker-k8s">.NET Core, Docker and Kubernetes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2018/01/02/azure-cli-login-options">Azure CLI Notes</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/27/durable-functions">Actors in Serverless</a></li><li class="sidebarItem_2T0D"><a class="sidebarItemLink_v5H9" href="/blog/2017/12/21/point-to-site-connectivity">Point to Site Connectivity in Azure</a></li></ul></div></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3-lP">Service Fabric Fundamentals</h1><div class="margin-vert--md"><time datetime="2016-12-15T00:00:00.000Z" class="blogPostDate_Ta7i">December 15, 2016  Â· 20 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener"><img src="https://avatars1.githubusercontent.com/u/3119726?s=400&amp;u=090899e7b366dd702f9d0d5e483f20089010b25c&amp;v=4" alt="Khaled Hikmat"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/khaledhikmat" target="_blank" rel="noreferrer noopener">Khaled Hikmat</a></h4><small class="avatar__subtitle">Software Engineer</small></div></div></header><section class="markdown"><p>The <a href="https://github.com/Azure-Samples/service-fabric-dotnet-iot" target="_blank" rel="noopener noreferrer">Service Fabric iOT sample app</a> is a great sample to follow for our own Service Fabric apps. In this post, I used code snippets and concepts from the iOT sample to build a small app to demonstrate some fundamentals concepts that I feel are important.</p><p>The source code for this post is available <a href="https://github.com/khaledhikmat/service-fabric-fundamentals" target="_blank" rel="noopener noreferrer">here</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="the-app-scenario"></a>The app scenario<a class="hash-link" href="#the-app-scenario" title="Direct link to heading">#</a></h2><p>The app is called Rate Aggregator where we have an app that monitors hotel rate requests coming in from somewhere (presumably from some site) and aggregates the result by city. I also wanted the app to be multi-tenant so we can have an app instance for each rate service provider i.e. Contoso and Fabrican. </p><p>The app is quite simple and consists of two services: Web Service to act as a front-end and a rates service to actually process the rates and aggregate them:</p><p><img src="http://i.imgur.com/trNQnSS.png" alt="App Components"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="source-code"></a>Source Code<a class="hash-link" href="#source-code" title="Direct link to heading">#</a></h2><p>The solution source code consists of 4 different projects:</p><ul><li>Common Project - a class library that has the common classes that are shared across the other projects. Please note that this library must be built using the <code>x64</code> platform.</li><li>Web Service - a stateless Service Fabric service created using the Visual Studio ASP.NET Core template.</li><li>Rates Service - a stateful Service Fabric service created using the Visual Studio ASP.NET Core template.</li><li>An app project to contain the Service Fabric instances and provide application manifests.</li><li>A collection of PowerShell scripts that manage the deployment, un-deployment, update, upgrade and test. We will go through those files in this post.</li></ul><p>Please note:</p><ul><li>I created the solution using VS 2015 Service Fabric template. But actually the projects are regular projects that include Service Fabric NuGet packages. The only project that is quite specific to Service Fabric is the app project i.e. <code>RateAggregatorApp</code> ...but as demonstrated in a <a href="/blog/2016/12/02/service-fabric-basics">previous post</a>, the app manifests and packaging can be easily generated manually.</li><li>The ASP.NET Code template in Service Fabric is still in preview. I noticed some odd stuff about it:<ul><li>The template assumes that you are building stateless services! To create Stateful services using the ASP.NET template, manual intervention have to take place which I will note in this post</li><li>The useful <code>ServiceEventSource.cs</code> class is not included in the generated project. So if you want to use ETW logging, you must create this file manually (copy it from another SF project)</li><li>The template includes, in the <code>Program.cs</code> file the Service Fabric registration code and the Service class. It is useful to break up apart and create a class (using the name of the service) to describe the service i.e. <code>WebService</code> and <code>RatesService</code></li></ul></li><li>The Service Fabric <code>RateAggregatorApp</code> <code>APplicationManifest.xml</code> file has a section for <code>DefaultServices</code> which automatically deploys the default services whenever an app is deployed. I usually remove the default services from the manifest file so i can better control the named app instance and service creation process (which I will demo in this post).</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="fundamental-concepts"></a>Fundamental Concepts<a class="hash-link" href="#fundamental-concepts" title="Direct link to heading">#</a></h2><p>The <a href="https://github.com/Azure-Samples/service-fabric-dotnet-iot" target="_blank" rel="noopener noreferrer">iOT</a> sample includes really nice code utilities that can be used to build <code>Uri</code>s for services especially when the service exposes HTTP endpoints. The most important concepts that I would like to convey are:</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="http-endpoints"></a>HTTP Endpoints<a class="hash-link" href="#http-endpoints" title="Direct link to heading">#</a></h3><p>If you would like to expose HTTP Endpoints for your service, Microsoft strongly recommends that you build the URL as follows:</p><p><img src="http://i.imgur.com/qQdvX9h.png" alt="HTTP Endpoint URL"></p><p>Examples:</p><ol><li><code>Http://localhost:8084/ContosoRateAggregatorApp/7217642a-2ac8-4b29-b52d-3e92303ce1b2/131262989332452689/f74f07f7-d92f-47b9-8d6b-c86966c78d09</code></li><li><code>Http://localhost:8084/FabricanRateAggregatorApp/13049e47-9727-4e02-9086-8fd6e2457313/131262989924122573/3b3455d8-487e-4ec4-9bd8-64ba8e658662</code></li></ol><p>For stateful services, this makes total sense! The combination of <code>partitionId</code> and <code>instanceId</code> are great for diagnostics and the <code>guid</code> makes every endpoint unique which is really useful because services are sometimes moved around. However, for Stateless services, I think we can easily omit the <code>partitionId</code>, the <code>instanceId</code> and the <code>guid</code> since stateless service endpoints are usually load balanced as they accept traffic from the Internet. Examples of stateless services endpoints:</p><ol><li><code>Http://localhost:8082/FabricanRateAggregatorApp</code></li><li><code>Http://localhost:8082/ContosoRateAggregatorApp</code></li></ol><p>If you are planning to expose multiple stateless web services in each app instances, then perhaps adding the service name to the end of the URL would make sense.Examples:</p><ol><li><code>Http://localhost:8082/FabricanRateAggregatorApp/WebService</code></li><li><code>Http://localhost:8082/ContosoRateAggregatorApp/WebService</code></li></ol><p>The demo app source code common project includes a <code>WebHostCommunicationListener</code> class (which is borrowed from the iOT sample) shows a really good implementation of how to manage this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">string ip = this.serviceContext.NodeContext.IPAddressOrFQDN;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EndpointResourceDescription serviceEndpoint = this.serviceContext.CodePackageActivationContext.GetEndpoint(this.endpointName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EndpointProtocol protocol = serviceEndpoint.Protocol;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int port = serviceEndpoint.Port;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string host = &quot;+&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string listenUrl;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">string path = this.appPath != null ? this.appPath.TrimEnd(&#x27;/&#x27;) + &quot;/&quot; : &quot;&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (this.serviceContext is StatefulServiceContext)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    StatefulServiceContext statefulContext = this.serviceContext as StatefulServiceContext;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    listenUrl = $&quot;{serviceEndpoint.Protocol}://{host}:{serviceEndpoint.Port}/{path}{statefulContext.PartitionId}/{statefulContext.ReplicaId}/{Guid.NewGuid()}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    listenUrl = $&quot;{serviceEndpoint.Protocol}://{host}:{serviceEndpoint.Port}/{path}&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">this.webHost = this.build(listenUrl);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">this.webHost.Start();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">return Task.FromResult(listenUrl.Replace(&quot;://+&quot;, &quot;://&quot; + ip));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="http-web-apis"></a>HTTP Web APIs<a class="hash-link" href="#http-web-apis" title="Direct link to heading">#</a></h3><p>Using ASP.NET Core to implement the Stateless and Stateful services has the distinct advantage of allowing the services expose a Web API layer that can be used by clients to call on the services. The Web API layer has regular controllers with normal Web API decoration to allow the services be called from regular HTTP clients:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    [Route(&quot;api/[controller]&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public class RatesController : Controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly IReliableStateManager stateManager;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly StatefulServiceContext context;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        private readonly CancellationTokenSource serviceCancellationSource;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public RatesController(IReliableStateManager stateManager, StatefulServiceContext context, CancellationTokenSource serviceCancellationSource)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.stateManager = stateManager;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.context = context;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            this.serviceCancellationSource = serviceCancellationSource;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Route(&quot;queue/length&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; GetQueueLengthAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            ....</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Please note that the service has the <code>IReliableStateManager</code>, the <code>StatefulServiceContext</code> and the <code>CancellationSource</code> injected. This allows the Web API controller to use the service reliable collections and anything else related to service context. For example, this is the implementation of the queue length Web API method:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        [Route(&quot;queue/length&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        public async Task&lt;IActionResult&gt; GetQueueLengthAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            IReliableQueue&lt;RateRequest&gt; queue = await this.stateManager.GetOrAddAsync&lt;IReliableQueue&lt;RateRequest&gt;&gt;(RatesService.RateQueueName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using (ITransaction tx = this.stateManager.CreateTransaction())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                long count = await queue.GetCountAsync(tx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return this.Ok(count);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Note how the API controller uses the injected <code>StateManager</code> to gain access to the reliable queue and reports on its length.</p><p>Since the service interface is implemented as regular Web API controllers (or controllers), they can also be exposed as <code>Swagger</code> and allow other an API management layer to front-end these services.  </p><p>To make this possible, the service must override the <code>CreateServiceInstanceListeners</code> in case of stateless services and <code>CreateServiceReplicaListeners</code> in case of stateful services. Here is an example of the Stateful service:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">protected override IEnumerable&lt;ServiceReplicaListener&gt; CreateServiceReplicaListeners()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return new ServiceReplicaListener[1]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        new ServiceReplicaListener(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            context =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                string tenantName = new Uri(context.CodePackageActivationContext.ApplicationName).Segments.Last();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                return new WebHostCommunicationListener(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    context,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    tenantName,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;ServiceEndpoint&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    uri =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        ServiceEventSource.Current.Message($&quot;Listening on {uri}&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return new WebHostBuilder().UseWebListener()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .ConfigureServices(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                services =&gt; services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                    .AddSingleton&lt;StatefulServiceContext&gt;(this.Context)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                    .AddSingleton&lt;IReliableStateManager&gt;(this.StateManager)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                                    .AddSingleton&lt;CancellationTokenSource&gt;(this._webApiCancellationSource))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .UseContentRoot(Directory.GetCurrentDirectory())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .UseStartup&lt;Startup&gt;()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .UseUrls(uri)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                            .Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Please note the use of the <code>WebHostCommunicationListener</code> and how we inject the service context, state manager and the cancellation token.</p><p>In our demo app, both statelss and stateful services implement their interface as Web API.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="http-vs-rcp-endpoints"></a>HTTP vs. RCP Endpoints<a class="hash-link" href="#http-vs-rcp-endpoints" title="Direct link to heading">#</a></h3><p>Instead of HTTP Web API, Services (especially stateful) can expose an interface using a built-in RCP communicaton listener. In this case, the service implements an interface and make it easy for clients to call upon the service using the interface. For example, a stateful service might have an interface that looks like this:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    public interface ILookupService : IService</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task EnqueueEvent(SalesEvent sEvent);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task&lt;string&gt; GetNodeName();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Task&lt;int&gt; GetEventsCounter(CancellationToken ct);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The service will then be implemented this way:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    internal sealed class LookupService : StatefulService, ILookupService</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The service will override the CreateServiceReplicaListeners as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protected override IEnumerable&lt;ServiceReplicaListener&gt; CreateServiceReplicaListeners()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return new[]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                new ServiceReplicaListener(context =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    this.CreateServiceRemotingListener(context),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    &quot;rpcPrimaryEndpoint&quot;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    false)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Although this looks nice and complies with Object Oriented programming, I think it should only be used with internal stateful services (those that do not expose an outside interface). Stateless services that are used by external clients are better off using an HTTP Web API interface which makes them easily consumable by many clients in different languages. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="reliable-collections"></a>Reliable Collections<a class="hash-link" href="#reliable-collections" title="Direct link to heading">#</a></h3><p>Since we have the state manager injected in the stateful service Web API controllers, it makes all the service reliable collections available to the Web API controllers. In our demo, the <code>RatesService</code> Web API controller i.e. <code>RatesController</code> uses the reliable queue to get the queue length and enqueue rate requests to the service. The service processes the incoming <code>RateRequest</code> in its <code>RunAsyc</code> method and aggregates the results in a reliable dictionary indexed by city/country:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">protected override async Task RunAsync(CancellationToken cancellationToken)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cancellationToken.Register(() =&gt; this._webApiCancellationSource.Cancel());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IReliableDictionary&lt;string, RateAggregation&gt; citiesDictionary = await this.StateManager.GetOrAddAsync&lt;IReliableDictionary&lt;string, RateAggregation&gt;&gt;(RateCitiesDictionaryName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    IReliableQueue&lt;RateRequest&gt; queue = await this.StateManager.GetOrAddAsync&lt;IReliableQueue&lt;RateRequest&gt;&gt;(RateQueueName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while (true)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        cancellationToken.ThrowIfCancellationRequested();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using (var tx = this.StateManager.CreateTransaction())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                var result = await queue.TryDequeueAsync(tx);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (result.HasValue)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    RateRequest request = result.Value;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // TODO: Process the request</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // TODO: Go against the reservation provider to pick up the rate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // TODO: How do I determine the reservation provider per tenant?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    int nights = (request.CheckOutDate - request.CheckInDate).Days;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    int netAmount = _random.Next(500) * nights;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    var newAggregation = new RateAggregation();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    newAggregation.Transactions = 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    newAggregation.Nights = nights;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    newAggregation.Amount = (double) netAmount;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    await citiesDictionary.AddOrUpdateAsync(tx, $&quot;{request.City}/{request.Country}&quot;, newAggregation, (key, currentValue) =&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        currentValue.Transactions += newAggregation.Transactions;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        currentValue.Nights += newAggregation.Nights;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        currentValue.Amount += newAggregation.Amount;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                        return currentValue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    // This commits the add to dictionary and the dequeue operation.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    await tx.CommitAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        catch (Exception e)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        await Task.Delay(TimeSpan.FromMilliseconds(500), cancellationToken);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The reliable dictionary is then used in the service contrloller to return the aggregated result in an API call. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="partitions-replicas-and-instances"></a>Partitions, Replicas and Instances<a class="hash-link" href="#partitions-replicas-and-instances" title="Direct link to heading">#</a></h3><p>In our demo app, we use partitions in the Stateful service i.e. <code>RatesService</code> to partition our data in 4 different buckets: </p><ol><li>Rate Requests for the United States</li><li>Rate Requests for Canada</li><li>Rate Requests for Australia</li><li>Rate Requests for other countries</li></ol><p>Hence our partition key range is 0 (Low Key) to 3 (High Key). We use a very simple method to select the appropriate partition based on the request&#x27;s country code:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">private long GetPartitionKey(RateRequest request)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (request.Country == &quot;USA&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else if (request.Country == &quot;CAN&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else if (request.Country == &quot;AUS&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else // all others</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        return 3;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>To allow for high availability, Service Fabric uses replicas for stateful services and instances for stateless services. In Service Fabric literature, the term replicas and instances are often exchanged. </p><p>In order to guarantee high availability of stateful service state, the state for each partition is usually replicated. The number of replicas is decided at the time of deploying the service (as we will see soon in the PowerShell script). This means that, if a stateful service has 4 partitions and the target replica count is 3, for example, then there are 12 instances of that service in Service Fabric.    </p><p>In order to guarantee high availability of stateless services, Service Fabric allows the instantiation of multiple instances. Usually the number of instances matches the number of nodes in the Service Fabric cluster which allows Service Fabric to distribute an instance on each node. The load balancer then distribute the load across all nodes. </p><p>Please note, however, that, unlike stateless service instances, a stateful service partitions cannot be changed at run-time once the service is deployed. The number of partitions must be decided initially before the service is deployed to the cluster. Of course, if the service state can be discarded, then of course changes to the partition are allowed. Stateless services number of instances can be updated at any time (up or down) at any time. In fact, this is one of the great features of Service Fabric.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="result-aggregation"></a>Result Aggregation<a class="hash-link" href="#result-aggregation" title="Direct link to heading">#</a></h3><p>Since the state is partitioned, does this mean that we have the reliable collections (i.e. queues and dictionaries) scattered among the different partitions? The answer is yes! For example, in order to get the queue length of a stateful service, the client has to query all partitions and ask each service instance about the queue length and add them together to determine the overall queue length for the stateful service:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Route(&quot;queue/length&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;IActionResult&gt; GetQueueLengthAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServiceUriBuilder uriBuilder = new ServiceUriBuilder(RatesServiceName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Uri serviceUri = uriBuilder.Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // service may be partitioned.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // this will aggregate the queue lengths from each partition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServicePartitionList partitions = await this.fabricClient.QueryManager.GetPartitionListAsync(serviceUri);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpClient httpClient = new HttpClient(new HttpServiceClientHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    long count = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach (Partition partition in partitions)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Uri getUrl = new HttpServiceUriBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServiceName(serviceUri)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetPartitionKey(((Int64RangePartitionInformation)partition.PartitionInformation).LowKey)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServicePathAndQuery($&quot;/api/rates/queue/length&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpResponseMessage response = await httpClient.GetAsync(getUrl, this.cancellationSource.Token);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (response.StatusCode != System.Net.HttpStatusCode.OK)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.StatusCode((int)response.StatusCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        string result = await response.Content.ReadAsStringAsync();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        count += Int64.Parse(result);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return this.Ok(count);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><code>FabricClient</code> is the .NET client used to provide all sorts of management capabilities. It is injected in the Web Service controller to allow them to communicate with each partitition replica and get the needed results as shown above. Then the Web Service adds the count of each partition and return the total lenth of all partitions queues. </p><p>Similarly, the Web Service uses the <code>FabricClient</code> to communicate with the each partition replica to get and aggregate the result of each country cities:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-csharp codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[HttpGet]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[Route(&quot;cities&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">public async Task&lt;IActionResult&gt; GetCitiesAsync()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServiceUriBuilder uriBuilder = new ServiceUriBuilder(RatesServiceName);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Uri serviceUri = uriBuilder.Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // service may be partitioned.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // this will aggregate cities from all partitions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ServicePartitionList partitions = await this.fabricClient.QueryManager.GetPartitionListAsync(serviceUri);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    HttpClient httpClient = new HttpClient(new HttpServiceClientHandler());</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    List&lt;CityStats&gt; cities = new List&lt;CityStats&gt;();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    foreach (Partition partition in partitions)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Uri getUrl = new HttpServiceUriBuilder()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServiceName(serviceUri)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetPartitionKey(((Int64RangePartitionInformation)partition.PartitionInformation).LowKey)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .SetServicePathAndQuery($&quot;/api/rates/cities&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            .Build();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HttpResponseMessage response = await httpClient.GetAsync(getUrl, this.cancellationSource.Token);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        if (response.StatusCode != System.Net.HttpStatusCode.OK)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            return this.StatusCode((int)response.StatusCode);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        JsonSerializer serializer = new JsonSerializer();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        using (StreamReader streamReader = new StreamReader(await response.Content.ReadAsStreamAsync()))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            using (JsonTextReader jsonReader = new JsonTextReader(streamReader))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                List&lt;CityStats&gt; result = serializer.Deserialize&lt;List&lt;CityStats&gt;&gt;(jsonReader);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                if (result != null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                    cities.AddRange(result);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    return this.Ok(cities);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="multi-tenancy"></a>Multi-Tenancy<a class="hash-link" href="#multi-tenancy" title="Direct link to heading">#</a></h3><p>One of the great features of Service Fabric is its ability to allow the creation of multi-tenant scanarios. In our demo case, we may launch an app for Contoso rates and another one for Fabrican rates. We want these two apps to be of the same type but they should be completely isolated of each other. So we create two named app instances: <code>ConosoRateAggretor</code> and <code>FabricanRateAggregator</code>. This means that we have different set of services for each app operated independely and perhaps scaled, updated and upgraded independently.</p><p><img src="http://i.imgur.com/e6YmFNy.png" alt="Named App Instances"> </p><p>This is really useful in many scenarios and allows for many great advantages. In the next section, we will see how easy it is to actually deploy, un-deploy, update and upgrade these named instances.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="configuration"></a>Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">#</a></h3><p>Given that we have multiple named app instances, how do we pass different parameters for each named instance? In the <code>RatesService</code>, we would like to have the name of the provider (and probably other configuration items) so we can communicate with the provider to pull rates. In our demo app, we are not actually communicating with the provider.</p><p>To do this, we define parameters for the <code>RatesService</code> in the Service Settings file as follows:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;Settings xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://schemas.microsoft.com/2011/01/fabric&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;!-- Add your custom configuration sections and parameters here --&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;Section Name=&quot;ParametersSection&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Parameter Name=&quot;ProviderName&quot; Value=&quot;&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/Section&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/Settings&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The section name can be anything. In our case, it is <code>ParametersSection</code>. To be able to override this value for a specific application instance, we create a <code>ConfigOverride</code> when we import the service manifest in the application manifest:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ServiceManifestImport&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ServiceManifestRef ServiceManifestName=&quot;RatesServicePkg&quot; ServiceManifestVersion=&quot;1.0.0&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ConfigOverrides&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;ConfigOverride Name=&quot;Config&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Settings&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &lt;Section Name=&quot;ParametersSection&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;Parameter Name=&quot;ProviderName&quot; Value=&quot;[RatesService_ProviderName]&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &lt;/Section&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;/Settings&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/ConfigOverride&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ConfigOverrides&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ServiceManifestImport&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p><em>The convention is to name the value as <code>ServiceName_ParameterName</code></em></p><p>Finally, we must adjust the application manifest to include the required parameter:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;ApplicationManifest xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; ApplicationTypeName=&quot;RateAggregatorAppType&quot; ApplicationTypeVersion=&quot;1.0.0&quot; xmlns=&quot;http://schemas.microsoft.com/2011/01/fabric&quot;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;Parameters&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Parameter Name=&quot;RatesService_ProviderName&quot; DefaultValue=&quot;&quot; /&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  &lt;/Parameters&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&lt;/ApplicationManifest&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>Finally, at the deployment time (as you will see in more detail in the deployment script), we will specify a PowerShell <code>Hashtable</code> to override these parameters per named instance:</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Contoso&quot;}  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Fabrican&quot;}  </span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><p>The <code>RatesService</code> code will then make sure of this parameter to contact the instance-bound provider.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="powershell-management-scripts"></a>PowerShell Management Scripts<a class="hash-link" href="#powershell-management-scripts" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="deployment"></a>Deployment<a class="hash-link" href="#deployment" title="Direct link to heading">#</a></h3><p><strong>This PowerShell script assumes that you used Visual Studio to generate the Service Fabric app package info (right-click the Service Fabric App and select <code>Package</code>) or you built the app package manually as demonstrated in a previous <a href="/blog/2016/12/02/service-fabric-basics">post</a>. The created package directory is expected to have the following format <code>v1.0.0</code> where 1.0.0 is the version number</strong></p><p>This PowerShell script copies the package to the cluster, registers the app type and creates two name app instances (i.e. Contoso and Fabrican). In each app instance, create two services: Web Service as a front-end and Rates service as a back-end. </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$imageStoreConnectionString = &quot;file:C:\SfDevCluster\Data\ImageStoreShare&quot;   # Use this with OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">If ($clusterUrl -ne &quot;localhost&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    $imageStoreConnectionString = &quot;fabric:ImageStore&quot;                       # Use this when not using OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Used only for the inmage store....it can be any name!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appPkgName = &quot;RateAggregatorAppTypePkg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the app and service types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appTypeName = &quot;RateAggregatorAppType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceTypeName = &quot;WebServiceType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ratesServiceTypeName = &quot;RatesServiceType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$version = &quot;1.0.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;RateAggregatorApp\pkg\v$version&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the first aplication name (i.e. Contoso)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/ContosoRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ratesServiceName = $appName + &quot;/RatesService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Contoso&quot;}  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $webServiceTypeName -ServiceName $webServiceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># For stateful services, it is important to indicate in the service manifest that the service is stateful and that it has a persisted state:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># &lt;StatefulServiceType ServiceTypeName=&quot;RatesServiceType&quot; HasPersistedState=&quot;true&quot;/&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Actually all of these switches are important on the PowerShell command:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># -PartitionSchemeUniformInt64 $true -PartitionCount 4 -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -LowKey 0 -HighKey 3 -HasPersistedState</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $ratesServiceTypeName -ServiceName $ratesServiceName -PartitionSchemeUniformInt64 $true -PartitionCount 4 -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -LowKey 0 -HighKey 3 -HasPersistedState</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the second aplication name (i.e. Fabrican)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/FabricanRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ratesServiceName = $appName + &quot;/RatesService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named application from the registered app type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricApplication -ApplicationTypeName $appTypeName -ApplicationTypeVersion $version -ApplicationName $appName -ApplicationParameter @{&quot;RatesService_ProviderName&quot; = &quot;Fabrican&quot;}  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $webServiceTypeName -ServiceName $webServiceName -Stateless -PartitionSchemeSingleton -InstanceCount 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Create a named service within the named app from the service&#x27;s type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">New-ServiceFabricService -ApplicationName $appName -ServiceTypeName $ratesServiceTypeName -ServiceName $ratesServiceName -PartitionSchemeUniformInt64 $true -PartitionCount 4 -MinReplicaSetSize 2 -TargetReplicaSetSize 3 -LowKey 0 -HighKey 3 -HasPersistedState</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="obliterate"></a>Obliterate<a class="hash-link" href="#obliterate" title="Direct link to heading">#</a></h3><p>This PowerShell script removes all application name instances and their services from the selected cluster. It does this based on the application type.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the app and service types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$applicationTypes = &quot;RateAggregatorAppType&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Remove all application names instances and their services</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-ServiceFabricApplication | Where-Object { $applicationTypes -contains $_.ApplicationTypeName } | Remove-ServiceFabricApplication -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Get-ServiceFabricApplicationType | Where-Object { $applicationTypes -contains $_.ApplicationTypeName } | Unregister-ServiceFabricApplicationType -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="update"></a>Update<a class="hash-link" href="#update" title="Direct link to heading">#</a></h3><p>This PowerShell script updates the web service in each app named instance to have 5 instances. Please note that this works if the number of instances does  not exceed the number of nodes in the cluster.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the first aplication name (i.e. Contoso)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/ContosoRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Dynamically change the named service&#x27;s number of instances (the cluster must have at least 5 nodes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Update-ServiceFabricService -ServiceName $webServiceName -Stateless -InstanceCount 5 -Force</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Deploy the first aplication name (i.e. Fabrican)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/FabricanRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$webServiceName = $appName + &quot;/WebService&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Dynamically change the named service&#x27;s number of instances (the cluster must have at least 5 nodes) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Update-ServiceFabricService -ServiceName $webServiceName -Stateless -InstanceCount 5 -Force</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="upgrade"></a>Upgrade<a class="hash-link" href="#upgrade" title="Direct link to heading">#</a></h3><p>This PowerShell script upgrades the application named instances to a higher version i.e. 1.1.0. As noted earlier, this assumes that you have a new folder named v1.1.0 which contains the upgraded application package. The script uses <code>monitored</code> upgrade modes and performs the upgrade using upgrade domains. </p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$clusterUrl = &quot;localhost&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$imageStoreConnectionString = &quot;file:C:\SfDevCluster\Data\ImageStoreShare&quot;   # Use this with OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">If ($clusterUrl -ne &quot;localhost&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    $imageStoreConnectionString = &quot;fabric:ImageStore&quot;                       # Use this when not using OneBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Used only for the inmage store....it can be any name!!!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appPkgName = &quot;RateAggregatorAppTypePkg&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Define the new version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$version = &quot;1.1.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Connect PowerShell session to a cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Connect-ServiceFabricCluster -ConnectionEndpoint ${clusterUrl}:19000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Copy the application package to the cluster</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Copy-ServiceFabricApplicationPackage -ApplicationPackagePath &quot;RateAggregatorApp\pkg\v$version&quot; -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Register the application package&#x27;s application type/version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Register-ServiceFabricApplicationType -ApplicationPathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># After registering the package&#x27;s app type/version, you can remove the package</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Remove-ServiceFabricApplicationPackage -ImageStoreConnectionString $imageStoreConnectionString -ApplicationPackagePathInImageStore $appPkgName</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the first aplication name (i.e. Contoso)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/ContosoRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the application to the new version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Start-ServiceFabricApplicationUpgrade -ApplicationName $appName -ApplicationTypeVersion $version -Monitored -UpgradeReplicaSetCheckTimeoutSec 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the second aplication name (i.e. Fabrican)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">$appName = &quot;fabric:/FabricanRateAggregatorApp&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># Upgrade the application to the new version</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Start-ServiceFabricApplicationUpgrade -ApplicationName $appName -ApplicationTypeVersion $version -Monitored -UpgradeReplicaSetCheckTimeoutSec 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="test"></a>Test<a class="hash-link" href="#test" title="Direct link to heading">#</a></h3><p>This PowerShell scripts defines functions to exercise the Service Fabric Web service APIs for each named application instance.</p><div class="mdxCodeBlock_1zKU"><div class="codeBlockContent_actS"><div tabindex="0" class="prism-code language-undefined codeBlock_tuNs thin-scrollbar"><div class="codeBlockLines_3uvA" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function Generate-RateRequests($appName = &#x27;Contoso&#x27;, $iterations = 20)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Generating $iterations random rate requests against $appName ....&quot; -ForegroundColor Green</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $url = &quot;Http://localhost:8082/$appName&quot; + &quot;RateAggregatorApp/api/requests&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        foreach($i in 1..$iterations)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $checkInDate = get-date -Year (get-random -minimum 2012 -maximum 2016) -Month (get-random -minimum 1 -maximum 12) -Day (get-random -minimum 1 -maximum 28)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $nights = get-random -minimum 1 -maximum 30</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $checkOutDate = $checkInDate.AddDays($nights)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $hotelId = get-random -input &quot;1&quot;, &quot;2&quot;, &quot;3&quot; -count 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $body = @{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                CheckInDate = get-date $checkInDate -Format &quot;yyy-MM-ddTHH:mm:ss&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                CheckOutDate = get-date $checkOutDate -Format &quot;yyy-MM-ddTHH:mm:ss&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                HotelId = $hotelId;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                HotelName = &quot;Hotel$hotelId&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                City = &quot;City$hotelId&quot;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                Country = get-random -input &quot;USA&quot;, &quot;USA&quot;, &quot;USA&quot;, &quot;CAN&quot;, &quot;CAN&quot;, &quot;CAN&quot;, &quot;AUS&quot;, &quot;AUS&quot;, &quot;AUS&quot;, &quot;FRA&quot;, &quot;GER&quot;, &quot;UAE&quot; -count 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            Write-Host &quot;This is the JSON we are generating for iteration # $i....&quot; -ForegroundColor yellow</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $json = ConvertTo-Json $body -Depth 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            $result = Invoke-RestMethod -Uri $url -Headers @{&quot;Content-Type&quot;=&quot;application/json&quot; } -Body $json -Method POST -TimeoutSec 600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }        </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } Catch {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure message: $_.Exception.Message&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure stack trace: $_.Exception.StackTrace&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure inner exception: $_.Exception.InnerException&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function View-QueueLength($appName = &#x27;Contoso&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;View Queue Length for $appName....&quot; -ForegroundColor Green</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $url = &quot;Http://localhost:8082/$appName&quot; + &quot;RateAggregatorApp/api/stats/queue/length&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $result = Invoke-RestMethod -Uri $url -Headers @{&quot;Content-Type&quot;=&quot;application/json&quot; } -Method GET -TimeoutSec 600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json = ConvertTo-Json $result -Depth 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } Catch {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure message: $_.Exception.Message&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure stack trace: $_.Exception.StackTrace&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure inner exception: $_.Exception.InnerException&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Function View-Cities($appName = &#x27;Contoso&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Try {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;View cities for $appName....&quot; -ForegroundColor Green</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $url = &quot;Http://localhost:8082/$appName&quot; + &quot;RateAggregatorApp/api/stats/cities&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $result = Invoke-RestMethod -Uri $url -Headers @{&quot;Content-Type&quot;=&quot;application/json&quot; } -Method GET -TimeoutSec 600</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json = ConvertTo-Json $result -Depth 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        $json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    } Catch {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure message: $_.Exception.Message&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure stack trace: $_.Exception.StackTrace&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Write-Host &quot;Failure inner exception: $_.Exception.InnerException&quot; -ForegroundColor red</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Generate-RateRequests -appName Contoso -iterations 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Generate-RateRequests -appName Fabrican -iterations 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-QueueLength -appName Contoso</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-QueueLength -appName Fabrican</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-Cities -appName Contoso</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">View-Cities -appName Fabrican</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_2GIj">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="what-is-next"></a>What is next?<a class="hash-link" href="#what-is-next" title="Direct link to heading">#</a></h2><p>I think Service Fabric has a lot of great and useful features that make it is a great candidate for a lot of scenarios. I will post more articles about Service Fabric as I expand my knowledge in this really cool technology. </p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/service-fabric">Service Fabric</a></div></footer></article><div><a href="https://github.com/facebook/docusaurus/edit/master/website/blog/blog/2016-12-15-service-fabric-fundamentals.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2016/12/23/how-to-generate-this-site"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« How to generate a static site using Wyam</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2016/12/02/service-fabric-basics"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Service Fabric Basics Â»</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-app-scenario" class="table-of-contents__link">The app scenario</a></li><li><a href="#source-code" class="table-of-contents__link">Source Code</a></li><li><a href="#fundamental-concepts" class="table-of-contents__link">Fundamental Concepts</a><ul><li><a href="#http-endpoints" class="table-of-contents__link">HTTP Endpoints</a></li><li><a href="#http-web-apis" class="table-of-contents__link">HTTP Web APIs</a></li><li><a href="#http-vs-rcp-endpoints" class="table-of-contents__link">HTTP vs. RCP Endpoints</a></li><li><a href="#reliable-collections" class="table-of-contents__link">Reliable Collections</a></li><li><a href="#partitions-replicas-and-instances" class="table-of-contents__link">Partitions, Replicas and Instances</a></li><li><a href="#result-aggregation" class="table-of-contents__link">Result Aggregation</a></li><li><a href="#multi-tenancy" class="table-of-contents__link">Multi-Tenancy</a></li><li><a href="#configuration" class="table-of-contents__link">Configuration</a></li></ul></li><li><a href="#powershell-management-scripts" class="table-of-contents__link">PowerShell Management Scripts</a><ul><li><a href="#deployment" class="table-of-contents__link">Deployment</a></li><li><a href="#obliterate" class="table-of-contents__link">Obliterate</a></li><li><a href="#update" class="table-of-contents__link">Update</a></li><li><a href="#upgrade" class="table-of-contents__link">Upgrade</a></li><li><a href="#test" class="table-of-contents__link">Test</a></li></ul></li><li><a href="#what-is-next" class="table-of-contents__link">What is next?</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020 Khaled Hikmat site, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4fbf0ec5.js"></script>
<script src="/runtime~main.fc898453.js"></script>
<script src="/main.ece73c67.js"></script>
<script src="/1.4ea9cb82.js"></script>
<script src="/2.dd29e16f.js"></script>
<script src="/ccc49370.7b39bdf5.js"></script>
<script src="/ccb03a98.23fefe2f.js"></script>
<script src="/1e5353d5.8803fc73.js"></script>
</body>
</html>